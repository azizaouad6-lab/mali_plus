<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Ù…Ø§Ù„ÙŠ+ | ØªØ³ÙŠÙŠØ± Ù…Ø§Ù„ÙŠ Ø°ÙƒÙŠ</title>
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#00b894">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Ù…Ø§Ù„ÙŠ+">
<link rel="apple-touch-icon" href="./icon.png">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
:root{
  --green:#00b894;--green-d:#00896e;--red:#e17055;--red-d:#c0392b;
  --gold:#fdcb6e;--gold-d:#e0a800;--blue:#4a90d9;--purple:#8b5cf6;
  --bg:#0a0e1a;--bg2:#111827;--bg3:#1a2235;--bg4:#243050;
  --text:#e8eaf0;--text2:#8892a4;--border:#2a3555;
  --radius:14px;--shadow:0 4px 24px rgba(0,0,0,.4);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;direction:rtl;overflow-x:hidden}

/* â”€â”€ AUTH â”€â”€ */
.auth-page{min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at 30% 50%,rgba(0,184,148,.1) 0%,transparent 60%),
             radial-gradient(ellipse at 70% 20%,rgba(74,144,217,.08) 0%,transparent 50%),var(--bg)}
.auth-box{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:40px;width:100%;max-width:420px;box-shadow:var(--shadow)}
.auth-logo{text-align:center;font-size:32px;font-weight:900;color:var(--green);margin-bottom:6px}
.auth-logo span{color:var(--gold)}
.auth-sub{text-align:center;color:var(--text2);font-size:13px;margin-bottom:28px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:12px;font-weight:700;color:var(--text2);margin-bottom:6px}
.form-group input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:14px;padding:12px 14px;outline:none;transition:.2s}
.form-group input:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(0,184,148,.1)}
.btn{width:100%;padding:13px;border-radius:10px;border:none;font-family:inherit;font-size:15px;font-weight:700;cursor:pointer;transition:.2s}
.btn-green{background:var(--green);color:#fff}
.btn-green:hover{background:var(--green-d);transform:translateY(-1px)}
.btn-green:active{transform:translateY(0)}
.auth-switch{text-align:center;margin-top:16px;font-size:13px;color:var(--text2)}
.auth-switch a{color:var(--green);text-decoration:none;font-weight:700}
.err-msg{background:rgba(225,112,85,.15);border:1px solid var(--red);color:var(--red);padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:14px;display:none}

/* â”€â”€ HEADER â”€â”€ */
header{background:var(--bg2);border-bottom:2px solid var(--border);padding:0 16px;display:flex;align-items:center;justify-content:space-between;height:58px;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,.5)}
.logo{font-size:20px;font-weight:900;color:var(--green)}
.logo span{color:var(--gold)}
.header-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.month-sel{background:var(--bg4);border:1px solid var(--border);border-radius:8px;padding:5px 10px;display:flex;align-items:center;gap:4px}
.month-sel select{background:none;border:none;color:var(--text);font-family:inherit;font-size:13px;cursor:pointer;outline:none}
.user-badge{background:var(--bg4);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:12px;color:var(--green);font-weight:700}
.btn-sm{padding:6px 12px;border-radius:8px;border:none;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:4px;white-space:nowrap}
.btn-outline-sm{background:transparent;border:1px solid var(--border);color:var(--text2)}
.btn-outline-sm:hover{border-color:var(--green);color:var(--green)}
.btn-red-sm{background:var(--red);color:#fff}

/* â”€â”€ NAV â”€â”€ */
.nav-tabs{background:var(--bg2);border-bottom:1px solid var(--border);display:flex;padding:0 10px;gap:0;overflow-x:auto;scrollbar-width:none}
.nav-tabs::-webkit-scrollbar{display:none}
.nav-tab{padding:12px 14px;cursor:pointer;font-size:12px;font-weight:700;color:var(--text2);border-bottom:3px solid transparent;transition:.2s;white-space:nowrap;display:flex;align-items:center;gap:4px}
.nav-tab:hover{color:var(--text)}
.nav-tab.active{color:var(--green);border-bottom-color:var(--green)}

/* â”€â”€ LAYOUT â”€â”€ */
main{padding:16px;max-width:1200px;margin:0 auto}
.section{display:none;animation:fadeUp .3s ease}
.section.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.sec-title{font-size:17px;font-weight:900;margin-bottom:16px;display:flex;align-items:center;gap:8px}

/* â”€â”€ CARDS â”€â”€ */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:18px}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;position:relative;overflow:hidden;transition:.2s}
.card:hover{transform:translateY(-2px)}
.card::before{content:'';position:absolute;top:0;right:0;width:4px;height:100%}
.card.green::before{background:var(--green)}.card.red::before{background:var(--red)}
.card.gold::before{background:var(--gold)}.card.blue::before{background:var(--blue)}
.card.purple::before{background:var(--purple)}
.card-label{font-size:10px;color:var(--text2);margin-bottom:5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.card-value{font-size:20px;font-weight:900;transition:.3s}
.card-value.green{color:var(--green)}.card-value.red{color:var(--red)}
.card-value.gold{color:var(--gold)}.card-value.blue{color:var(--blue)}.card-value.purple{color:var(--purple)}
.card-sub{font-size:10px;color:var(--text2);margin-top:3px}
.card-trend{font-size:11px;font-weight:700;margin-top:4px}
.card-trend.up{color:var(--green)}.card-trend.down{color:var(--red)}

/* â”€â”€ PANELS â”€â”€ */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px}
@media(max-width:700px){.grid-2{grid-template-columns:1fr}}
.panel{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:16px}
.panel-header{padding:13px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
.panel-body{padding:16px}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:12px}
.inp{background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:14px;padding:10px 12px;outline:none;transition:.2s;width:100%}
.inp:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(0,184,148,.1)}
.lbl{display:block;font-size:10px;font-weight:700;color:var(--text2);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
.action-btn{padding:9px 18px;border-radius:9px;border:none;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:6px}
.action-btn:active{transform:scale(.97)}
.action-btn.green{background:var(--green);color:#fff}.action-btn.green:hover{background:var(--green-d)}
.action-btn.red{background:var(--red);color:#fff}.action-btn.red:hover{background:var(--red-d)}
.action-btn.gold{background:var(--gold);color:#111}.action-btn.gold:hover{background:var(--gold-d)}
.action-btn.blue{background:var(--blue);color:#fff}
.action-btn.outline{background:transparent;border:1px solid var(--border);color:var(--text2)}.action-btn.outline:hover{border-color:var(--green);color:var(--green)}

/* â”€â”€ TABLE â”€â”€ */
.tbl{width:100%;border-collapse:collapse;font-size:13px}
.tbl th{padding:9px 10px;text-align:right;color:var(--text2);font-size:10px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);font-weight:700}
.tbl td{padding:10px;border-bottom:1px solid rgba(42,53,85,.4);vertical-align:middle}
.tbl tr:hover td{background:var(--bg3)}
.tag{display:inline-block;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(74,144,217,.15);color:var(--blue)}
.badge{display:inline-block;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:700}
.badge-green{background:rgba(0,184,148,.15);color:var(--green)}
.badge-red{background:rgba(225,112,85,.15);color:var(--red)}
.badge-gold{background:rgba(253,203,110,.15);color:var(--gold)}

/* â”€â”€ PROGRESS â”€â”€ */
.prog-row{margin-bottom:10px}
.prog-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;font-weight:700}
.prog-bar{height:8px;background:var(--bg4);border-radius:8px;overflow:hidden}
.prog-fill{height:100%;border-radius:8px;transition:width .8s cubic-bezier(.4,0,.2,1)}
.chart-wrap{position:relative;height:220px}

/* â”€â”€ ALERT â”€â”€ */
.alert-banner{border-radius:10px;padding:12px 16px;margin-bottom:14px;font-size:13px;font-weight:700;display:none;align-items:center;gap:8px}
.alert-banner.warning{background:rgba(253,203,110,.15);border:1px solid var(--gold);color:var(--gold);display:flex}
.alert-banner.danger{background:rgba(225,112,85,.15);border:1px solid var(--red);color:var(--red);display:flex}
.alert-banner.success{background:rgba(0,184,148,.15);border:1px solid var(--green);color:var(--green);display:flex}

/* â”€â”€ GOALS â”€â”€ */
.goal-card{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;transition:.2s;position:relative;overflow:hidden}
.goal-card:hover{border-color:var(--green);transform:translateY(-1px)}
.goal-emoji{font-size:36px;text-align:center;margin-bottom:8px;filter:drop-shadow(0 2px 8px rgba(0,0,0,.3))}
.goal-type-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
@media(max-width:500px){.goal-type-grid{grid-template-columns:repeat(4,1fr)}}
.goal-type-btn{background:var(--bg3);border:2px solid var(--border);border-radius:10px;padding:10px 6px;text-align:center;cursor:pointer;transition:.2s;font-size:11px;font-weight:700;color:var(--text2)}
.goal-type-btn:hover{border-color:var(--green);color:var(--green)}
.goal-type-btn.selected{border-color:var(--green);background:rgba(0,184,148,.1);color:var(--green)}
.goal-type-btn .type-icon{font-size:24px;display:block;margin-bottom:4px}

/* â”€â”€ ALLOCATION MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;display:none;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex}
.modal-box{background:var(--bg2);border:1px solid var(--border);border-radius:20px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow);animation:fadeUp .3s ease}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:15px;position:sticky;top:0;background:var(--bg2);z-index:1}
.modal-body{padding:20px}
.modal-close{background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;padding:4px;border-radius:6px;transition:.2s}
.modal-close:hover{color:var(--red)}

.alloc-row{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px}
.alloc-slider{width:100%;height:6px;-webkit-appearance:none;appearance:none;background:var(--bg4);border-radius:6px;outline:none;cursor:pointer;margin:8px 0}
.alloc-slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--green);cursor:pointer;box-shadow:0 0 6px rgba(0,184,148,.5)}
.alloc-total-bar{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px;text-align:center}

/* â”€â”€ AI TIPS â”€â”€ */
.ai-card{background:linear-gradient(135deg,rgba(139,92,246,.15),rgba(74,144,217,.1));border:1px solid rgba(139,92,246,.3);border-radius:12px;padding:14px;margin-bottom:16px}
.ai-tip{display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid rgba(139,92,246,.1);font-size:13px}
.ai-tip:last-child{border-bottom:none}
.ai-tip-icon{font-size:18px;flex-shrink:0;margin-top:1px}

/* â”€â”€ HEALTH SCORE â”€â”€ */
.health-ring{width:100px;height:100px;position:relative;margin:0 auto 10px}
.health-ring svg{transform:rotate(-90deg)}
.health-ring-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column}
.health-score-num{font-size:24px;font-weight:900}
.health-score-lbl{font-size:10px;color:var(--text2)}

/* â”€â”€ CONFETTI â”€â”€ */
.confetti-piece{position:fixed;width:8px;height:8px;border-radius:2px;pointer-events:none;z-index:9999;animation:confettiFall 2.5s ease-in forwards}
@keyframes confettiFall{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}

/* â”€â”€ COUNTER ANIMATION â”€â”€ */
.counting{transition:all .05s}

/* â”€â”€ MOBILE â”€â”€ */
@media(max-width:600px){
  .header-right .btn-sm:not(.btn-red-sm){display:none}
  main{padding:10px}
  .cards-grid{grid-template-columns:repeat(2,1fr);gap:8px}
  .card{padding:12px}
  .card-value{font-size:16px}
  .panel-body{padding:12px}
  .goal-type-grid{gap:6px}
}
@media print{header,.nav-tabs,.action-btn,.btn-sm{display:none!important}body{background:#fff;color:#000}.card,.panel{border:1px solid #ccc;background:#fff}}
.loading{color:var(--text2);text-align:center;padding:24px;font-size:13px}
.flex-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}



/* â”€â”€ STATS â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:18px;}
.stat-panel{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;}
.stat-title{font-size:12px;font-weight:700;color:var(--text2);margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px;}
.chart-wrap-sm{height:180px;position:relative;}

/* â”€â”€ BUDGET ALERT â”€â”€ */
.budget-over{background:rgba(225,112,85,.1);border:1px solid var(--red);border-radius:10px;padding:10px 14px;font-size:12px;color:var(--red);margin-bottom:10px;display:none;}

/* â”€â”€ EMAIL MODAL â”€â”€ */
.email-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:500;display:none;align-items:center;justify-content:center;}
.email-modal.open{display:flex;}
.email-box{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:28px;width:100%;max-width:400px;}
.email-title{font-size:16px;font-weight:900;margin-bottom:16px;}

/* â”€â”€ AUTH PAGE â”€â”€ */
.auth-overlay{position:fixed;inset:0;z-index:9999;background:radial-gradient(ellipse at 30% 50%,rgba(0,184,148,.12) 0%,transparent 60%),radial-gradient(ellipse at 70% 20%,rgba(74,144,217,.08) 0%,transparent 50%),var(--bg);display:flex;align-items:center;justify-content:center;}
.auth-card{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:40px 36px;width:100%;max-width:400px;box-shadow:0 8px 40px rgba(0,0,0,.5);}
.auth-logo-big{text-align:center;font-size:36px;font-weight:900;color:var(--green);margin-bottom:4px;}
.auth-logo-big span{color:var(--gold);}
.auth-tagline{text-align:center;color:var(--text2);font-size:12px;margin-bottom:28px;}
.auth-tabs{display:flex;gap:0;margin-bottom:24px;border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.auth-tab{flex:1;padding:10px;text-align:center;font-size:13px;font-weight:700;cursor:pointer;transition:.2s;color:var(--text2);background:transparent;border:none;font-family:inherit;}
.auth-tab.active{background:var(--green);color:#fff;}
.auth-field{margin-bottom:14px;}
.auth-field label{display:block;font-size:11px;font-weight:700;color:var(--text2);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px;}
.auth-err{background:rgba(225,112,85,.12);border:1px solid var(--red);color:var(--red);padding:9px 12px;border-radius:8px;font-size:12px;margin-bottom:12px;display:none;}
.auth-err.show{display:block;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MICRO-INTERACTIONS & LIFE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Staggered card entrance â”€â”€ */
@keyframes cardIn {
  from { opacity:0; transform:translateY(22px) scale(.97); }
  to   { opacity:1; transform:translateY(0) scale(1); }
}
.cards-grid .card {
  animation: cardIn .45s cubic-bezier(.22,1,.36,1) both;
}
.cards-grid .card:nth-child(1){animation-delay:.04s}
.cards-grid .card:nth-child(2){animation-delay:.10s}
.cards-grid .card:nth-child(3){animation-delay:.16s}
.cards-grid .card:nth-child(4){animation-delay:.22s}
.cards-grid .card:nth-child(5){animation-delay:.28s}

/* â”€â”€ Card hover â€” glow + lift â”€â”€ */
.card {
  transition: transform .25s cubic-bezier(.22,1,.36,1),
              box-shadow .25s ease,
              border-color .25s ease !important;
}
.card:hover {
  transform: translateY(-5px) scale(1.02) !important;
  box-shadow: 0 12px 36px rgba(0,0,0,.45), 0 0 0 1px rgba(0,184,148,.18) !important;
  border-color: rgba(0,184,148,.35) !important;
}
.card.red:hover  { box-shadow: 0 12px 36px rgba(0,0,0,.45), 0 0 0 1px rgba(225,112,85,.25) !important; border-color: rgba(225,112,85,.35) !important; }
.card.gold:hover { box-shadow: 0 12px 36px rgba(0,0,0,.45), 0 0 0 1px rgba(253,203,110,.25) !important; border-color: rgba(253,203,110,.35) !important; }
.card.blue:hover { box-shadow: 0 12px 36px rgba(0,0,0,.45), 0 0 0 1px rgba(74,144,217,.25) !important; border-color: rgba(74,144,217,.35) !important; }

/* â”€â”€ Shimmer effect on card top bar â”€â”€ */
.card::after {
  content: '';
  position: absolute;
  top: 0; left: -100%; width: 60%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.04), transparent);
  transition: left .5s ease;
  pointer-events: none;
}
.card:hover::after { left: 150%; }

/* â”€â”€ Nav tab â€” sliding indicator â”€â”€ */
.nav-tab {
  position: relative;
  transition: color .2s, transform .15s !important;
}
.nav-tab:hover { transform: translateY(-1px); }
.nav-tab.active { text-shadow: 0 0 20px rgba(0,184,148,.4); }

/* â”€â”€ Buttons â€” juicy press â”€â”€ */
.action-btn {
  transition: transform .15s cubic-bezier(.22,1,.36,1),
              box-shadow .15s ease,
              background .2s ease,
              filter .2s ease !important;
}
.action-btn:hover {
  transform: translateY(-2px) !important;
  box-shadow: 0 6px 20px rgba(0,0,0,.3) !important;
  filter: brightness(1.08);
}
.action-btn:active {
  transform: scale(.95) translateY(0) !important;
  box-shadow: none !important;
  filter: brightness(.95);
}
.action-btn.green:hover { box-shadow: 0 6px 20px rgba(0,184,148,.35) !important; }
.action-btn.red:hover   { box-shadow: 0 6px 20px rgba(225,112,85,.35) !important; }

/* â”€â”€ btn-sm bounce â”€â”€ */
.btn-sm {
  transition: transform .15s cubic-bezier(.34,1.56,.64,1), background .2s, color .2s, border-color .2s !important;
}
.btn-sm:hover  { transform: translateY(-2px) scale(1.04) !important; }
.btn-sm:active { transform: scale(.93) !important; }

/* â”€â”€ Input focus â€” grow + glow â”€â”€ */
.inp, .form-group input {
  transition: border-color .2s, box-shadow .2s, transform .15s cubic-bezier(.22,1,.36,1) !important;
}
.inp:focus, .form-group input:focus {
  transform: scale(1.01);
  box-shadow: 0 0 0 3px rgba(0,184,148,.15), 0 4px 16px rgba(0,0,0,.2) !important;
}

/* â”€â”€ Table rows â€” slide in â”€â”€ */
@keyframes rowIn {
  from { opacity:0; transform:translateX(10px); }
  to   { opacity:1; transform:translateX(0); }
}
.tbl tbody tr {
  animation: rowIn .3s cubic-bezier(.22,1,.36,1) both;
}
.tbl tbody tr:nth-child(1){animation-delay:.03s}
.tbl tbody tr:nth-child(2){animation-delay:.07s}
.tbl tbody tr:nth-child(3){animation-delay:.11s}
.tbl tbody tr:nth-child(4){animation-delay:.15s}
.tbl tbody tr:nth-child(5){animation-delay:.19s}
.tbl tbody tr:nth-child(6){animation-delay:.23s}
.tbl tbody tr:nth-child(n+7){animation-delay:.27s}

.tbl tr { transition: background .15s, transform .15s !important; }
.tbl tr:hover td { background: var(--bg3); }
.tbl tbody tr:hover { transform: translateX(-2px); }

/* â”€â”€ Panel entrance â”€â”€ */
@keyframes panelIn {
  from { opacity:0; transform:translateY(16px); }
  to   { opacity:1; transform:translateY(0); }
}
.panel {
  animation: panelIn .4s cubic-bezier(.22,1,.36,1) both;
}

/* â”€â”€ Goal cards â”€â”€ */
.goal-card {
  transition: transform .25s cubic-bezier(.22,1,.36,1),
              border-color .25s, box-shadow .25s !important;
}
.goal-card:hover {
  transform: translateY(-4px) !important;
  border-color: var(--green) !important;
  box-shadow: 0 8px 28px rgba(0,184,148,.15) !important;
}

/* â”€â”€ Progress bars â€” animated fill â”€â”€ */
@keyframes progFill {
  from { width: 0 !important; }
}
.prog-fill { animation: progFill .9s cubic-bezier(.22,1,.36,1) both; }

/* â”€â”€ Header logo pulse â”€â”€ */
@keyframes logoPulse {
  0%,100% { text-shadow: 0 0 8px rgba(0,184,148,.0); }
  50%      { text-shadow: 0 0 20px rgba(0,184,148,.5); }
}
.logo { animation: logoPulse 3s ease-in-out infinite; }

/* â”€â”€ Toast notification â€” bounce in â”€â”€ */
@keyframes toastIn {
  from { opacity:0; transform:translateY(20px) scale(.9); }
  to   { opacity:1; transform:translateY(0) scale(1); }
}
@keyframes toastOut {
  from { opacity:1; transform:translateY(0) scale(1); }
  to   { opacity:0; transform:translateY(10px) scale(.95); }
}

/* â”€â”€ Section transition â€” smoother â”€â”€ */
@keyframes fadeUp {
  from { opacity:0; transform:translateY(14px); }
  to   { opacity:1; transform:translateY(0); }
}
.section.active { animation: fadeUp .35s cubic-bezier(.22,1,.36,1) both !important; }

/* â”€â”€ Auth card â”€â”€ */
@keyframes authCardIn {
  from { opacity:0; transform:translateY(30px) scale(.96); }
  to   { opacity:1; transform:translateY(0) scale(1); }
}
.auth-card { animation: authCardIn .5s cubic-bezier(.22,1,.36,1) both; }

/* â”€â”€ Floating orbs background â”€â”€ */
body::before {
  content: '';
  position: fixed;
  width: 500px; height: 500px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(0,184,148,.06) 0%, transparent 70%);
  top: -100px; right: -100px;
  pointer-events: none;
  animation: orbFloat 8s ease-in-out infinite;
  z-index: 0;
}
body::after {
  content: '';
  position: fixed;
  width: 400px; height: 400px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(74,144,217,.05) 0%, transparent 70%);
  bottom: -80px; left: -80px;
  pointer-events: none;
  animation: orbFloat 10s ease-in-out infinite reverse;
  z-index: 0;
}
@keyframes orbFloat {
  0%,100% { transform: translate(0,0) scale(1); }
  33%     { transform: translate(20px,-15px) scale(1.05); }
  66%     { transform: translate(-10px,20px) scale(.97); }
}

/* â”€â”€ Number change flash â”€â”€ */
@keyframes numFlash {
  0%   { color: var(--green); transform: scale(1.08); }
  100% { transform: scale(1); }
}
.card-value.flash { animation: numFlash .4s ease both; }

/* â”€â”€ Ripple on buttons â”€â”€ */
.action-btn { overflow: hidden; position: relative; }


@keyframes rippleAnim {
  to { transform:scale(1); opacity:0; }
}

/* â”€â”€ FORGOT PASSWORD â”€â”€ */
.auth-forgot{text-align:left;margin-top:8px;}
.auth-forgot a{color:var(--text2);font-size:11px;cursor:pointer;text-decoration:none;transition:.2s;}
.auth-forgot a:hover{color:var(--green);}
.auth-back{background:none;border:none;color:var(--text2);font-size:12px;cursor:pointer;font-family:inherit;padding:0;margin-bottom:16px;display:flex;align-items:center;gap:4px;transition:.2s;}
.auth-back:hover{color:var(--green);}

/* â”€â”€ SMART GREETING â”€â”€ */
.greeting-card{
  background: linear-gradient(135deg, rgba(0,184,148,.08), rgba(74,144,217,.06));
  border: 1px solid rgba(0,184,148,.25);
  border-radius: 16px;
  padding: 18px 20px;
  margin-bottom: 18px;
  position: relative;
  overflow: hidden;
  animation: cardIn .5s cubic-bezier(.22,1,.36,1) both;
}
.greeting-card::before {
  content:'';position:absolute;top:0;right:0;width:120px;height:120px;
  background: radial-gradient(circle, rgba(0,184,148,.12), transparent 70%);
  border-radius:50%;
}
.greeting-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
.greeting-hello { font-size:15px; font-weight:900; color:var(--text); }
.greeting-hello span { color:var(--green); }
.greeting-time { font-size:11px; color:var(--text2); }
.greeting-insights { display:flex; flex-direction:column; gap:8px; }
.g-insight {
  display:flex; align-items:flex-start; gap:10px;
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.06);
  border-radius: 10px;
  padding: 10px 12px;
  font-size:12px; line-height:1.6; color:var(--text2);
  animation: rowIn .4s cubic-bezier(.22,1,.36,1) both;
}
.g-insight:nth-child(1){animation-delay:.05s}
.g-insight:nth-child(2){animation-delay:.12s}
.g-insight:nth-child(3){animation-delay:.19s}
.g-insight-icon { font-size:18px; flex-shrink:0; margin-top:1px; }
.g-insight-text b { color:var(--text); font-weight:700; }
.g-badge {
  display:inline-block; font-size:9px; font-weight:700; letter-spacing:.8px;
  text-transform:uppercase; padding:2px 7px; border-radius:20px; margin-left:6px;
}
.g-badge.up   { background:rgba(225,112,85,.15); color:var(--red); }
.g-badge.down { background:rgba(0,184,148,.15);  color:var(--green); }
.g-badge.warn { background:rgba(253,203,110,.15); color:var(--gold); }
.g-badge.good { background:rgba(0,184,148,.15);  color:var(--green); }
.greeting-no-data { font-size:13px; color:var(--text2); text-align:center; padding:8px 0; }

/* â•â• GOALS UPGRADE â•â• */

/* â”€â”€ Goal card redesign â”€â”€ */
.goal-card-v2 {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 0;
  overflow: hidden;
  transition: transform .25s cubic-bezier(.22,1,.36,1), box-shadow .25s, border-color .25s;
  position: relative;
}
.goal-card-v2:hover {
  transform: translateY(-4px);
  box-shadow: 0 16px 40px rgba(0,0,0,.4);
  border-color: rgba(0,184,148,.3);
}
.goal-card-top {
  padding: 18px 18px 14px;
  position: relative;
}
.goal-card-banner {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
  border-radius: 18px 18px 0 0;
}
.goal-emoji-big {
  font-size: 42px;
  line-height: 1;
  margin-bottom: 10px;
  display: block;
  filter: drop-shadow(0 4px 12px rgba(0,0,0,.3));
  transition: transform .3s cubic-bezier(.34,1.56,.64,1);
}
.goal-card-v2:hover .goal-emoji-big { transform: scale(1.15) rotate(-5deg); }

.goal-name { font-size: 16px; font-weight: 900; margin-bottom: 4px; }
.goal-eta-pill {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 10px; font-weight: 700; letter-spacing: .5px;
  padding: 3px 10px; border-radius: 20px;
  background: rgba(255,255,255,.06); color: var(--text2);
  border: 1px solid var(--border);
}

/* â”€â”€ Circular progress â”€â”€ */
.goal-ring-wrap {
  display: flex; align-items: center; justify-content: center;
  margin: 14px 0 10px;
}
.goal-ring { position: relative; width: 110px; height: 110px; flex-shrink: 0; }
.goal-ring svg { transform: rotate(-90deg); }
.goal-ring-center {
  position: absolute; inset: 0;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.goal-ring-pct { font-size: 22px; font-weight: 900; line-height: 1; }
.goal-ring-label { font-size: 9px; color: var(--text2); font-weight: 700; letter-spacing: .5px; }
.goal-ring-stats { flex: 1; padding-right: 16px; display: flex; flex-direction: column; gap: 8px; }
.goal-stat-row { display: flex; flex-direction: column; }
.goal-stat-label { font-size: 9px; color: var(--text2); font-weight: 700; text-transform: uppercase; letter-spacing: .5px; }
.goal-stat-val { font-size: 14px; font-weight: 900; }

/* â”€â”€ Timeline milestones â”€â”€ */
.goal-timeline {
  padding: 0 18px 6px;
  display: flex;
  align-items: center;
  gap: 0;
  position: relative;
  margin-bottom: 14px;
}
.goal-timeline-track {
  position: absolute; top: 50%; left: 18px; right: 18px;
  height: 2px; background: var(--border);
  transform: translateY(-50%);
}
.goal-timeline-fill {
  position: absolute; top: 0; left: 0;
  height: 100%; border-radius: 2px;
  transition: width 1s cubic-bezier(.22,1,.36,1);
}
.milestone {
  position: relative; z-index: 1;
  display: flex; flex-direction: column; align-items: center;
  flex: 1;
}
.milestone-dot {
  width: 20px; height: 20px; border-radius: 50%;
  border: 2px solid var(--border);
  background: var(--bg2);
  display: flex; align-items: center; justify-content: center;
  font-size: 9px;
  transition: all .4s cubic-bezier(.34,1.56,.64,1);
}
.milestone.reached .milestone-dot {
  background: var(--green); border-color: var(--green);
  box-shadow: 0 0 12px rgba(0,184,148,.5);
  transform: scale(1.2);
}
.milestone-lbl { font-size: 8px; color: var(--text2); margin-top: 4px; font-weight: 700; white-space: nowrap; }

/* â”€â”€ Actions â”€â”€ */
.goal-actions {
  display: grid; grid-template-columns: 1fr 1fr;
  border-top: 1px solid var(--border);
}
.goal-action-btn {
  padding: 12px; border: none; background: transparent;
  font-family: inherit; font-size: 12px; font-weight: 700;
  cursor: pointer; color: var(--text2); display: flex;
  align-items: center; justify-content: center; gap: 5px;
  transition: background .2s, color .2s;
}
.goal-action-btn:hover { background: var(--bg3); }
.goal-action-btn:first-child { border-left: 1px solid var(--border); }
.goal-action-btn.primary { color: var(--green); }
.goal-action-btn.danger  { color: var(--red); }

/* â”€â”€ Edit goal modal â”€â”€ */
.edit-goal-modal {
  position: fixed; inset: 0; z-index: 600;
  background: rgba(0,0,0,.7); backdrop-filter: blur(6px);
  display: none; align-items: center; justify-content: center; padding: 16px;
}
.edit-goal-modal.open { display: flex; }
.edit-goal-box {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 20px; padding: 28px; width: 100%; max-width: 420px;
  animation: fadeUp .35s cubic-bezier(.22,1,.36,1) both;
}

/* â”€â”€ Celebration overlay â”€â”€ */
@keyframes celebPop {
  0%   { transform: scale(0) rotate(-10deg); opacity: 0; }
  60%  { transform: scale(1.1) rotate(3deg); }
  100% { transform: scale(1) rotate(0deg); opacity: 1; }
}
.goal-complete-badge {
  position: absolute; top: 10px; left: 10px;
  background: linear-gradient(135deg, var(--gold), #f39c12);
  color: #000; font-size: 9px; font-weight: 900;
  letter-spacing: 1px; text-transform: uppercase;
  padding: 4px 10px; border-radius: 20px;
  animation: celebPop .5s cubic-bezier(.34,1.56,.64,1) both;
  box-shadow: 0 4px 12px rgba(253,203,110,.4);
}

/* â”€â”€ Pulse on deposit btn â”€â”€ */
@keyframes depositPulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(0,184,148,.4); }
  50% { box-shadow: 0 0 0 8px rgba(0,184,148,0); }
}
.goal-action-btn.primary { animation: depositPulse 2.5s ease-in-out infinite; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• Ù…Ø§Ù„ÙŠ+ Standalone â•â•â•â•â•â•â•â•â•â• -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<!-- EMAIL MODAL -->
<div class="email-modal" id="emailModal">
  <div class="email-box">
    <div class="email-title">ğŸ“§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
    <div class="form-group" style="margin-bottom:12px">
      <label class="lbl">Service ID (Ù…Ù† EmailJS)</label>
      <input class="inp" id="ej-service" placeholder="service_xxxxxxx"/>
    </div>
    <div class="form-group" style="margin-bottom:12px">
      <label class="lbl">Template ID</label>
      <input class="inp" id="ej-template" placeholder="template_xxxxxxx"/>
    </div>
    <div class="form-group" style="margin-bottom:12px">
      <label class="lbl">Public Key</label>
      <input class="inp" id="ej-pubkey" placeholder="xxxxxxxxxxxxxxx"/>
    </div>
    <div class="form-group" style="margin-bottom:16px">
      <label class="lbl">Ø¥ÙŠÙ…ÙŠÙ„Ùƒ</label>
      <input class="inp" id="ej-email" type="email" placeholder="you@gmail.com"/>
    </div>
    <div style="display:flex;gap:10px">
      <button class="action-btn green" onclick="saveEmailConfig()" style="flex:1;justify-content:center">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="action-btn" onclick="testEmail()" style="flex:1;justify-content:center;background:var(--blue);color:#fff">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±</button>
      <button class="action-btn" onclick="closeEmailModal()" style="background:var(--bg3);color:var(--text2)">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <p style="font-size:11px;color:var(--text2);margin-top:10px">ğŸ’¡ Ø³Ø¬Ù„ Ù…Ø¬Ø§Ù†Ø§Ù‹ Ø¹Ù„Ù‰ <a href="https://emailjs.com" target="_blank" style="color:var(--green)">emailjs.com</a> ÙˆØ£Ù†Ø´Ø¦ template</p>
  </div>
</div>

<!-- â•â• AUTH OVERLAY â•â• -->
<div id="authOverlay" class="auth-overlay">
  <div class="auth-card">
    <div class="auth-logo-big">ğŸ‡²ğŸ‡¦ Ù…Ø§Ù„ÙŠ<span>+</span></div>
    <div class="auth-tagline">ØªØ³ÙŠÙŠØ± Ù…Ø§Ù„ÙŠ Ø°ÙƒÙŠ â€” Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-login-btn" onclick="switchAuthTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="auth-tab" id="tab-reg-btn" onclick="switchAuthTab('register')">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <div id="auth-err" class="auth-err"></div>
    <div class="auth-field">
      <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
      <input class="inp" type="email" id="auth-email" placeholder="you@gmail.com" autocomplete="email"/>
    </div>
    <div class="auth-field">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
      <input class="inp" type="password" id="auth-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
    </div>
    <div class="auth-field" id="auth-pass2-wrap" style="display:none">
      <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
      <input class="inp" type="password" id="auth-pass2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password"/>
    </div>
    <!-- Ø³Ø¤Ø§Ù„ Ø³Ø±ÙŠ â€” ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
    <div class="auth-field" id="auth-question-wrap" style="display:none">
      <label>Ø³Ø¤Ø§Ù„ Ø³Ø±ÙŠ (Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±)</label>
      <select class="inp" id="auth-question">
        <option value="">â€” Ø§Ø®ØªØ± Ø³Ø¤Ø§Ù„ â€”</option>
        <option>Ø§Ø³Ù… Ù…Ø¯Ø±Ø³ØªÙƒ Ø§Ù„Ø£ÙˆÙ„Ù‰ØŸ</option>
        <option>Ø§Ø³Ù… Ø£ÙˆÙ„ ØµØ¯ÙŠÙ‚ Ù„ÙƒØŸ</option>
        <option>Ø§Ø³Ù… Ø­ÙŠÙˆØ§Ù†Ùƒ Ø§Ù„Ø£Ù„ÙŠÙ Ø§Ù„Ø£ÙˆÙ„ØŸ</option>
        <option>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù„ÙŠ ÙˆÙ„Ø¯Øª ÙÙŠÙ‡Ø§ØŸ</option>
        <option>Ø§Ø³Ù… Ø§Ù„Ø£Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø²ÙˆØ§Ø¬ØŸ</option>
      </select>
    </div>
    <div class="auth-field" id="auth-answer-wrap" style="display:none">
      <label>Ø¬ÙˆØ§Ø¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠ</label>
      <input class="inp" type="text" id="auth-answer" placeholder="Ø¬ÙˆØ§Ø¨Ùƒ Ø§Ù„Ø³Ø±ÙŠ..."/>
    </div>
    <button class="btn btn-green" id="auth-submit-btn" onclick="authSubmit()" style="margin-top:4px">Ø¯Ø®ÙˆÙ„</button>
    <div class="auth-forgot" id="auth-forgot-link">
      <a onclick="switchAuthTab('forgot')">ğŸ”‘ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</a>
    </div>
  </div>

  <!-- â•â• FORGOT PANEL â•â• -->
  <div id="auth-forgot-panel" style="display:none">
    <button class="auth-back" onclick="switchAuthTab('login')">â† Ø±Ø¬ÙˆØ¹</button>
    <div class="auth-logo-big" style="font-size:28px">ğŸ”‘ Ù…Ø§Ù„ÙŠ<span style="color:var(--gold)">+</span></div>
    <div class="auth-tagline">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</div>
    <div id="forgot-err" class="auth-err"></div>

    <!-- Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ -->
    <div id="forgot-step1">
      <div class="auth-field">
        <label>Ø¥ÙŠÙ…ÙŠÙ„Ùƒ</label>
        <input class="inp" type="email" id="forgot-email" placeholder="you@gmail.com"/>
      </div>
      <button class="btn btn-green" onclick="forgotStep1()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    </div>

    <!-- Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠ -->
    <div id="forgot-step2" style="display:none">
      <div class="auth-field">
        <label id="forgot-question-lbl" style="font-size:13px;color:var(--text);font-weight:700"></label>
        <input class="inp" type="text" id="forgot-answer-inp" placeholder="Ø¬ÙˆØ§Ø¨Ùƒ..."/>
      </div>
      <button class="btn btn-green" onclick="forgotStep2()">ØªØ­Ù‚Ù‚</button>
    </div>

    <!-- Ø§Ù„Ø®Ø·ÙˆØ© 3: ÙƒÙ„Ù…Ø© Ø³Ø± Ø¬Ø¯ÙŠØ¯Ø© -->
    <div id="forgot-step3" style="display:none">
      <div class="auth-field">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
        <input class="inp" type="password" id="forgot-newpass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
      </div>
      <div class="auth-field">
        <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
        <input class="inp" type="password" id="forgot-newpass2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
      </div>
      <button class="btn btn-green" onclick="forgotStep3()">âœ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
    </div>
  </div>
</div>

<header>
  <div class="logo">ğŸ‡²ğŸ‡¦ Ù…Ø§Ù„ÙŠ<span>+</span></div>
  <div class="header-right">
    <div class="month-sel">
      <select id="selMonth" onchange="changeMonth()">
        <option value="1">ÙŠÙ†Ø§ÙŠØ±</option><option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option><option value="3">Ù…Ø§Ø±Ø³</option>
        <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option><option value="5">Ù…Ø§ÙŠ</option><option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
        <option value="7">ÙŠÙˆÙ„ÙŠÙˆØ²</option><option value="8">ØºØ´Øª</option><option value="9">Ø´ØªÙ†Ø¨Ø±</option>
        <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option><option value="11">Ù†ÙˆÙ†Ø¨Ø±</option><option value="12">Ø¯Ø¬Ù†Ø¨Ø±</option>
      </select>
      <select id="selYear" onchange="changeMonth()">
        <option value="2026">2026</option><option value="2027">2027</option>
        <option value="2028">2028</option><option value="2029">2029</option>
        <option value="2030">2030</option>
      </select>
    </div>
    <span class="user-badge" id="user-badge">ğŸ‘¤ ...</span>
    <button class="btn-sm btn-red-sm" onclick="doLogout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
    <button class="btn-sm btn-outline-sm" onclick="expExcel()">ğŸ“Š Excel</button>
    <button class="btn-sm btn-outline-sm" onclick="expPDF()">ğŸ“„ PDF</button>
    <button class="btn-sm btn-outline-sm" onclick="window.print()">ğŸ–¨ï¸</button>
    <button class="btn-sm btn-red-sm" onclick="exportData()">ğŸ“¤ ØªØµØ¯ÙŠØ±</button>
  </div>
</header>

<div class="nav-tabs">
  <div class="nav-tab active" onclick="showTab('dashboard')">ğŸ“Š Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</div>
  <div class="nav-tab" onclick="showTab('income')">ğŸ’° Ø§Ù„Ø¯Ø®Ù„</div>
  <div class="nav-tab" onclick="showTab('expenses')">ğŸ’¸ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
  <div class="nav-tab" onclick="showTab('goals')">ğŸ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</div>
  <div class="nav-tab" onclick="showTab('annual')">ğŸ“… Ø³Ù†ÙˆÙŠ</div>
  <div class="nav-tab" onclick="showTab('stats')">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
  <div class="nav-tab" onclick="showTab('settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
</div>

<main>

<!-- â•â• DASHBOARD â•â• -->
<div id="tab-dashboard" class="section active">
  <div class="sec-title">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</div>
  <div id="alertBanner" class="alert-banner"></div>

  <!-- Smart Greeting -->
  <div id="greeting-card" class="greeting-card" style="display:none">
    <div class="greeting-top">
      <div class="greeting-hello" id="greeting-hello">Ù…Ø±Ø­Ø¨Ø§Ù‹</div>
      <div class="greeting-time" id="greeting-time"></div>
    </div>
    <div class="greeting-insights" id="greeting-insights"></div>
  </div>

  <!-- AI Tips -->
  <div id="ai-section" class="ai-card" style="display:none">
    <div style="font-size:13px;font-weight:900;color:#8b5cf6;margin-bottom:8px">ğŸ¤– ØªÙˆØµÙŠØ§Øª Ø°ÙƒÙŠØ©</div>
    <div id="ai-tips"></div>
  </div>

  <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ -->
  <div id="week-summary" style="display:none;background:linear-gradient(135deg,rgba(74,144,217,.08),rgba(139,92,246,.06));border:1px solid rgba(74,144,217,.2);border-radius:14px;padding:14px 18px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <div>
      <div style="font-size:10px;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">ğŸ“… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
      <div style="font-size:22px;font-weight:900;color:var(--blue)" id="week-total">-</div>
      <div style="font-size:11px;color:var(--text2)" id="week-count">-</div>
    </div>
    <div style="text-align:left">
      <div style="font-size:10px;color:var(--text2);font-weight:700;margin-bottom:4px">Ø£ÙƒØ«Ø± ÙØ¦Ø©</div>
      <div style="font-size:14px;font-weight:900;color:var(--purple)" id="week-top-cat">-</div>
    </div>
  </div>

  <div class="cards-grid">
    <div class="card green"><div class="card-label">Ø§Ù„ØµØ§Ù„ÙŠØ±</div><div class="card-value green" id="d-salary">-</div></div>
    <div class="card gold"><div class="card-label">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ„ÙŠ</div><div class="card-value gold" id="d-income">-</div><div class="card-sub" id="d-bonus-sub"></div></div>
    <div class="card red"><div class="card-label">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div><div class="card-value red" id="d-exp">-</div><div class="card-trend" id="d-exp-trend"></div></div>
    <div class="card blue"><div class="card-label">Ø§Ù„Ø¨Ø§Ù‚ÙŠ</div><div class="card-value blue" id="d-rem">-</div></div>
    <div class="card purple"><div class="card-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</div><div class="card-value purple" id="d-pct">-</div></div>
    <div class="card green" style="cursor:pointer" onclick="showTab('goals')">
      <div class="card-label">Ø§Ù„ØµØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="health-ring" style="width:54px;height:54px">
          <svg width="54" height="54" viewBox="0 0 54 54">
            <circle cx="27" cy="27" r="22" fill="none" stroke="var(--bg4)" stroke-width="5"/>
            <circle id="health-arc" cx="27" cy="27" r="22" fill="none" stroke="var(--green)" stroke-width="5"
              stroke-dasharray="138.2" stroke-dashoffset="138.2" stroke-linecap="round" style="transition:stroke-dashoffset 1s ease"/>
          </svg>
          <div class="health-ring-text"><span class="health-score-num" id="health-num">-</span></div>
        </div>
        <div style="font-size:11px;color:var(--text2)" id="health-lbl">Ø¬Ø§Ø±ÙŠ...</div>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <div class="panel">
      <div class="panel-header">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <div class="panel-body"><div class="chart-wrap"><canvas id="chartPie"></canvas></div></div>
    </div>
    <div class="panel">
      <div class="panel-header">ğŸ“‰ ØªÙØµÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª</div>
      <div class="panel-body" id="exp-breakdown"><div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    </div>
  </div>
  <div class="panel">
    <div class="panel-header">ğŸ’³ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
    <div class="panel-body" style="overflow-x:auto">
      <table class="tbl"><thead><tr><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
      <tbody id="recent-ops"><tr><td colspan="4" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody></table>
    </div>
  </div>
</div>

<!-- â•â• INCOME â•â• -->
<div id="tab-income" class="section">
  <div class="sec-title">ğŸ’° Ø§Ù„Ø¯Ø®Ù„</div>
  <div class="panel">
    <div class="panel-header">Ø§Ù„ØµØ§Ù„ÙŠØ± ÙˆØ§Ù„Ø¨Ø±ÙŠÙ…</div>
    <div class="panel-body">
      <div class="form-grid">
        <div><label class="lbl">ğŸ¦ Ø§Ù„ØµØ§Ù„ÙŠØ± (Ø¯Ø±Ù‡Ù…)</label><input class="inp" type="number" id="in-salary" oninput="saveIncome()" placeholder="Ù…Ø«Ø§Ù„: 6000"/></div>
        <div><label class="lbl">ğŸ Ø¨Ø±ÙŠÙ… Ø´Ù‡Ø±ÙŠÙ†</label><input class="inp" type="number" id="in-b2" oninput="saveIncome()" placeholder="Ù…Ø«Ø§Ù„: 12000"/></div>
        <div><label class="lbl">ğŸŠ Ø¨Ø±ÙŠÙ… 6 Ø£Ø´Ù‡Ø±</label><input class="inp" type="number" id="in-b6" oninput="saveIncome()" placeholder="Ù…Ø«Ø§Ù„: 36000"/></div>
        <div><label class="lbl">ğŸŒ ÙŠÙˆÙ… Ø¹Ø§Ù„Ù…ÙŠ</label><input class="inp" type="number" id="in-intl" oninput="saveIncome()" placeholder="Ù…Ø«Ø§Ù„: 3000"/></div>
        <div><label class="lbl">â• Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ</label><input class="inp" type="number" id="in-extra" oninput="saveIncome()" placeholder="Ù…Ø«Ø§Ù„: 1500"/></div>
        <div><label class="lbl">Ø¨Ø±ÙŠÙ… Ø´Ù‡Ø±ÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ</label><select class="inp" id="in-b2a" onchange="saveIncome()"><option value="false">Ù„Ø§</option><option value="true">Ù†Ø¹Ù…</option></select></div>
        <div><label class="lbl">Ø¨Ø±ÙŠÙ… 6 Ø£Ø´Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ</label><select class="inp" id="in-b6a" onchange="saveIncome()"><option value="false">Ù„Ø§</option><option value="true">Ù†Ø¹Ù…</option></select></div>
        <div><label class="lbl">ÙŠÙˆÙ… Ø¹Ø§Ù„Ù…ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ</label><select class="inp" id="in-ia" onchange="saveIncome()"><option value="false">Ù„Ø§</option><option value="true">Ù†Ø¹Ù…</option></select></div>
      </div>
    </div>
  </div>
  <div class="cards-grid">
    <div class="card green"><div class="card-label">Ø§Ù„ØµØ§Ù„ÙŠØ±</div><div class="card-value green" id="is-sal">-</div></div>
    <div class="card gold"><div class="card-label">Ø§Ù„Ø¨Ø±ÙŠÙ…</div><div class="card-value gold" id="is-bon">-</div></div>
    <div class="card blue"><div class="card-label">Ø¥Ø¶Ø§ÙÙŠ</div><div class="card-value blue" id="is-ext">-</div></div>
    <div class="card purple"><div class="card-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div><div class="card-value purple" id="is-tot">-</div></div>
  </div>
</div>

<!-- â•â• EXPENSES â•â• -->
<div id="tab-expenses" class="section">
  <div class="sec-title">ğŸ’¸ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
  <div class="panel">
    <div class="panel-header">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ
      <button class="btn-sm btn-outline-sm" onclick="importLastMonth()" title="Ø£Ø¶Ù Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ">ğŸ“‹ Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ</button>
    </div>
    <div class="panel-body">
      <div class="form-grid">
        <div><label class="lbl">ğŸ“‚ Ø§Ù„ÙØ¦Ø©</label>
          <select class="inp" id="exp-cat">
            <option>ÙƒØ±Ø§Ø¡</option><option>Ù…Ø§Ø¡ ÙˆÙƒÙ‡Ø±Ø¨Ø§Ø¡</option><option>ÙˆØ§ÙŠ ÙØ§ÙŠ</option>
            <option>ØªØ±Ù†Ø³Ø¨ÙˆØ±</option><option>ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</option><option>Ù…Ø§ÙƒÙ„Ø©</option>
            <option>ØªØ±ÙÙŠÙ‡</option><option>ØµØ­Ø©</option><option>Ù…Ù„Ø§Ø¨Ø³</option>
            <option>Ø§Ø¯Ø®Ø§Ø±</option><option>Ø£Ø®Ø±Ù‰</option>
          </select></div>
        <div><label class="lbl">ğŸ“ Ø§Ù„ÙˆØµÙ</label><input class="inp" type="text" id="exp-desc" placeholder="ÙˆØµÙ Ù‚ØµÙŠØ±"/></div>
        <div><label class="lbl">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯Ø±Ù‡Ù…)</label><input class="inp" type="number" id="exp-amt" placeholder="Ù…Ø«Ø§Ù„: 500"/></div>
        <div><label class="lbl">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input class="inp" type="date" id="exp-date"/></div>
      </div>
      <button class="action-btn green" onclick="addExpense()">â• Ø¥Ø¶Ø§ÙØ©</button>
    </div>
  </div>
  <div class="panel">
    <div class="panel-header">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
      <button class="action-btn red" onclick="clearMonthExpenses()" style="font-size:11px;padding:5px 10px">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø´Ù‡Ø±</button>
    </div>
    <div class="panel-body">
      <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
        <div style="position:relative;flex:1;min-width:160px">
          <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text2);font-size:14px">ğŸ”</span>
          <input class="inp" type="text" id="exp-search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„ÙˆØµÙ..." oninput="filterExpenses()" style="padding-right:32px"/>
        </div>
        <select class="inp" id="exp-filter-cat" onchange="filterExpenses()" style="width:auto;min-width:130px">
          <option value="">ğŸ—‚ï¸ ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>
          <option>ÙƒØ±Ø§Ø¡</option><option>Ù…Ø§Ø¡ ÙˆÙƒÙ‡Ø±Ø¨Ø§Ø¡</option><option>ÙˆØ§ÙŠ ÙØ§ÙŠ</option>
          <option>ØªØ±Ù†Ø³Ø¨ÙˆØ±</option><option>ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</option><option>Ù…Ø§ÙƒÙ„Ø©</option>
          <option>ØªØ±ÙÙŠÙ‡</option><option>ØµØ­Ø©</option><option>Ù…Ù„Ø§Ø¨Ø³</option>
          <option>Ø§Ø¯Ø®Ø§Ø±</option><option>Ø£Ø®Ø±Ù‰</option>
        </select>
        <button class="btn-sm btn-outline-sm" onclick="clearExpSearch()" id="exp-clear-search" style="display:none">âœ• Ù…Ø³Ø­</button>
      </div>
    </div>
    <div style="overflow-x:auto">
      <table class="tbl">
        <thead><tr><th>#</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø­Ø°Ù</th></tr></thead>
        <tbody id="exp-list"><tr><td colspan="6" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
        <tfoot><tr><td colspan="3" style="padding:10px;font-weight:700">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
        <td colspan="3" style="padding:10px;font-weight:900;color:var(--red)" id="exp-total-foot">-</td></tr></tfoot>
      </table>
    </div>
  </div>
</div>

<!-- â•â• GOALS â•â• -->
<div id="tab-goals" class="section">
  <div class="sec-title">ğŸ¯ Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</div>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­ -->
  <div id="saving-banner" style="background:linear-gradient(135deg,rgba(0,184,148,.12),rgba(74,144,217,.1));border:1px solid rgba(0,184,148,.3);border-radius:14px;padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <div>
      <div style="font-size:11px;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:.5px">ğŸ’° Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
      <div style="font-size:26px;font-weight:900;color:var(--green)" id="avail-saving">-</div>
      <div style="font-size:11px;color:var(--text2)" id="saving-allocated">-</div>
    </div>
    <button class="action-btn green" onclick="openAllocModal()" id="alloc-btn">âš¡ ÙˆØ²Ù‘Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</button>
  </div>

  <!-- Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù -->
  <div class="panel">
    <div class="panel-header">â• Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯</div>
    <div class="panel-body">
      <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹ -->
      <div style="margin-bottom:14px">
        <label class="lbl">ğŸ¨ Ù†ÙˆØ¹ Ø§Ù„Ù‡Ø¯Ù</label>
        <div class="goal-type-grid" id="goal-type-picker">
          <div class="goal-type-btn selected" data-type="ğŸš—" data-label="Ø³ÙŠØ§Ø±Ø©" onclick="selectGoalType(this)"><span class="type-icon">ğŸš—</span>Ø³ÙŠØ§Ø±Ø©</div>
          <div class="goal-type-btn" data-type="ğŸ " data-label="Ø´Ù‚Ø©" onclick="selectGoalType(this)"><span class="type-icon">ğŸ </span>Ø´Ù‚Ø©</div>
          <div class="goal-type-btn" data-type="âœˆï¸" data-label="Ø³ÙØ±" onclick="selectGoalType(this)"><span class="type-icon">âœˆï¸</span>Ø³ÙØ±</div>
          <div class="goal-type-btn" data-type="ğŸ“" data-label="ØªØ¹Ù„ÙŠÙ…" onclick="selectGoalType(this)"><span class="type-icon">ğŸ“</span>ØªØ¹Ù„ÙŠÙ…</div>
          <div class="goal-type-btn" data-type="ğŸ’" data-label="Ø²ÙˆØ§Ø¬" onclick="selectGoalType(this)"><span class="type-icon">ğŸ’</span>Ø²ÙˆØ§Ø¬</div>
          <div class="goal-type-btn" data-type="ğŸ“±" data-label="ØªÙ‚Ù†ÙŠØ©" onclick="selectGoalType(this)"><span class="type-icon">ğŸ“±</span>ØªÙ‚Ù†ÙŠØ©</div>
          <div class="goal-type-btn" data-type="ğŸ¥" data-label="ØµØ­Ø©" onclick="selectGoalType(this)"><span class="type-icon">ğŸ¥</span>ØµØ­Ø©</div>
          <div class="goal-type-btn" data-type="â­" data-label="Ø£Ø®Ø±Ù‰" onclick="selectGoalType(this)"><span class="type-icon">â­</span>Ø£Ø®Ø±Ù‰</div>
        </div>
      </div>
      <div class="form-grid">
        <div><label class="lbl">ğŸ·ï¸ Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù</label><input class="inp" type="text" id="g-name" placeholder="Ù…Ø«Ø§Ù„: Ø³ÙŠØ§Ø±Ø© Dream..."/></div>
        <div><label class="lbl">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø¯Ø±Ù‡Ù…)</label><input class="inp" type="number" id="g-amt" placeholder="Ù…Ø«Ø§Ù„: 80000" oninput="updateGoalPreview()"/></div>
<input type="hidden" id="g-saved" value="0"/>
      </div>

      <!-- Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© -->
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div>
            <div class="lbl" style="margin:0">ğŸ“Š ÙƒÙ… % Ù…Ù† Ø§Ø¯Ø®Ø§Ø±Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø¯ÙØŸ</div>
            <div style="font-size:11px;color:var(--text2);margin-top:2px">Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­: <b style="color:var(--green)" id="g-avail-lbl">-</b></div>
          </div>
          <span style="font-size:28px;font-weight:900;color:var(--green)" id="g-pct-display">50%</span>
        </div>
        <input type="range" class="alloc-slider" min="5" max="100" step="5" value="50" id="g-pct" oninput="updateGoalPreview()"/>
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text2);margin-top:2px">
          <span>5%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
        </div>

        <!-- Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ -->
        <div id="goal-preview" style="display:none;margin-top:14px;background:var(--bg4);border-radius:10px;padding:14px">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center">
            <div style="background:rgba(0,184,148,.1);border-radius:8px;padding:10px">
              <div style="font-size:10px;color:var(--text2);font-weight:700;margin-bottom:4px">ğŸ’° Ø´Ù‡Ø±ÙŠØ§Ù‹</div>
              <div style="font-size:15px;font-weight:900;color:var(--green)" id="prev-monthly">-</div>
            </div>
            <div style="background:rgba(253,203,110,.1);border-radius:8px;padding:10px">
              <div style="font-size:10px;color:var(--text2);font-weight:700;margin-bottom:4px">ğŸ“… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±</div>
              <div style="font-size:15px;font-weight:900;color:var(--gold)" id="prev-months">-</div>
            </div>
            <div style="background:rgba(74,144,217,.1);border-radius:8px;padding:10px">
              <div style="font-size:10px;color:var(--text2);font-weight:700;margin-bottom:4px">ğŸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
              <div style="font-size:12px;font-weight:900;color:var(--blue)" id="prev-date">-</div>
            </div>
          </div>
          <div style="text-align:center;margin-top:10px;font-size:12px;color:var(--text2)" id="prev-remaining-lbl"></div>
        </div>
      </div>

      <input type="hidden" id="g-months" value="0"/>
      <button class="action-btn green" onclick="addGoal()">ğŸ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø¯Ù</button>
    </div>
  </div>

  <div id="goals-list"><div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
</div>

<!-- â•â• ANNUAL â•â• -->
<div id="tab-annual" class="section">
  <div class="sec-title">ğŸ“… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ</div>
  <div class="cards-grid" id="annual-cards"></div>
  <div class="grid-2">
    <div class="panel"><div class="panel-header">ğŸ“ˆ Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <div class="panel-body"><div class="chart-wrap"><canvas id="chartBar"></canvas></div></div></div>
    <div class="panel"><div class="panel-header">ğŸ’° ØªØ·ÙˆØ± Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</div>
      <div class="panel-body"><div class="chart-wrap"><canvas id="chartLine"></canvas></div></div></div>
  </div>
  <div class="panel"><div class="panel-header">ğŸ“Š Ø´Ù‡Ø± Ø¨Ø´Ù‡Ø±</div>
    <div class="panel-body" style="overflow-x:auto"><table class="tbl" id="annual-tbl"></table></div></div>
</div>

<!-- â•â• SETTINGS â•â• -->
<!-- â•â• STATS â•â• -->
<div id="tab-stats" class="section">
  <div class="sec-title">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</div>

  <!-- ÙƒØ§Ø±Ø¯Ø§Øª Ø³Ø±ÙŠØ¹Ø© -->
  <div class="cards-grid" id="stats-cards"></div>

  <div class="stats-grid">
    <!-- ØªØ·ÙˆØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø´Ù‡Ø±ÙŠØ§Ù‹ -->
    <div class="stat-panel">
      <div class="stat-title">ğŸ“‰ ØªØ·ÙˆØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±)</div>
      <div class="chart-wrap-sm"><canvas id="chartTrend"></canvas></div>
    </div>
    <!-- Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø± -->
    <div class="stat-panel">
      <div class="stat-title">ğŸ’° Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</div>
      <div class="chart-wrap-sm"><canvas id="chartSaving"></canvas></div>
    </div>
    <!-- Ø£ÙƒØ«Ø± ÙØ¦Ø© Ù…ØµØ§Ø±ÙŠÙ -->
    <div class="stat-panel">
      <div class="stat-title">ğŸ† Ø£ÙƒØ«Ø± Ø§Ù„ÙØ¦Ø§Øª Ø¥Ù†ÙØ§Ù‚Ø§Ù‹ (Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©)</div>
      <div class="chart-wrap-sm"><canvas id="chartTopCats"></canvas></div>
    </div>
    <!-- Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¯Ø®Ù„ vs Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ -->
    <div class="stat-panel">
      <div class="stat-title">âš–ï¸ Ø§Ù„Ø¯Ø®Ù„ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <div class="chart-wrap-sm"><canvas id="chartCompare"></canvas></div>
    </div>
  </div>

  <!-- ØªØ­Ù„ÙŠÙ„ Ù†ØµÙŠ -->
  <div class="panel">
    <div class="panel-header">ğŸ§  ØªØ­Ù„ÙŠÙ„ Ù…Ø§Ù„ÙŠ</div>
    <div class="panel-body" id="stats-analysis" style="font-size:13px;line-height:2;color:var(--text2)">
      Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø§Ø´ ÙŠØªÙˆÙ„Ù‘Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„...
    </div>
  </div>
</div>

<div id="tab-settings" class="section">
  <div class="sec-title">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>

  <!-- Ø¨Ø§Ù†ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© -->
  <div class="panel" style="margin-bottom:14px;border:2px solid var(--green)">
    <div class="panel-header" style="background:rgba(0,184,148,0.1)">ğŸ’¾ Ø­ÙØ¸ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
    <div class="panel-body">
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.8">
        âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø§Ù„ØªÙ„ÙÙˆÙ† ÙÙ‚Ø·. Ø§Ø­ÙØ¸Ù‡Ø§ Ø¨Ø§Ù†ØªØ¸Ø§Ù… Ø¨Ø§Ø´ Ù…Ø§ØªØ¶ÙŠØ¹Ø´ Ø¥Ø°Ø§ Ù…Ø³Ø­ØªÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£Ùˆ Ø¨Ø¯Ù„ØªÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø².
      </p>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button id="btn-export" class="action-btn green" onclick="expExcel()" style="flex:1;justify-content:center;min-width:140px">
          ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
        <button class="action-btn" onclick="importData()" style="flex:1;justify-content:center;min-width:140px;background:var(--blue);color:#fff">
          ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
      </div>
      <p style="font-size:11px;color:var(--text2);margin-top:12px">
        ğŸ’¡ Ø§Ù„Ø­ÙØ¸: ÙƒÙŠØ­Ù…Ù‘Ù„ Ù…Ù„Ù JSON ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ &nbsp;|&nbsp; Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: ÙƒÙŠØ±Ø¬Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ù…Ù„Ù Ù…Ø­ÙÙˆØ¸
      </p>
    </div>
  </div>
  <!-- Ø¨Ø§Ù†ÙŠÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ -->
  <div class="panel" style="margin-bottom:14px">
    <div class="panel-header">ğŸ“§ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ø¥ÙŠÙ…ÙŠÙ„</div>
    <div class="panel-body">
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.8">
        Ø§Ø³ØªÙ„Ù… Ù…Ù„Ø®ØµØ§Ù‹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ Ø£ÙˆÙ„ Ø´Ù‡Ø± ÙŠØªØ¶Ù…Ù† Ø¯Ø®Ù„ÙƒØŒ Ù…ØµØ§Ø±ÙŠÙÙƒ ÙˆØ§Ø¯Ø®Ø§Ø±Ùƒ.
      </p>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button class="action-btn green" onclick="openEmailModal()" style="flex:1;justify-content:center;min-width:140px">
          ğŸ“§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
        </button>
        <button class="action-btn" onclick="sendMonthlyEmail()" style="flex:1;justify-content:center;min-width:140px;background:var(--blue);color:#fff">
          ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†
        </button>
      </div>
      <p style="font-size:11px;color:var(--text2);margin-top:10px" id="email-status-lbl"></p>
    </div>
  </div>
      </p>
    </div>
  </div>

  <div class="panel" style="margin-bottom:14px">
    <div class="panel-header">ğŸ”” Ø­Ø¯ÙˆØ¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</div>
    <div class="panel-body">
      <div class="form-grid">
        <div><label class="lbl">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø£Ù‚Ù„ Ù…Ù†</label><input class="inp" type="number" id="s-warn" oninput="saveSettings()" placeholder="1000"/></div>
        <div><label class="lbl">ğŸš¨ Ø®Ø·Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø£Ù‚Ù„ Ù…Ù†</label><input class="inp" type="number" id="s-danger" oninput="saveSettings()" placeholder="500"/></div>
      </div>
    </div>
  </div>
</div>

</main>

<!-- â•â• EDIT GOAL MODAL â•â• -->
<div class="edit-goal-modal" id="editGoalModal">
  <div class="edit-goal-box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div style="font-size:16px;font-weight:900">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ù</div>
      <button class="modal-close" onclick="closeEditGoal()">âœ•</button>
    </div>
    <input type="hidden" id="edit-goal-id"/>
    <div class="auth-field" style="margin-bottom:14px">
      <label class="lbl">Ù†ÙˆØ¹ Ø§Ù„Ù‡Ø¯Ù</label>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:4px" id="edit-type-picker">
        <div class="goal-type-btn selected" data-type="ğŸš—" onclick="selectEditType(this)" style="padding:8px 4px"><span class="type-icon">ğŸš—</span>Ø³ÙŠØ§Ø±Ø©</div>
        <div class="goal-type-btn" data-type="ğŸ " onclick="selectEditType(this)" style="padding:8px 4px"><span class="type-icon">ğŸ </span>Ø´Ù‚Ø©</div>
        <div class="goal-type-btn" data-type="âœˆï¸" onclick="selectEditType(this)" style="padding:8px 4px"><span class="type-icon">âœˆï¸</span>Ø³ÙØ±</div>
        <div class="goal-type-btn" data-type="ğŸ“" onclick="selectEditType(this)" style="padding:8px 4px"><span class="type-icon">ğŸ“</span>ØªØ¹Ù„ÙŠÙ…</div>
        <div class="goal-type-btn" data-type="ğŸ’" onclick="selectEditType(this)" style="padding:8px 4px"><span class="type-icon">ğŸ’</span>Ø²ÙˆØ§Ø¬</div>
        <div class="goal-type-btn" data-type="ğŸ“±" onclick="selectEditType(this)" style="padding:8px 4px"><span class="type-icon">ğŸ“±</span>ØªÙ‚Ù†ÙŠØ©</div>
        <div class="goal-type-btn" data-type="ğŸ¥" onclick="selectEditType(this)" style="padding:8px 4px"><span class="type-icon">ğŸ¥</span>ØµØ­Ø©</div>
        <div class="goal-type-btn" data-type="â­" onclick="selectEditType(this)" style="padding:8px 4px"><span class="type-icon">â­</span>Ø£Ø®Ø±Ù‰</div>
      </div>
    </div>
    <div class="auth-field" style="margin-bottom:14px">
      <label class="lbl">Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù</label>
      <input class="inp" type="text" id="edit-goal-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù"/>
    </div>
    <div class="auth-field" style="margin-bottom:14px">
      <label class="lbl">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø¯Ø±Ù‡Ù…)</label>
      <input class="inp" type="number" id="edit-goal-target" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"/>
    </div>
    <div class="auth-field" style="margin-bottom:20px">
      <label class="lbl">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ø± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† (Ø¯Ø±Ù‡Ù…)</label>
      <input class="inp" type="number" id="edit-goal-saved" placeholder="Ø§Ù„Ù…Ø¯Ø®Ø±"/>
    </div>
    <div style="display:flex;gap:10px">
      <button class="action-btn green" onclick="saveEditGoal()" style="flex:1;justify-content:center">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
      <button class="action-btn" onclick="closeEditGoal()" style="background:var(--bg3);color:var(--text2)">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- â•â• ALLOCATION MODAL â•â• -->
<div class="modal-overlay" id="allocModal">
  <div class="modal-box">
    <div class="modal-header">
      <span>âš¡ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</span>
      <button class="modal-close" onclick="closeAllocModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="background:var(--bg3);border-radius:10px;padding:12px;margin-bottom:16px;text-align:center">
        <div style="font-size:11px;color:var(--text2);font-weight:700">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­</div>
        <div style="font-size:22px;font-weight:900;color:var(--green)" id="modal-total-saving">-</div>
      </div>
      <div id="alloc-rows"></div>
      <div class="alloc-total-bar">
        <div style="font-size:11px;color:var(--text2);font-weight:700;margin-bottom:6px">ğŸ“Š Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…ÙˆØ²Ø¹Ø©</div>
        <div style="font-size:28px;font-weight:900" id="alloc-pct-total">0%</div>
        <div class="prog-bar" style="margin-top:8px;height:10px">
          <div class="prog-fill" id="alloc-prog" style="width:0%;background:var(--green)"></div>
        </div>
        <div style="font-size:12px;color:var(--text2);margin-top:6px" id="alloc-remaining-lbl"></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:16px">
        <button class="action-btn green" style="flex:1;justify-content:center" onclick="applyAllocation()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
        <button class="action-btn outline" onclick="closeAllocModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>
</div>


<script>
// â•â• Ù…Ø§Ù„ÙŠ+ Standalone â€” localStorage â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MONTHS=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆØ²','ØºØ´Øª','Ø´ØªÙ†Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙ†Ø¨Ø±','Ø¯Ø¬Ù†Ø¨Ø±'];
const CAT_COLORS=['#e17055','#fdcb6e','#00b894','#4a90d9','#8b5cf6','#fd79a8','#00cec9','#55efc4','#fab1a0','#6c5ce7','#b2bec3'];
const CATS=['ÙƒØ±Ø§Ø¡','Ù…Ø§Ø¡ ÙˆÙƒÙ‡Ø±Ø¨Ø§Ø¡','ÙˆØ§ÙŠ ÙØ§ÙŠ','ØªØ±Ù†Ø³Ø¨ÙˆØ±','ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©','Ù…Ø§ÙƒÙ„Ø©','ØªØ±ÙÙŠÙ‡','ØµØ­Ø©','Ù…Ù„Ø§Ø¨Ø³','Ø§Ø¯Ø®Ø§Ø±','Ø£Ø®Ø±Ù‰'];
const CAT_ICONS={ÙƒØ±Ø§Ø¡:'ğŸ ','Ù…Ø§Ø¡ ÙˆÙƒÙ‡Ø±Ø¨Ø§Ø¡':'ğŸ’¡','ÙˆØ§ÙŠ ÙØ§ÙŠ':'ğŸ“¶',ØªØ±Ù†Ø³Ø¨ÙˆØ±:'ğŸšŒ','ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©':'ğŸ“š',Ù…Ø§ÙƒÙ„Ø©:'ğŸ›’',ØªØ±ÙÙŠÙ‡:'ğŸ¬',ØµØ­Ø©:'ğŸ¥',Ù…Ù„Ø§Ø¨Ø³:'ğŸ‘”',Ø§Ø¯Ø®Ø§Ø±:'ğŸ’',Ø£Ø®Ø±Ù‰:'ğŸ“Œ'};
let curMonth=new Date().getMonth()+1, curYear=Math.max(2026,new Date().getFullYear());
let incomeData={}, expensesData=[], settingsData={warn_threshold:1000,danger_threshold:500};
let goalsData=[];
let prevMonthExp=0;
let selectedGoalType='ğŸš—';
let pieChart=null,barChart=null,lineChart=null;
let saveIncomeTimer=null, saveSettingsTimer=null;
let monthlyAvgSaving=0;
let realMonthsCount=0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n){return(n||0).toLocaleString('ar-MA')+' Ø¯Ø±Ù‡Ù…';}

function animateCount(el, target, prefix='', suffix=' Ø¯Ø±Ù‡Ù…'){
  const start=0, duration=800, startTime=performance.now();
  function step(now){
    const p=Math.min((now-startTime)/duration,1);
    const ease=p<.5?2*p*p:(4-2*p)*p-1;
    const val=Math.round(start+(target-start)*ease);
    el.textContent=prefix+val.toLocaleString('ar-MA')+suffix;
    if(p<1)requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// â•â• localStorage API â€” ÙŠØ­Ø§ÙƒÙŠ Flask API â•â•
const DB={
  _p(){return currentUser?'u_'+currentUser.email+'_':'_guest_';},
  get(k){try{return JSON.parse(localStorage.getItem(this._p()+k));}catch{return null;}},
  set(k,v){localStorage.setItem(this._p()+k,JSON.stringify(v));},
  del(k){localStorage.removeItem(this._p()+k);},
  keys(prefix=''){const p=this._p();return Object.keys(localStorage).filter(k=>k.startsWith(p+prefix)).map(k=>k.slice(p.length));}
};

async function api(url,method='GET',body=null){
  // income
  if(url.match(/\/api\/income\/(\d+)\/(\d+)/)){
    const[,m,y]=url.match(/\/api\/income\/(\d+)\/(\d+)/);
    const key=`income_${y}_${m}`;
    if(method==='POST'){
      const sal=body.salary||0, b2=body.bonus2_active?body.bonus2:0,
            b6=body.bonus6_active?body.bonus6:0, bi=body.intl_active?body.bonus_intl:0;
      const total=sal+b2+b6+bi+(body.extra||0);
      const rec={...body,total};
      DB.set(key,rec); return rec;
    }
    return DB.get(key)||{};
  }
  // expenses list
  if(url.match(/\/api\/expenses\/(\d+)\/(\d+)/) && method==='GET'){
    const[,m,y]=url.match(/\/api\/expenses\/(\d+)\/(\d+)/);
    return DB.get(`expenses_${y}_${m}`)||[];
  }
  // add expense
  if(url==='/api/expenses' && method==='POST'){
    const[y,m]=body.date.split('-');
    const key=`expenses_${y}_${parseInt(m)}`;
    const list=DB.get(key)||[];
    const rec={...body,id:Date.now()};
    list.push(rec); DB.set(key,list); return rec;
  }
  // delete expense
  if(url.match(/\/api\/expenses\/(\d+)/) && method==='DELETE'){
    const id=parseInt(url.split('/').pop());
    DB.keys('expenses_').forEach(k=>{
      const list=(DB.get(k)||[]).filter(e=>e.id!==id);
      DB.set(k,list);
    }); return {};
  }
  // goals
  if(url==='/api/goals' && method==='GET') return DB.get('goals')||[];
  if(url==='/api/goals' && method==='POST'){
    const list=DB.get('goals')||[];
    const rec={...body,id:Date.now(),type:body.type||'â­',progress_pct:Math.round((body.saved_amount/body.target_amount)*100),monthly_needed:body.target_amount>body.saved_amount?Math.ceil((body.target_amount-body.saved_amount)/body.months):0};
    list.push(rec); DB.set('goals',list); return rec;
  }
  if(url.match(/\/api\/goals\/(\d+)/) && method==='PUT'){
    const id=Number(url.split('/').pop());
    const list=DB.get('goals')||[];
    const idx=list.findIndex(g=>g.id===id);
    if(idx>-1){
      const tgt=body.target_amount||list[idx].target_amount;
      const mths=body.months||list[idx].months||1;
      list[idx]={...list[idx],...body,
        target_amount:tgt,
        type:body.type||list[idx].type||'â­',
        progress_pct:Math.round((body.saved_amount/tgt)*100),
        monthly_needed:tgt>body.saved_amount?Math.ceil((tgt-body.saved_amount)/mths):0
      };
      DB.set('goals',list);
    } return list[idx]||{};
  }
  if(url.match(/\/api\/goals\/(\d+)/) && method==='DELETE'){
    const id=Number(url.split('/').pop());
    const filtered=(DB.get('goals')||[]).filter(g=>Number(g.id)!==id);
    DB.set('goals',filtered); return {};
  }
  // settings
  if(url==='/api/settings' && method==='GET') return DB.get('settings')||{warn_threshold:1000,danger_threshold:500};
  if(url==='/api/settings' && method==='POST'){DB.set('settings',body);return body;}
  // annual
  if(url.match(/\/api\/annual\/(\d+)/)){
    const[,y]=url.match(/\/api\/annual\/(\d+)/);
    return Array.from({length:12},(_,i)=>{
      const m=i+1;
      const inc=DB.get(`income_${y}_${m}`)||{};
      const exps=DB.get(`expenses_${y}_${m}`)||[];
      const expenses=exps.reduce((s,e)=>s+e.amount,0);
      const income=inc.total||0;
      return{month:m,income,expenses,remaining:income-expenses};
    });
  }
  // logout
  if(url==='/api/logout') return {};
  // export
  if(url.match(/\/api\/export/)) return null;
  console.warn('API not handled:',url); return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH â€” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â• SHA-256 password hashing â•â•
async function hashPass(pass){
  const enc = new TextEncoder().encode(pass + 'mali_salt_2026');
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SMART ML GREETING ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function buildSmartGreeting(){
  const card = document.getElementById('greeting-card');
  const helloEl = document.getElementById('greeting-hello');
  const timeEl = document.getElementById('greeting-time');
  const insightsEl = document.getElementById('greeting-insights');

  // â”€â”€ ÙˆÙ‚Øª Ø§Ù„ÙŠÙˆÙ… â”€â”€
  const h = new Date().getHours();
  const timeLabel = h < 5 ? 'Ù„ÙŠÙ„Ø© Ø·ÙŠØ¨Ø©' : h < 12 ? 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±' : h < 17 ? 'Ù…Ø±Ø­Ø¨Ø§Ù‹' : h < 21 ? 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±' : 'Ù„ÙŠÙ„Ø© Ø·ÙŠØ¨Ø©';
  const name = currentUser ? currentUser.email.split('@')[0] : 'ØµØ¯ÙŠÙ‚';
  helloEl.innerHTML = `${timeLabel}ØŒ <span>${name}</span> ğŸ‘‹`;

  const now = new Date();
  timeEl.textContent = now.toLocaleDateString('ar-MA', {weekday:'long', day:'numeric', month:'long'});

  // â”€â”€ Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª 6 Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠØ© â”€â”€
  const months = [];
  for(let i = 0; i < 6; i++){
    let m = curMonth - i;
    let y = curYear;
    if(m <= 0){ m += 12; y--; }
    const inc = DB.get(`income_${y}_${m}`) || {};
    const exps = DB.get(`expenses_${y}_${m}`) || [];
    const totalInc = inc.total || 0;
    const totalExp = exps.reduce((s,e) => s + e.amount, 0);
    const saving = totalInc - totalExp;
    const catMap = {};
    exps.forEach(e => { catMap[e.category] = (catMap[e.category]||0) + e.amount; });
    months.push({ m, y, income: totalInc, expenses: totalExp, saving, catMap, exps });
  }

  const insights = [];
  const activeMonths = months.filter(m => m.income > 0);
  if(activeMonths.length === 0){
    insightsEl.innerHTML = '<div class="greeting-no-data">ğŸŒ± Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®Ù„Ùƒ ÙˆÙ…ØµØ§Ø±ÙŠÙÙƒ Ù„ØªØ¸Ù‡Ø± Ù„Ùƒ ØªØ­Ø§Ù„ÙŠÙ„ Ø°ÙƒÙŠØ© Ù‡Ù†Ø§</div>';
    card.style.display = 'block';
    return;
  }

  const curData = months[0];
  const prevData = months[1];

  // â•â• 1. LINEAR REGRESSION â€” ØªÙˆÙ‚Ø¹ Ù…ØµØ§Ø±ÙŠÙ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± â•â•
  if(curData.exps.length >= 3){
    const today = now.getDate();
    const daysInMonth = new Date(curYear, curMonth, 0).getDate();
    const dailyRate = curData.expenses / today;
    const projected = Math.round(dailyRate * daysInMonth);
    const diff = projected - curData.expenses;
    const remaining = projected - curData.expenses;
    if(today < 28 && diff > 500){
      const overIncome = projected > curData.income;
      insights.push({
        icon: overIncome ? 'ğŸš¨' : 'ğŸ“Š',
        badge: overIncome ? {text:'ØªØ­Ø°ÙŠØ±', cls:'up'} : {text:'ØªÙˆÙ‚Ø¹', cls:'warn'},
        text: `Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØªÙŠØ±Ø© Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ <b>Ù…ØµØ§Ø±ÙŠÙÙƒ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±: ${fmt(projected)}</b>${overIncome ? ' â€” Ø³ØªØªØ¬Ø§ÙˆØ² Ø¯Ø®Ù„Ùƒ!' : ` (+${fmt(diff)} Ø¹Ù„Ù‰ Ù…Ø§ ØµØ±ÙØªÙˆ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†)`}`
      });
    }
  }

  // â•â• 2. ANOMALY DETECTION â€” ÙƒØ´Ù Ø´Ù‡Ø± ØºØ±ÙŠØ¨ â•â•
  if(activeMonths.length >= 3){
    const expValues = activeMonths.slice(1).map(m => m.expenses).filter(v => v > 0);
    if(expValues.length >= 2){
      const mean = expValues.reduce((s,v) => s+v, 0) / expValues.length;
      const variance = expValues.reduce((s,v) => s + Math.pow(v-mean,2), 0) / expValues.length;
      const std = Math.sqrt(variance);
      const curExp = curData.expenses;
      const zScore = std > 0 ? (curExp - mean) / std : 0;
      if(zScore > 1.5 && curExp > mean + 500){
        insights.push({
          icon: 'âš¡',
          badge: {text: '+' + Math.round(zScore*10)/10 + ' Ïƒ', cls:'up'},
          text: `Ù…ØµØ§Ø±ÙŠÙ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± (${fmt(curExp)}) <b>Ø£Ø¹Ù„Ù‰ Ø¨ÙƒØ«ÙŠØ± Ù…Ù† Ù…Ø¹Ø¯Ù„Ùƒ Ø§Ù„Ø¹Ø§Ø¯ÙŠ</b> (${fmt(Math.round(mean))}) â€” Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ù†ÙÙ‚Ø© Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©ØŸ`
        });
      } else if(zScore < -1.5 && curExp < mean - 300){
        insights.push({
          icon: 'ğŸŒŸ',
          badge: {text:'Ù…Ù…ØªØ§Ø²', cls:'good'},
          text: `Ù…ØµØ§Ø±ÙŠÙ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± (${fmt(curExp)}) <b>Ø£Ù‚Ù„ Ù…Ù† Ù…Ø¹Ø¯Ù„Ùƒ Ø¨Ø´ÙƒÙ„ Ù„Ø§ÙØª</b> (${fmt(Math.round(mean))}) â€” Ø¥Ù†ÙØ§Ù‚ Ø°ÙƒÙŠ! ğŸ‰`
        });
      }
    }
  }

  // â•â• 3. SAVING TREND â€” Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± (slope) â•â•
  if(activeMonths.length >= 4){
    const savingRates = activeMonths.slice(0,4).filter(m=>m.income>0)
      .map(m => m.income > 0 ? (m.saving/m.income)*100 : 0).reverse();
    if(savingRates.length >= 3){
      const n = savingRates.length;
      const xMean = (n-1)/2;
      const yMean = savingRates.reduce((s,v)=>s+v,0)/n;
      let num=0, den=0;
      savingRates.forEach((y,x)=>{ num+=(x-xMean)*(y-yMean); den+=(x-xMean)**2; });
      const slope = den !== 0 ? num/den : 0;
      const latestRate = Math.round(savingRates[savingRates.length-1]);
      if(slope > 1.5){
        insights.push({
          icon: 'ğŸ“ˆ',
          badge: {text: '+' + Math.round(slope*10)/10 + '%/Ø´Ù‡Ø±', cls:'good'},
          text: `Ù†Ø³Ø¨Ø© Ø§Ø¯Ø®Ø§Ø±Ùƒ ÙÙŠ <b>Ø§Ø±ØªÙØ§Ø¹ Ù…Ø³ØªÙ…Ø±</b> Ø®Ù„Ø§Ù„ 4 Ø£Ø´Ù‡Ø± â€” Ù…Ø¹Ø¯Ù„Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ${latestRate}% ÙˆØ§ØªØ¬Ø§Ù‡Ùƒ Ù…Ù…ØªØ§Ø²!`
        });
      } else if(slope < -1.5){
        insights.push({
          icon: 'ğŸ“‰',
          badge: {text: Math.round(slope*10)/10 + '%/Ø´Ù‡Ø±', cls:'up'},
          text: `Ù†Ø³Ø¨Ø© Ø§Ø¯Ø®Ø§Ø±Ùƒ <b>ØªÙ†Ø®ÙØ¶ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹</b> Ù…Ù†Ø° ${n} Ø£Ø´Ù‡Ø± â€” Ù…Ø¹Ø¯Ù„Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ${latestRate}%. Ø®Ø§ØµÙƒ ØªØ±Ø§Ø¬Ø¹ Ù…ØµØ§Ø±ÙŠÙÙƒ.`
        });
      }
    }
  }

  // â•â• 4. CATEGORY CLUSTERING â€” Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ù…ÙˆØ§Ù‹ â•â•
  if(prevData && prevData.income > 0 && curData.income > 0){
    const allCats = new Set([...Object.keys(curData.catMap), ...Object.keys(prevData.catMap)]);
    let maxGrowthCat = null, maxGrowth = 0;
    allCats.forEach(cat => {
      const cur = curData.catMap[cat] || 0;
      const prev = prevData.catMap[cat] || 0;
      if(prev > 200 && cur > prev){
        const growth = ((cur-prev)/prev)*100;
        if(growth > maxGrowth){ maxGrowth = growth; maxGrowthCat = cat; }
      }
    });
    if(maxGrowthCat && maxGrowth > 20){
      const cur = curData.catMap[maxGrowthCat];
      const prev = prevData.catMap[maxGrowthCat];
      insights.push({
        icon: 'ğŸ”',
        badge: {text: '+' + Math.round(maxGrowth) + '%', cls:'warn'},
        text: `ÙØ¦Ø© <b>${maxGrowthCat}</b> Ø²Ø§Ø¯Øª Ø¨Ù€ <b>${Math.round(maxGrowth)}%</b> Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ (${fmt(prev)} â† ${fmt(cur)})`
      });
    }
  }

  // â•â• 5. GOAL COMPLETION FORECAST â•â•
  if(goalsData.length > 0 && activeMonths.length >= 2){
    const avgSaving = activeMonths.filter(m=>m.saving>0).reduce((s,m)=>s+m.saving,0) / Math.max(activeMonths.filter(m=>m.saving>0).length,1);
    const closest = goalsData.filter(g=>g.target_amount>g.saved_amount)
      .sort((a,b)=>(a.target_amount-a.saved_amount)-(b.target_amount-b.saved_amount))[0];
    if(closest && avgSaving > 0){
      const remaining = closest.target_amount - closest.saved_amount;
      const monthsLeft = Math.ceil(remaining / avgSaving);
      const target = new Date(); target.setMonth(target.getMonth() + monthsLeft);
      const targetStr = target.toLocaleDateString('ar-MA',{month:'long',year:'numeric'});
      insights.push({
        icon: 'ğŸ¯',
        badge: {text: monthsLeft + ' Ø´Ù‡Ø±', cls: monthsLeft <= 3 ? 'good' : 'warn'},
        text: `Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„ Ø§Ø¯Ø®Ø§Ø±Ùƒ (${fmt(Math.round(avgSaving))}/Ø´Ù‡Ø±)ØŒ <b>Ù‡Ø¯Ù "${closest.type} ${closest.name}"</b> Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥Ù†Ø¬Ø§Ø² ÙÙŠ ${targetStr}`
      });
    }
  }

  // â•â• fallback Ù„Ùˆ Ù…Ø§ ÙƒØ§ÙŠÙ† Ø¥ÙŠØ´ Ù†Ù‚ÙˆÙ„ â•â•
  if(insights.length === 0 && curData.income > 0){
    const pct = curData.income > 0 ? Math.round((curData.saving/curData.income)*100) : 0;
    insights.push({
      icon: pct >= 20 ? 'ğŸŒŸ' : pct >= 10 ? 'ğŸ‘' : 'ğŸ’¡',
      badge: null,
      text: `Ù†Ø³Ø¨Ø© Ø§Ø¯Ø®Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± <b>${pct}%</b> ${pct >= 20 ? 'â€” Ù…Ù…ØªØ§Ø²ØŒ Ø§Ø³ØªÙ…Ø±!' : pct >= 10 ? 'â€” Ø¬ÙŠØ¯ØŒ Ø­Ø§ÙˆÙ„ ØªÙˆØµÙ„ Ù„Ù€ 20%' : 'â€” Ø®Ø§ØµÙƒ ØªØ±Ø§Ø¬Ø¹ Ù…ØµØ§Ø±ÙŠÙÙƒ'}`
    });
  }

  // â•â• Render â•â•
  insightsEl.innerHTML = insights.slice(0,3).map(ins => `
    <div class="g-insight">
      <span class="g-insight-icon">${ins.icon}</span>
      <span class="g-insight-text">
        ${ins.badge ? `<span class="g-badge ${ins.badge.cls}">${ins.badge.text}</span>` : ''}
        ${ins.text}
      </span>
    </div>
  `).join('');

  card.style.display = 'block';
}
// â•â• FORGOT PASSWORD â•â•
let forgotUserEmail = '';

function forgotStep1(){
  const email = document.getElementById('forgot-email').value.trim();
  const errEl = document.getElementById('forgot-err');
  errEl.className='auth-err';
  if(!email){ errEl.textContent='âš ï¸ Ø£Ø¯Ø®Ù„ Ø¥ÙŠÙ…ÙŠÙ„Ùƒ'; errEl.className='auth-err show'; return; }
  const users = JSON.parse(localStorage.getItem('mali_users')||'{}');
  const user = users[email];
  if(!user){ errEl.textContent='âŒ Ù‡Ø§Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø§ Ù…Ø³Ø¬Ù„Ø´'; errEl.className='auth-err show'; return; }
  if(!user.question){ errEl.textContent='âŒ Ù‡Ø§Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø§ Ø¹Ù†Ø¯ÙˆØ´ Ø³Ø¤Ø§Ù„ Ø³Ø±ÙŠ â€” Ù…Ø³ØªØ­ÙŠÙ„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±'; errEl.className='auth-err show'; return; }
  forgotUserEmail = email;
  document.getElementById('forgot-question-lbl').textContent = 'ğŸ” ' + user.question;
  document.getElementById('forgot-step1').style.display='none';
  document.getElementById('forgot-step2').style.display='block';
}

function forgotStep2(){
  const answer = document.getElementById('forgot-answer-inp').value.trim().toLowerCase();
  const errEl = document.getElementById('forgot-err');
  errEl.className='auth-err';
  if(!answer){ errEl.textContent='âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¬ÙˆØ§Ø¨'; errEl.className='auth-err show'; return; }
  const users = JSON.parse(localStorage.getItem('mali_users')||'{}');
  const user = users[forgotUserEmail];
  hashPass(answer).then(hashedAns => {
    if(hashedAns !== user.answer){
      errEl.textContent='âŒ Ø§Ù„Ø¬ÙˆØ§Ø¨ ØºÙ„Ø·'; errEl.className='auth-err show'; return;
    }
    document.getElementById('forgot-step2').style.display='none';
    document.getElementById('forgot-step3').style.display='block';
  });
}

function forgotStep3(){
  const newpass = document.getElementById('forgot-newpass').value;
  const newpass2 = document.getElementById('forgot-newpass2').value;
  const errEl = document.getElementById('forgot-err');
  errEl.className='auth-err';
  if(newpass.length < 6){ errEl.textContent='âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§ØµÙ‡Ø§ 6 Ø­Ø±ÙˆÙ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'; errEl.className='auth-err show'; return; }
  if(newpass !== newpass2){ errEl.textContent='âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ø§ ØªØ·Ø§Ø¨Ù‚ØªØ´'; errEl.className='auth-err show'; return; }
  const users = JSON.parse(localStorage.getItem('mali_users')||'{}');
  hashPass(newpass).then(hashed => {
    users[forgotUserEmail].pass = hashed;
    localStorage.setItem('mali_users', JSON.stringify(users));
    switchAuthTab('login');
    showToast('âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±!');
  });
}
let authMode = 'login'; // login | register
let currentUser = null;

function initAuth(){
  const saved = localStorage.getItem('mali_session');
  if(saved){
    try{
      currentUser = JSON.parse(saved);
      showApp();
    } catch(e){ showAuthOverlay(); }
  } else {
    showAuthOverlay();
  }
}

function showAuthOverlay(){
  document.getElementById('authOverlay').style.display='flex';
}

function showApp(){
  document.getElementById('authOverlay').style.display='none';
  const badge = document.getElementById('user-badge');
  if(badge && currentUser) badge.textContent = 'ğŸ‘¤ ' + currentUser.email.split('@')[0];
  // Ù†Ø³ØªÙ†ÙŠ loadAll ØªØ®Ù„Øµ Ø¨Ø§Ø´ ØªÙƒÙˆÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø§Ù‡Ø²Ø©
  setTimeout(buildSmartGreeting, 800);
}

function switchAuthTab(mode){
  authMode = mode;
  const mainForm = document.querySelector('.auth-card > *:not(#auth-forgot-panel)');
  const forgotPanel = document.getElementById('auth-forgot-panel');
  const mainContent = ['auth-logo-big','auth-tagline','.auth-tabs','auth-err','auth-email',
    'auth-pass','auth-pass2-wrap','auth-question-wrap','auth-answer-wrap','auth-submit-btn','auth-forgot-link']
    .map(id=>id.startsWith('.')?document.querySelector(id):document.getElementById(id))
    .filter(Boolean);

  if(mode === 'forgot'){
    mainContent.forEach(el=>el.style.display='none');
    forgotPanel.style.display='block';
    // reset steps
    document.getElementById('forgot-step1').style.display='block';
    document.getElementById('forgot-step2').style.display='none';
    document.getElementById('forgot-step3').style.display='none';
    document.getElementById('forgot-err').className='auth-err';
    document.getElementById('forgot-email').value='';
    return;
  }

  forgotPanel.style.display='none';
  mainContent.forEach(el=>el.style.display='');
  // fix specific display types
  document.getElementById('auth-err').style.display='';
  document.getElementById('auth-forgot-link').style.display = mode==='login'?'':'none';

  document.getElementById('tab-login-btn').className = 'auth-tab' + (mode==='login'?' active':'');
  document.getElementById('tab-reg-btn').className = 'auth-tab' + (mode==='register'?' active':'');
  document.getElementById('auth-pass2-wrap').style.display = mode==='register'?'block':'none';
  document.getElementById('auth-question-wrap').style.display = mode==='register'?'block':'none';
  document.getElementById('auth-answer-wrap').style.display = mode==='register'?'block':'none';
  document.getElementById('auth-submit-btn').textContent = mode==='login'?'Ø¯Ø®ÙˆÙ„':'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
  document.getElementById('auth-err').className='auth-err';
}

function authSubmit(){
  const email = document.getElementById('auth-email').value.trim();
  const pass  = document.getElementById('auth-pass').value;
  const errEl = document.getElementById('auth-err');

  errEl.className='auth-err';

  if(!email || !pass){
    errEl.textContent='âš ï¸ Ø®Ø§ØµÙƒ ØªØ¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±'; errEl.className='auth-err show'; return;
  }
  if(!email.includes('@')){
    errEl.textContent='âš ï¸ Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­'; errEl.className='auth-err show'; return;
  }

  const users = JSON.parse(localStorage.getItem('mali_users')||'{}');

  if(authMode === 'register'){
    const pass2 = document.getElementById('auth-pass2').value;
    if(pass !== pass2){
      errEl.textContent='âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ø§ ØªØ·Ø§Ø¨Ù‚ØªØ´'; errEl.className='auth-err show'; return;
    }
    if(pass.length < 6){
      errEl.textContent='âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§ØµÙ‡Ø§ ØªÙƒÙˆÙ† 6 Ø­Ø±ÙˆÙ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'; errEl.className='auth-err show'; return;
    }
    if(users[email]){
      errEl.textContent='âŒ Ù‡Ø§Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„'; errEl.className='auth-err show'; return;
    }
    const question = document.getElementById('auth-question').value;
    const answer = document.getElementById('auth-answer').value.trim().toLowerCase();
    if(!question){ errEl.textContent='âš ï¸ Ø§Ø®ØªØ± Ø³Ø¤Ø§Ù„ Ø³Ø±ÙŠ'; errEl.className='auth-err show'; return; }
    if(!answer){ errEl.textContent='âš ï¸ Ø®Ø§ØµÙƒ ØªÙƒØªØ¨ Ø¬ÙˆØ§Ø¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠ'; errEl.className='auth-err show'; return; }
    Promise.all([hashPass(pass), hashPass(answer)]).then(([hashed, hashedAns]) => {
      users[email] = { email, pass: hashed, question, answer: hashedAns };
      localStorage.setItem('mali_users', JSON.stringify(users));
      currentUser = { email };
      localStorage.setItem('mali_session', JSON.stringify(currentUser));
      showApp();
      showToast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!');
    });

  } else {
    // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
    const user = users[email];
    if(!user){ errEl.textContent='âŒ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙ„Ø·'; errEl.className='auth-err show'; return; }
    hashPass(pass).then(hashed => {
      if(hashed !== user.pass){
        errEl.textContent='âŒ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙ„Ø·'; errEl.className='auth-err show'; return;
      }
      currentUser = { email };
      localStorage.setItem('mali_session', JSON.stringify(currentUser));
      showApp();
      showToast('âœ… Ù…Ø±Ø­Ø¨Ø§Ù‹ ' + email.split('@')[0] + '!');
    });
  }
}

function doLogout(){
  if(!confirm('ÙˆØ§Ø´ ØªØ¨ØºÙŠ ØªØ®Ø±Ø¬ØŸ')) return;
  localStorage.removeItem('mali_session');
  currentUser = null;
  document.getElementById('auth-email').value='';
  document.getElementById('auth-pass').value='';
  document.getElementById('auth-pass2').value='';
  switchAuthTab('login');
  showAuthOverlay();
}

// Ø¥Ø¶Ø§ÙØ© Enter key support
document.addEventListener('keydown', e => {
  if(e.key==='Enter' && document.getElementById('authOverlay').style.display!=='none'){
    authSubmit();
  }
});

// â•â• RIPPLE EFFECT â•â•
document.addEventListener('click', e => {
  const btn = e.target.closest('.action-btn, .btn-sm, .btn');
  if(!btn) return;
  const r = document.createElement('span');
  const rect = btn.getBoundingClientRect();
  const size = Math.max(rect.width, rect.height) * 1.5;
  r.style.cssText = `position:absolute;border-radius:50%;background:rgba(255,255,255,.15);width:${size}px;height:${size}px;left:${e.clientX-rect.left-size/2}px;top:${e.clientY-rect.top-size/2}px;transform:scale(0);animation:rippleAnim .5s ease-out forwards;pointer-events:none;`;
  btn.appendChild(r);
  setTimeout(()=>r.remove(), 600);
});

// â•â• NUMBER FLASH on card value change â•â•
function flashCardValue(el) {
  el.classList.remove('flash');
  void el.offsetWidth;
  el.classList.add('flash');
  setTimeout(()=>el.classList.remove('flash'), 400);
}

// â•â• ENHANCED TOAST â•â•
function showToast(msg, type='success'){
  const old = document.getElementById('mali-toast');
  if(old) old.remove();
  const t = document.createElement('div');
  const colors = { success:'var(--green)', error:'var(--red)', info:'var(--blue)' };
  const color = colors[type]||colors.success;
  t.id='mali-toast';
  t.style.cssText=`position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid ${color};color:var(--text);padding:12px 24px;border-radius:12px;font-size:13px;font-weight:700;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,.4),0 0 0 1px ${color}22;animation:toastIn .35s cubic-bezier(.22,1,.36,1) both;white-space:nowrap;`;
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>{
    t.style.animation='toastOut .3s ease forwards';
    setTimeout(()=>t.remove(),300);
  },2400);
}

// â•â• TAB SWITCH â€” stagger children â•â•
const _origShowTab = typeof showTab === 'function' ? showTab : null;
function showTab(name){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  const sec = document.getElementById('tab-'+name);
  if(sec){
    sec.classList.add('active');
    // stagger panels
    sec.querySelectorAll('.panel, .card').forEach((el,i)=>{
      el.style.animationDelay = (i*0.06)+'s';
    });
  }
  const tab = document.querySelector(`.nav-tab[onclick*="${name}"]`);
  if(tab) tab.classList.add('active');
}

// â•â• Edit goal type picker â•â•
let editGoalType = 'â­';
function selectEditType(el){
  document.querySelectorAll('#edit-type-picker .goal-type-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
  editGoalType = el.dataset.type;
}


// â•â• Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ â•â•
function renderWeekSummary(){
  const now = new Date();
  const dayOfWeek = now.getDay(); // 0=Ø£Ø­Ø¯
  const startOfWeek = new Date(now);
  startOfWeek.setDate(now.getDate() - dayOfWeek);
  startOfWeek.setHours(0,0,0,0);

  const weekExps = expensesData.filter(e=>{
    const d = new Date(e.date);
    return d >= startOfWeek;
  });

  const el = document.getElementById('week-summary');
  if(!weekExps.length){ if(el) el.style.display='none'; return; }

  const total = weekExps.reduce((s,e)=>s+e.amount,0);
  const catMap = {};
  weekExps.forEach(e=>{catMap[e.category]=(catMap[e.category]||0)+e.amount;});
  const topCat = Object.entries(catMap).sort((a,b)=>b[1]-a[1])[0];

  if(el){
    el.style.display='flex';
    document.getElementById('week-total').textContent=fmt(total);
    document.getElementById('week-count').textContent=`${weekExps.length} Ø¹Ù…Ù„ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹`;
    document.getElementById('week-top-cat').textContent=topCat ? (CAT_ICONS[topCat[0]]||'') + ' ' + topCat[0] : '-';
  }
}

// â•â• Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ â•â•
async function importLastMonth(){
  const prevM = curMonth===1?12:curMonth-1;
  const prevY = curMonth===1?curYear-1:curYear;
  const lastExps = DB.get(`expenses_${prevY}_${prevM}`) || [];

  if(!lastExps.length){
    showToast('âš ï¸ Ù…Ø§ ÙƒØ§ÙŠÙ† Ù…ØµØ§Ø±ÙŠÙ ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ','error');
    return;
  }

  // Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙÙ‚Ø· (Ø§Ù„ÙƒØ±Ø§Ø¡ØŒ Ù…Ø§Ø¡ØŒ ÙˆØ§ÙŠ ÙØ§ÙŠØŒ ØªØ¹Ù„ÙŠÙ…)
  const fixedCats = ['ÙƒØ±Ø§Ø¡','Ù…Ø§Ø¡ ÙˆÙƒÙ‡Ø±Ø¨Ø§Ø¡','ÙˆØ§ÙŠ ÙØ§ÙŠ','ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©'];
  const fixedExps = lastExps.filter(e=>fixedCats.includes(e.category));

  if(!fixedExps.length){
    showToast('âš ï¸ Ù…Ø§ ÙƒØ§ÙŠÙ† Ù…ØµØ§Ø±ÙŠÙ Ø«Ø§Ø¨ØªØ© ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ','error');
    return;
  }

  const list = fixedExps.map(e=>` â€¢ ${CAT_ICONS[e.category]||''} ${e.category}: ${e.amount.toLocaleString()} Ø¯Ø±Ù‡Ù…`).join('\n');
  if(!confirm(`ğŸ“‹ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„ØªØ§Ù„ÙŠØ©:\n${list}\n\nÙˆØ§Ø´ ØªØ¨ØºÙŠ ØªÙƒÙ…Ù„ØŸ`)) return;

  const today = `${curYear}-${String(curMonth).padStart(2,'0')}-01`;
  for(const e of fixedExps){
    await api('/api/expenses','POST',{
      category:e.category, description:e.description||'â€”',
      amount:e.amount, date:today
    });
  }
  await loadExpenses();
  renderDashboard();
  showToast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${fixedExps.length} Ù…ØµØ§Ø±ÙŠÙ Ø«Ø§Ø¨ØªØ© Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ!`);
}

// â•â• Swipe to delete (mobile) â•â•
function initSwipeDelete(){
  let startX=0, startY=0, target=null, swipeEl=null;

  document.addEventListener('touchstart', e=>{
    const row = e.target.closest('#exp-list tr');
    if(!row) return;
    startX=e.touches[0].clientX;
    startY=e.touches[0].clientY;
    target=row;
  }, {passive:true});

  document.addEventListener('touchmove', e=>{
    if(!target) return;
    const dx=e.touches[0].clientX-startX;
    const dy=e.touches[0].clientY-startY;
    if(Math.abs(dy)>Math.abs(dx)) return; // scroll Ø¹Ù…ÙˆØ¯ÙŠ
    if(dx<-30){
      target.style.transform=`translateX(${Math.max(dx,-80)}px)`;
      target.style.background='rgba(225,112,85,.1)';
      target.style.transition='none';
    }
  }, {passive:true});

  document.addEventListener('touchend', e=>{
    if(!target) return;
    const dx=e.changedTouches[0].clientX-startX;
    if(dx<-60){
      // Ø­Ø°Ù
      target.style.transition='transform .3s, opacity .3s';
      target.style.transform='translateX(-100%)';
      target.style.opacity='0';
      const btn=target.querySelector('[onclick^="delExpense"]');
      if(btn) setTimeout(()=>btn.click(),300);
    } else {
      target.style.transition='transform .3s';
      target.style.transform='translateX(0)';
      target.style.background='';
    }
    target=null;
  }, {passive:true});
}

document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('selMonth').value=curMonth;
  document.getElementById('selYear').value=curYear;
  document.getElementById('exp-date').value=new Date().toISOString().split('T')[0];
  checkAutoEmail();
  loadAll();
});

function changeMonth(){
  curMonth=parseInt(document.getElementById('selMonth').value);
  curYear=parseInt(document.getElementById('selYear').value);
  loadAll();
}

async function loadAll(){
  const prevM=curMonth===1?12:curMonth-1;
  const prevY=curMonth===1?curYear-1:curYear;
  const [,,prevExps]=await Promise.all([
    loadIncome(), loadExpenses(), api(`/api/expenses/${prevM}/${prevY}`), loadSettings()
  ]);
  prevMonthExp=((prevExps)||[]).reduce((s,e)=>s+e.amount,0);
  try{await refreshAnnualAvg();}catch(e){}
  renderDashboard();
  updateGoalPreview();
  buildSmartGreeting();
  renderWeekSummary();
}

async function refreshAnnualAvg(){
  let allMonths=[];
  for(let y=2026;y<=curYear;y++){
    const data=await api(`/api/annual/${y}`)||[];
    data.filter(d=>d.income>0).forEach(d=>allMonths.push(d));
  }
  realMonthsCount=allMonths.length||1;
  const totalNet=allMonths.reduce((s,d)=>s+(d.income-d.expenses),0);
  monthlyAvgSaving=Math.round(totalNet/realMonthsCount);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INCOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadIncome(){
  incomeData=await api(`/api/income/${curMonth}/${curYear}`)||{};
  document.getElementById('in-salary').value=incomeData.salary||'';
  document.getElementById('in-b2').value=incomeData.bonus2||'';
  document.getElementById('in-b6').value=incomeData.bonus6||'';
  document.getElementById('in-intl').value=incomeData.bonus_intl||'';
  document.getElementById('in-extra').value=incomeData.extra||'';
  document.getElementById('in-b2a').value=incomeData.bonus2_active?'true':'false';
  document.getElementById('in-b6a').value=incomeData.bonus6_active?'true':'false';
  document.getElementById('in-ia').value=incomeData.intl_active?'true':'false';
}

function saveIncome(){
  clearTimeout(saveIncomeTimer);
  saveIncomeTimer=setTimeout(async()=>{
    const body={
      salary:parseFloat(document.getElementById('in-salary').value)||0,
      bonus2:parseFloat(document.getElementById('in-b2').value)||0,
      bonus6:parseFloat(document.getElementById('in-b6').value)||0,
      bonus_intl:parseFloat(document.getElementById('in-intl').value)||0,
      extra:parseFloat(document.getElementById('in-extra').value)||0,
      bonus2_active:document.getElementById('in-b2a').value==='true',
      bonus6_active:document.getElementById('in-b6a').value==='true',
      intl_active:document.getElementById('in-ia').value==='true'
    };
    incomeData=await api(`/api/income/${curMonth}/${curYear}`,'POST',body)||incomeData;
    renderIncomeSummary(); renderDashboard();
  },600);
}

function renderIncomeSummary(){
  const inc=incomeData;
  const bonus=(inc.bonus2_active?inc.bonus2:0)+(inc.bonus6_active?inc.bonus6:0)+(inc.intl_active?inc.bonus_intl:0);
  document.getElementById('is-sal').textContent=fmt(inc.salary);
  document.getElementById('is-bon').textContent=fmt(bonus);
  document.getElementById('is-ext').textContent=fmt(inc.extra);
  document.getElementById('is-tot').textContent=fmt(inc.total);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPENSES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â• Ø¨Ø­Ø« ÙˆÙÙŠÙ„ØªØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ â•â•
function filterExpenses(){
  const q = (document.getElementById('exp-search')?.value||'').trim().toLowerCase();
  const cat = document.getElementById('exp-filter-cat')?.value||'';
  const clearBtn = document.getElementById('exp-clear-search');
  if(clearBtn) clearBtn.style.display = (q||cat) ? 'inline-flex' : 'none';
  renderExpenses(q, cat);
}

function clearExpSearch(){
  const s = document.getElementById('exp-search');
  const c = document.getElementById('exp-filter-cat');
  if(s) s.value='';
  if(c) c.value='';
  document.getElementById('exp-clear-search').style.display='none';
  renderExpenses();
}
async function loadExpenses(){
  expensesData=await api(`/api/expenses/${curMonth}/${curYear}`)||[];
  renderExpenses();
}

function renderExpenses(q='', cat=''){
  const tbody=document.getElementById('exp-list');
  let data = expensesData;
  if(q) data = data.filter(e=>(e.description||'').toLowerCase().includes(q)||(e.category||'').toLowerCase().includes(q));
  if(cat) data = data.filter(e=>e.category===cat);
  if(!data.length){
    const msg = (q||cat) ? 'Ù…Ø§ ÙƒØ§ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«' : 'Ù…Ø§ ÙƒØ§ÙŠÙ† Ù…ØµØ§Ø±ÙŠÙ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±';
    tbody.innerHTML=`<tr><td colspan="6" class="loading">${msg}</td></tr>`;
    document.getElementById('exp-total-foot').textContent='0 Ø¯Ø±Ù‡Ù…';return;
  }
  const total=data.reduce((s,e)=>s+e.amount,0);
  tbody.innerHTML=data.map((e,i)=>`
    <tr><td style="color:var(--text2)">${i+1}</td>
    <td><span class="tag">${CAT_ICONS[e.category]||''} ${e.category}</span></td>
    <td>${e.description||'-'}</td>
    <td style="color:var(--red);font-weight:700">${fmt(e.amount)}</td>
    <td style="color:var(--text2)">${e.date}</td>
    <td><button class="action-btn red" style="padding:4px 8px;font-size:11px" onclick="delExpense(${e.id})">ğŸ—‘ï¸</button></td>
    </tr>`).join('');
  document.getElementById('exp-total-foot').textContent=fmt(total);
}

async function addExpense(){
  const amt=parseFloat(document.getElementById('exp-amt').value);
  if(!amt||isNaN(amt)){alert('âš ï¸ Ø®Ø§ØµÙƒ ØªØ¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº!');return;}
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±ÙŠÙ† Ø¯Ø§Ø¦Ù…Ø§Ù‹
  const finalDate=`${curYear}-${String(curMonth).padStart(2,'0')}-01`;
  await api('/api/expenses','POST',{
    category:document.getElementById('exp-cat').value,
    description:document.getElementById('exp-desc').value||'â€”',
    amount:amt,
    date:finalDate
  });
  document.getElementById('exp-amt').value='';
  document.getElementById('exp-desc').value='';
  // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
  const btn=document.querySelector('#tab-expenses .action-btn.green');
  const orig=btn.textContent;
  btn.textContent='âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©!';
  btn.style.background='var(--green-d)';
  setTimeout(()=>{btn.textContent=orig;btn.style.background='';},1500);
  await loadExpenses(); renderDashboard();
}

async function delExpense(id){
  await api(`/api/expenses/${id}`,'DELETE');
  await loadExpenses(); renderDashboard();
}

async function clearMonthExpenses(){
  if(!confirm('ØªÙ…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ù…ØµØ§Ø±ÙŠÙ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ'))return;
  for(const e of expensesData)await api(`/api/expenses/${e.id}`,'DELETE');
  await loadExpenses(); renderDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSettings(){
  settingsData=await api('/api/settings')||settingsData;
  document.getElementById('s-warn').value=settingsData.warn_threshold||1000;
  document.getElementById('s-danger').value=settingsData.danger_threshold||500;
}

function saveSettings(){
  clearTimeout(saveSettingsTimer);
  saveSettingsTimer=setTimeout(async()=>{
    settingsData=await api('/api/settings','POST',{
      warn_threshold:parseFloat(document.getElementById('s-warn').value)||1000,
      danger_threshold:parseFloat(document.getElementById('s-danger').value)||500,
    })||settingsData;
    renderDashboard();
    showToast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!');
  },600);
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectGoalType(el){
  document.querySelectorAll('.goal-type-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
  selectedGoalType=el.dataset.type;
  const lbl=el.dataset.label;
  const nameInp=document.getElementById('g-name');
  if(!nameInp.value||Object.values({Ø³ÙŠØ§Ø±Ø©:'ğŸš—',Ø´Ù‚Ø©:'ğŸ ',Ø³ÙØ±:'âœˆï¸',ØªØ¹Ù„ÙŠÙ…:'ğŸ“',Ø²ÙˆØ§Ø¬:'ğŸ’',ØªÙ‚Ù†ÙŠØ©:'ğŸ“±',ØµØ­Ø©:'ğŸ¥',Ø£Ø®Ø±Ù‰:'â­'}).includes(nameInp.value)){
    nameInp.value=lbl;
  }
}

async function loadGoals(){
  goalsData=await api('/api/goals')||[];
  renderGoals();
  updateSavingBanner();
}

function renderGoals(){
  const container=document.getElementById('goals-list');
  if(!goalsData.length){
    container.innerHTML=`
      <div style="text-align:center;padding:48px 20px;color:var(--text2)">
        <div style="font-size:56px;margin-bottom:16px;animation:cardIn .5s ease both">ğŸ¯</div>
        <div style="font-size:16px;font-weight:900;color:var(--text);margin-bottom:8px">Ù…Ø§ ÙƒØ§ÙŠÙ† Ø£Ù‡Ø¯Ø§Ù Ø¨Ø¹Ø¯</div>
        <div style="font-size:13px;line-height:1.8">Ø­Ø¯Ø¯ Ù‡Ø¯ÙÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ø¨Ø¯Ø£ Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</div>
      </div>`;
    return;
  }
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);

  const GOAL_COLORS = {
    'ğŸš—':'#e17055','ğŸ ':'#4a90d9','âœˆï¸':'#00cec9','ğŸ“':'#8b5cf6',
    'ğŸ’':'#fd79a8','ğŸ“±':'#fdcb6e','ğŸ¥':'#00b894','â­':'#b2bec3'
  };

  container.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px">
  ${goalsData.map((g,idx)=>{
    const pct = Math.min(100, g.progress_pct||0);
    const remaining = Math.max(0, g.target_amount - g.saved_amount);
    const color = pct>=100 ? 'var(--green)' : pct>66 ? 'var(--gold)' : pct>33 ? 'var(--blue)' : 'var(--text2)';
    const accentColor = GOAL_COLORS[g.type||'â­'] || 'var(--green)';

    // ETA Ø°ÙƒÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
    const etaMonths = g.monthly_needed>0 ? Math.ceil(remaining/g.monthly_needed) : 0;
    const etaDate = new Date(); etaDate.setMonth(etaDate.getMonth()+etaMonths);
    const etaStr = pct>=100 ? 'ğŸ‰ Ù…ÙƒØªÙ…Ù„!' : etaMonths>0
      ? MONTHS[etaDate.getMonth()]+' '+etaDate.getFullYear()
      : 'Ø£Ø¶Ù Ø¯Ø®Ù„Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹';

    // Circular SVG progress
    const r=42; const circ=2*Math.PI*r;
    const offset = circ - (circ * pct/100);

    // Milestones: 25% / 50% / 75% / 100%
    const milestones = [25,50,75,100];
    const timelineHTML = `
      <div class="goal-timeline">
        <div class="goal-timeline-track">
          <div class="goal-timeline-fill" style="width:${pct}%;background:${accentColor}"></div>
        </div>
        ${milestones.map(ms=>`
          <div class="milestone ${pct>=ms?'reached':''}">
            <div class="milestone-dot" style="${pct>=ms?'background:'+accentColor+';border-color:'+accentColor:''}">
              ${pct>=ms?'âœ“':''}
            </div>
            <div class="milestone-lbl">${ms}%</div>
          </div>
        `).join('')}
      </div>`;

    // AI suggestion: months to go vs saving rate
    const urgency = etaMonths <= 3 && pct < 100 ? 'ğŸ”¥ Ù‚Ø±ÙŠØ¨!' : etaMonths > 24 ? 'ğŸ’¡ ÙÙƒØ± ÙÙŠ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø±' : '';

    return`<div class="goal-card-v2" style="animation-delay:${idx*0.07}s">
      <div class="goal-card-banner" style="background:linear-gradient(90deg,${accentColor},transparent)"></div>
      ${pct>=100?'<div class="goal-complete-badge">ğŸ† Ù…ÙƒØªÙ…Ù„</div>':''}
      <div class="goal-card-top">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <span class="goal-emoji-big">${g.type||'â­'}</span>
          <span class="goal-eta-pill">ğŸ“… ${etaStr} ${urgency}</span>
        </div>
        <div class="goal-name">${g.name}</div>
      </div>

      <!-- Ring + Stats -->
      <div class="goal-ring-wrap" style="padding:0 18px">
        <div class="goal-ring-stats">
          <div class="goal-stat-row">
            <span class="goal-stat-label">ØªÙ… Ø§Ø¯Ø®Ø§Ø±Ù‡</span>
            <span class="goal-stat-val" style="color:var(--green)">${fmt(g.saved_amount)}</span>
          </div>
          <div class="goal-stat-row">
            <span class="goal-stat-label">Ø§Ù„Ù‡Ø¯Ù</span>
            <span class="goal-stat-val" style="color:var(--gold)">${fmt(g.target_amount)}</span>
          </div>
          <div class="goal-stat-row">
            <span class="goal-stat-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
            <span class="goal-stat-val" style="color:var(--text2)">${fmt(remaining)}</span>
          </div>
          ${g.monthly_needed>0?`<div class="goal-stat-row">
            <span class="goal-stat-label">Ø´Ù‡Ø±ÙŠØ§Ù‹ Ù…Ø·Ù„ÙˆØ¨</span>
            <span class="goal-stat-val" style="color:${accentColor}">${fmt(g.monthly_needed)}</span>
          </div>`:''}
        </div>
        <div class="goal-ring">
          <svg width="110" height="110" viewBox="0 0 110 110">
            <circle cx="55" cy="55" r="${r}" fill="none" stroke="var(--bg4)" stroke-width="10"/>
            <circle cx="55" cy="55" r="${r}" fill="none" stroke="${accentColor}" stroke-width="10"
              stroke-dasharray="${circ.toFixed(1)}" stroke-dashoffset="${circ.toFixed(1)}"
              stroke-linecap="round"
              style="transition:stroke-dashoffset 1.2s cubic-bezier(.22,1,.36,1);transition-delay:${idx*0.1}s"
              data-target-offset="${offset.toFixed(1)}"/>
          </svg>
          <div class="goal-ring-center">
            <span class="goal-ring-pct" style="color:${accentColor}">${pct}%</span>
            <span class="goal-ring-label">Ù…ÙƒØªÙ…Ù„</span>
          </div>
        </div>
      </div>

      <!-- Timeline Milestones -->
      ${timelineHTML}

      <!-- Actions -->
      <div class="goal-actions">
        <button class="goal-action-btn danger" onclick="delGoal(${g.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        <button class="goal-action-btn" onclick="openEditGoal(${g.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      </div>
      <button class="goal-action-btn primary" style="width:100%;border-top:1px solid var(--border);border-radius:0 0 18px 18px" onclick="quickDeposit(${g.id},'${g.name.replace(/'/g,"\'")}',${g.saved_amount},${g.target_amount})">
        â• Ø¥Ø¶Ø§ÙØ© Ø§Ø¯Ø®Ø§Ø±
      </button>
    </div>`;
  }).join('')}
  </div>`;

  // Animate SVG rings
  setTimeout(()=>{
    document.querySelectorAll('[data-target-offset]').forEach(circle=>{
      circle.style.strokeDashoffset = circle.getAttribute('data-target-offset');
    });
  }, 100);
}

async function quickDeposit(id, name, currentSaved, targetAmount){
  const amount=prompt(`ğŸ’° ÙƒÙ… ØªØ¨ØºÙŠ ØªØ¶ÙŠÙ Ù„Ù„Ù‡Ø¯Ù "${name}"ØŸ (Ø¯Ø±Ù‡Ù…)\nØ§Ù„Ù…Ø¯Ø®Ø± Ø­Ø§Ù„ÙŠØ§Ù‹: ${currentSaved.toLocaleString()} Ø¯Ø±Ù‡Ù…`);
  if(!amount||isNaN(amount)||parseFloat(amount)<=0)return;
  const newSaved=currentSaved+parseFloat(amount);
  const goal=goalsData.find(g=>g.id===id);
  const months = goal?goal.months:1;
  await api(`/api/goals/${id}`,'PUT',{saved_amount:newSaved,months});
  await loadGoals();
  if(newSaved>=targetAmount){
    launchConfetti();
    showToast('ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ÙˆØµÙ„Øª Ù„Ù„Ù‡Ø¯Ù "'+name+'"!');
  } else {
    const rem=targetAmount-newSaved;
    showToast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${parseFloat(amount).toLocaleString()} Ø¯Ø±Ù‡Ù… â€” Ø¨Ø§Ù‚ÙŠ ${rem.toLocaleString()} Ø¯Ø±Ù‡Ù…`);
  }
}

function openEditGoal(id){
  const g = goalsData.find(g=>g.id===id);
  if(!g) return;
  editGoalType = g.type||'â­';
  document.getElementById('edit-goal-id').value=id;
  document.getElementById('edit-goal-name').value=g.name;
  document.getElementById('edit-goal-target').value=g.target_amount;
  document.getElementById('edit-goal-saved').value=g.saved_amount;
  document.querySelectorAll('#edit-type-picker .goal-type-btn').forEach(b=>{
    b.classList.toggle('selected', b.dataset.type===editGoalType);
  });
  document.getElementById('editGoalModal').classList.add('open');
}

function closeEditGoal(){
  document.getElementById('editGoalModal').classList.remove('open');
}

async function saveEditGoal(){
  const id=parseInt(document.getElementById('edit-goal-id').value);
  const name=document.getElementById('edit-goal-name').value.trim();
  const target=parseFloat(document.getElementById('edit-goal-target').value);
  const saved=parseFloat(document.getElementById('edit-goal-saved').value)||0;
  if(!name||!target){showToast('âš ï¸ Ø®Ø§ØµÙƒ ØªØ¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø¨Ù„Øº','error');return;}
  const goal=goalsData.find(g=>g.id===id);
  const months=goal?goal.months:1;
  await api(`/api/goals/${id}`,'PUT',{saved_amount:saved,months,name,target_amount:target,type:editGoalType});
  closeEditGoal();
  await loadGoals();
  if(saved>=target){launchConfetti();showToast('ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø§Ù„Ù‡Ø¯Ù Ù…ÙƒØªÙ…Ù„!');}
  else showToast('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ù Ø¨Ù†Ø¬Ø§Ø­!');
}

async function addGoal(){
  const n=document.getElementById('g-name').value;
  const a=parseFloat(document.getElementById('g-amt').value);
  const pct=parseInt(document.getElementById('g-pct').value)||50;
  if(!n||!a){alert('Ø®Ø§ØµÙƒ ØªØ¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨!');return;}
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const curSaving=inc-totalExp;
  const monthlyAvg=realMonthsCount>0?monthlyAvgSaving:curSaving;
  const monthlyForGoal=Math.round(monthlyAvg*pct/100);
  const autoSaved=Math.max(0,monthlyForGoal*realMonthsCount);
  const remaining=Math.max(0,a-autoSaved);
  const m=monthlyForGoal>0?Math.ceil(remaining/monthlyForGoal):1;
  await api('/api/goals','POST',{name:n,target_amount:a,months:m,saved_amount:autoSaved,type:selectedGoalType});
  ['g-name','g-amt'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('g-pct').value=50;
  document.getElementById('g-pct-display').textContent='50%';
  document.getElementById('goal-preview').style.display='none';
  await loadGoals();
}

async function delGoal(id){
  if(!confirm('ØªÙ…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø¯ÙØŸ')) return;
  
  const numId = Number(id);
  
  // Ø§Ù‚Ø±Ø£ Ù…Ù† localStorage Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† DB wrapper
  const prefix = currentUser ? 'u_'+currentUser.email+'_' : '_guest_';
  const rawKey = prefix + 'goals';
  let goals = [];
  try { goals = JSON.parse(localStorage.getItem(rawKey)) || []; } catch(e) { goals = []; }
  
  const before = goals.length;
  const filtered = goals.filter(g => Number(g.id) !== numId);
  
  // Ø§ÙƒØªØ¨ Ù…Ø¨Ø§Ø´Ø±Ø©
  localStorage.setItem(rawKey, JSON.stringify(filtered));
  goalsData = filtered;
  renderGoals();
  updateSavingBanner();
  
  if(filtered.length < before) {
    showToast('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‡Ø¯Ù');
  } else {
    showToast('âš ï¸ Ù…Ø´ÙƒÙ„ ÙÙŠ Ø§Ù„Ø­Ø°Ù â€” id: ' + numId, 'error');
    console.error('delGoal: Ù„Ù… ÙŠÙØ­Ø°Ù Ø§Ù„Ù‡Ø¯Ù. id=', numId, 'goals=', goals.map(g=>g.id));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALLOCATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateGoalPreview(){
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const curSaving=inc-totalExp;
  const monthlyAvg=realMonthsCount>0?monthlyAvgSaving:curSaving;

  const pct=parseInt(document.getElementById('g-pct').value)||50;
  const target=parseFloat(document.getElementById('g-amt').value)||0;

  document.getElementById('g-pct-display').textContent=pct+'%';
  const availLbl=document.getElementById('g-avail-lbl');
  if(availLbl) availLbl.textContent=inc>0
    ?`Ù…Ø¹Ø¯Ù„ ${fmt(monthlyAvg)}/Ø´Ù‡Ø± (${realMonthsCount} Ø´Ù‡Ø±)`
    :'Ù…Ø§ ÙƒØ§ÙŠÙ† Ø¯Ø®Ù„ â€” Ø¯Ø®Ù„ Ø§Ù„ØµØ§Ù„ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹';

  const preview=document.getElementById('goal-preview');
  if(!inc||!target){preview.style.display='none';return;}

  const monthlyForGoal=Math.round(monthlyAvg*pct/100);
  const autoSaved=Math.max(0,monthlyForGoal*realMonthsCount);
  const remaining=Math.max(0,target-autoSaved);
  const months=monthlyForGoal>0?Math.ceil(remaining/monthlyForGoal):999;
  document.getElementById('g-months').value=months;

  const etaDate=new Date(curYear,curMonth-1+months);
  const etaStr=remaining<=0?'Ø§Ù„Ø¢Ù†! ğŸ‰':`${MONTHS[etaDate.getMonth()]} ${etaDate.getFullYear()}`;

  document.getElementById('prev-monthly').textContent=fmt(monthlyForGoal);
  document.getElementById('prev-months').textContent=remaining<=0?'âœ… ÙˆØµÙ„Øª!':months+' Ø´Ù‡Ø±';
  document.getElementById('prev-date').textContent=etaStr;

  const remLbl=document.getElementById('prev-remaining-lbl');
  if(remLbl){
    remLbl.innerHTML=remaining>0
      ?`${fmt(monthlyForGoal)}/Ø´Ù‡Ø± Â· ØªÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹: <b style="color:var(--green)">${fmt(autoSaved)}</b> Â· Ø¨Ø§Ù‚ÙŠ: <b style="color:var(--gold)">${fmt(remaining)}</b>`
      :'âœ… ÙˆØµÙ„Øª Ù„Ù„Ù‡Ø¯Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹!';
  }
  preview.style.display='block';
}

function updateSavingBanner(){
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const avail=Math.max(0,inc-totalExp);
  document.getElementById('avail-saving').textContent=fmt(avail);
  const totalNeeded=goalsData.reduce((s,g)=>s+g.monthly_needed,0);
  document.getElementById('saving-allocated').textContent=goalsData.length>0
    ?`Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ØªØ­ØªØ§Ø¬ ${fmt(totalNeeded)} Ø´Ù‡Ø±ÙŠØ§Ù‹`:'Ù…Ø§ ÙƒØ§ÙŠÙ† Ø£Ù‡Ø¯Ø§Ù Ø¨Ø¹Ø¯';
}

function openAllocModal(){
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const avail=Math.max(0,inc-totalExp);
  if(avail<=0){alert('Ù…Ø§ ÙƒØ§ÙŠÙ† Ø§Ø¯Ø®Ø§Ø± Ù…ØªØ§Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±!');return;}
  if(!goalsData.length){alert('Ø²ÙŠØ¯ Ù‡Ø¯Ù Ø£ÙˆÙ„!');return;}
  document.getElementById('modal-total-saving').textContent=fmt(avail);

  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  const totalNeeded=goalsData.reduce((s,g)=>s+g.monthly_needed,0);
  const rows=document.getElementById('alloc-rows');
  rows.innerHTML=goalsData.map((g,i)=>{
    const autoPct=totalNeeded>0?Math.round((g.monthly_needed/totalNeeded)*100):Math.round(100/goalsData.length);
    const amount=Math.round(avail*autoPct/100);
    const icon=g.name.includes('Ø³ÙŠØ§Ø±Ø©')?'ğŸš—':g.name.includes('Ø´Ù‚Ø©')||g.name.includes('Ù…Ù†Ø²Ù„')?'ğŸ ':
               g.name.includes('Ø³ÙØ±')?'âœˆï¸':g.name.includes('ØªØ¹Ù„ÙŠÙ…')?'ğŸ“':g.name.includes('Ø²ÙˆØ§Ø¬')?'ğŸ’':'â­';
    return`<div class="alloc-row">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div style="display:flex;align-items:center;gap:8px;font-weight:700">
          <span style="font-size:22px">${icon}</span>
          <span>${g.name}</span>
        </div>
        <div style="text-align:left">
          <span style="font-size:18px;font-weight:900;color:var(--green)" id="alloc-pct-${g.id}">${autoPct}%</span>
          <div style="font-size:11px;color:var(--text2)" id="alloc-amt-${g.id}">${fmt(amount)}</div>
        </div>
      </div>
      <input type="range" class="alloc-slider" min="0" max="100" value="${autoPct}"
        id="alloc-slider-${g.id}" data-id="${g.id}" oninput="updateAllocSlider(${g.id},${avail})"/>
      <div style="font-size:10px;color:var(--text2);margin-top:2px">
        Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø´Ù‡Ø±ÙŠØ§Ù‹: <b style="color:var(--gold)">${fmt(g.monthly_needed)}</b>
      </div>
    </div>`;
  }).join('');
  updateAllocTotal(avail);
  document.getElementById('allocModal').classList.add('open');
}

function updateAllocSlider(id, avail){
  const pct=parseInt(document.getElementById(`alloc-slider-${id}`).value);
  const amount=Math.round(avail*pct/100);
  document.getElementById(`alloc-pct-${id}`).textContent=pct+'%';
  document.getElementById(`alloc-amt-${id}`).textContent=fmt(amount);
  updateAllocTotal(avail);
}

function updateAllocTotal(avail){
  let total=0;
  goalsData.forEach(g=>{
    const s=document.getElementById(`alloc-slider-${g.id}`);
    if(s)total+=parseInt(s.value);
  });
  const color=total>100?'var(--red)':total===100?'var(--green)':'var(--gold)';
  document.getElementById('alloc-pct-total').textContent=total+'%';
  document.getElementById('alloc-pct-total').style.color=color;
  document.getElementById('alloc-prog').style.width=Math.min(total,100)+'%';
  document.getElementById('alloc-prog').style.background=color;
  const remaining=avail*(100-total)/100;
  document.getElementById('alloc-remaining-lbl').textContent=total>100
    ?'âš ï¸ ØªØ¬Ø§ÙˆØ²Øª 100% â€” Ù†Ù‚Øµ Ù…Ù† Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù'
    :total===100?'âœ… Ù…Ù…ØªØ§Ø²! ÙƒÙ„ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ù…ÙˆØ²Ø¹'
    :`Ø¨Ø§Ù‚ÙŠ ${fmt(remaining)} Ø¨Ø¯ÙˆÙ† ØªÙˆØ²ÙŠØ¹`;
}

function closeAllocModal(){
  document.getElementById('allocModal').classList.remove('open');
}

async function applyAllocation(){
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const avail=Math.max(0,inc-totalExp);
  let total=0;
  goalsData.forEach(g=>{
    const s=document.getElementById(`alloc-slider-${g.id}`);
    if(s)total+=parseInt(s.value);
  });
  if(total>100){alert('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ØªØ¬Ø§ÙˆØ² 100%! Ù†Ù‚Øµ Ù…Ù† Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù.');return;}
  if(!confirm(`ØºØ§Ø¯ÙŠ ØªØ¶ÙŠÙ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù. Ù…ØªØ£ÙƒØ¯ØŸ`))return;

  let anyCompleted=false;
  for(const g of goalsData){
    const s=document.getElementById(`alloc-slider-${g.id}`);
    if(!s)continue;
    const pct=parseInt(s.value);
    if(pct===0)continue;
    const amount=Math.round(avail*pct/100);
    const newSaved=g.saved_amount+amount;
    await api(`/api/goals/${g.id}`,'PUT',{saved_amount:newSaved});
    if(newSaved>=g.target_amount)anyCompleted=true;
  }

  closeAllocModal();
  await loadGoals();
  if(anyCompleted){launchConfetti();setTimeout(()=>alert('ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ÙˆØµÙ„Øª Ù„Ù‡Ø¯Ù!'),500);}
  else{showToast('âœ… ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù!');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI TIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateAiTips(inc, totalExp, rem){
  const tips=[];
  const pct=inc>0?Math.round((rem/inc)*100):0;
  const catMap={};
  expensesData.forEach(e=>{catMap[e.category]=(catMap[e.category]||0)+e.amount;});

  if(pct>=20)tips.push({icon:'ğŸŒŸ',text:`Ù†Ø³Ø¨Ø© Ø§Ø¯Ø®Ø§Ø±Ùƒ ${pct}% Ù…Ù…ØªØ§Ø²Ø©! Ø§Ø³ØªÙ…Ø± ÙƒØ°Ø§.`});
  else if(pct>=10)tips.push({icon:'ğŸ‘',text:`Ø§Ø¯Ø®Ø±Øª ${pct}% Ù…Ù† Ø¯Ø®Ù„Ùƒ. Ø­Ø§ÙˆÙ„ ØªÙˆØµÙ„ Ù„20%.`});
  else if(pct>0)tips.push({icon:'âš ï¸',text:`Ù†Ø³Ø¨Ø© Ø§Ø¯Ø®Ø§Ø±Ùƒ Ø¶Ø¹ÙŠÙØ© (${pct}%). Ø±Ø§Ø¬Ø¹ Ù…ØµØ§Ø±ÙŠÙÙƒ.`});

  if(prevMonthExp>0){
    const diff=totalExp-prevMonthExp;
    const diffPct=Math.abs(Math.round((diff/prevMonthExp)*100));
    if(diff>500)tips.push({icon:'ğŸ“ˆ',text:`Ù…ØµØ§Ø±ÙŠÙÙƒ Ø²Ø§Ø¯Øª ${diffPct}% Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ (+${Math.round(diff).toLocaleString()} Ø¯Ø±Ù‡Ù…).`});
    else if(diff<-500)tips.push({icon:'ğŸ“‰',text:`Ù…ØµØ§Ø±ÙŠÙÙƒ Ù†Ù‚ØµØª ${diffPct}% Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ. Ù…Ù…ØªØ§Ø²!`});
  }

  const ent=catMap['ØªØ±ÙÙŠÙ‡']||0;
  if(ent>inc*0.15)tips.push({icon:'ğŸ¬',text:`Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªØ±ÙÙŠÙ‡ (${fmt(ent)}) ØªØªØ¬Ø§ÙˆØ² 15% Ù…Ù† Ø¯Ø®Ù„Ùƒ. ÙÙƒØ± ÙÙŠÙ‡Ø§.`});
  const food=catMap['Ù…Ø§ÙƒÙ„Ø©']||0;
  if(food>inc*0.3)tips.push({icon:'ğŸ›’',text:`Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…Ø§ÙƒÙ„Ø© Ù…Ø±ØªÙØ¹Ø© (${fmt(food)}). Ø¬Ø±Ø¨ Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹.`});
  if(goalsData.length>0){
    const totalNeeded=goalsData.reduce((s,g)=>s+g.monthly_needed,0);
    if(rem<totalNeeded)tips.push({icon:'ğŸ¯',text:`Ø§Ù„Ø¨Ø§Ù‚ÙŠ (${fmt(rem)}) Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø£Ù‡Ø¯Ø§Ù (${fmt(totalNeeded)}). Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©.`});
    else tips.push({icon:'âœ…',text:`Ø§Ù„Ø¨Ø§Ù‚ÙŠ ÙƒØ§ÙÙŠ Ù„ØªÙ…ÙˆÙŠÙ„ ÙƒÙ„ Ø£Ù‡Ø¯Ø§ÙÙƒ! (${fmt(totalNeeded)} Ù…Ø·Ù„ÙˆØ¨).`});
  }

  const aiSection=document.getElementById('ai-section');
  const aiTips=document.getElementById('ai-tips');
  if(tips.length){
    aiTips.innerHTML=tips.slice(0,3).map(t=>`<div class="ai-tip"><span class="ai-tip-icon">${t.icon}</span><span>${t.text}</span></div>`).join('');
    aiSection.style.display='block';
  } else aiSection.style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HEALTH SCORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHealthScore(inc, totalExp, rem){
  let score=0;
  const savePct=inc>0?(rem/inc)*100:0;
  if(savePct>=30)score+=40;else if(savePct>=20)score+=30;else if(savePct>=10)score+=20;else if(savePct>0)score+=10;
  if(inc>0&&totalExp>0){
    const catMap={};
    expensesData.forEach(e=>{catMap[e.category]=(catMap[e.category]||0)+e.amount;});
    let overBudget=0;
    Object.keys(limits).forEach(cat=>{if(limits[cat]>0&&(catMap[cat]||0)>limits[cat])overBudget++;});
    if(overBudget===0)score+=20;else if(overBudget<=1)score+=10;
  }
  if(goalsData.length>0)score+=20;else score+=5;
  if(rem>settingsData.warn_threshold)score+=20;else if(rem>settingsData.danger_threshold)score+=10;

  const el=document.getElementById('health-num');
  const arc=document.getElementById('health-arc');
  const lbl=document.getElementById('health-lbl');
  const circumference=138.2;
  const offset=circumference-(circumference*score/100);
  el.textContent=score;
  arc.style.strokeDashoffset=offset;
  arc.style.stroke=score>=70?'var(--green)':score>=40?'var(--gold)':'var(--red)';
  el.style.color=score>=70?'var(--green)':score>=40?'var(--gold)':'var(--red)';
  lbl.textContent=score>=70?'Ù…Ù…ØªØ§Ø² ğŸŒŸ':score>=40?'Ø¬ÙŠØ¯ ğŸ‘':'Ø¶Ø¹ÙŠÙ âš ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const inc=incomeData.total||0;
  const salary=incomeData.salary||0;
  const bonus=(incomeData.bonus2_active?incomeData.bonus2:0)+(incomeData.bonus6_active?incomeData.bonus6:0)+(incomeData.intl_active?incomeData.bonus_intl:0);
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const rem=inc-totalExp;
  const pct=inc>0?Math.round((rem/inc)*100):0;

  // Animated counters
  const animEl=(id,val)=>{
    const el=document.getElementById(id);
    if(el)animateCount(el,val);
  };
  animEl('d-salary',salary); animEl('d-income',inc); animEl('d-exp',totalExp); animEl('d-rem',rem);
  document.getElementById('d-pct').textContent=pct+'%';
  document.getElementById('d-bonus-sub').textContent=bonus>0?`+ Ø¨Ø±ÙŠÙ… ${fmt(bonus)}`:'Ø¨Ø¯ÙˆÙ† Ø¨Ø±ÙŠÙ…';

  // Trend
  const trend=document.getElementById('d-exp-trend');
  if(prevMonthExp>0){
    const diff=totalExp-prevMonthExp;
    const p=Math.abs(Math.round((diff/prevMonthExp)*100));
    trend.textContent=diff>0?`â–² +${p}% Ø¹Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ`:`â–¼ -${p}% Ø¹Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ`;
    trend.className='card-trend '+(diff>0?'down':'up');
  }
  renderIncomeSummary();
  updateHealthScore(inc,totalExp,rem);
  generateAiTips(inc,totalExp,rem);
  checkBudgetAlerts();

  // Alert
  const banner=document.getElementById('alertBanner');
  banner.className='alert-banner';
  if(rem<=settingsData.danger_threshold&&inc>0){
    banner.className='alert-banner danger';
    banner.innerHTML=`ğŸš¨ <b>Ø®Ø·Ø±!</b> Ø§Ù„Ø¨Ø§Ù‚ÙŠ (${fmt(rem)}) Ø£Ù‚Ù„ Ù…Ù† ${fmt(settingsData.danger_threshold)}`;
  } else if(rem<=settingsData.warn_threshold&&inc>0){
    banner.className='alert-banner warning';
    banner.innerHTML=`âš ï¸ <b>ØªÙ†Ø¨ÙŠÙ‡!</b> Ø§Ù„Ø¨Ø§Ù‚ÙŠ (${fmt(rem)}) Ø£Ù‚Ù„ Ù…Ù† ${fmt(settingsData.warn_threshold)}`;
  }

  // Pie Chart
  const catMap={};
  expensesData.forEach(e=>{catMap[e.category]=(catMap[e.category]||0)+e.amount;});
  const labels=Object.keys(catMap), vals=labels.map(l=>catMap[l]);
  const colors=labels.map(l=>CAT_COLORS[CATS.indexOf(l)]||'#aaa');
  if(pieChart)pieChart.destroy();
  if(labels.length){
    pieChart=new Chart(document.getElementById('chartPie').getContext('2d'),{
      type:'doughnut',data:{labels,datasets:[{data:vals,backgroundColor:colors,borderWidth:2,borderColor:'#1a2235'}]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'right',labels:{color:'#e8eaf0',font:{family:'Cairo',size:10},padding:8}},
          tooltip:{callbacks:{label:c=>` ${c.label}: ${fmt(c.raw)}`}}}}});
  }

  // Breakdown
  const bd=document.getElementById('exp-breakdown');
  bd.innerHTML=labels.length?labels.map((l,i)=>{
    const p=totalExp>0?Math.round((catMap[l]/totalExp)*100):0;
    const over=lim&&catMap[l]>lim;
    return`<div class="prog-row">
      <div class="prog-label"><span>${CAT_ICONS[l]||''} ${l} ${over?'<span class="badge badge-red">ØªØ¬Ø§ÙˆØ²</span>':''}</span>
      <span style="color:var(--text2)">${fmt(catMap[l])}</span></div>
      <div class="prog-bar"><div class="prog-fill" style="width:${p}%;background:${colors[i]}"></div></div>
    </div>`}).join(''):'<p class="loading">Ù…Ø§ ÙƒØ§ÙŠÙ† Ù…ØµØ§Ø±ÙŠÙ</p>';

  // Recent ops
  document.getElementById('recent-ops').innerHTML=
    [...expensesData].sort((a,b)=>b.id-a.id).slice(0,8).map(e=>
    `<tr><td><span class="tag">${CAT_ICONS[e.category]||''} ${e.category}</span></td>
    <td>${e.description||'-'}</td><td style="color:var(--red);font-weight:700">${fmt(e.amount)}</td>
    <td style="color:var(--text2)">${e.date}</td></tr>`).join('')
    ||'<tr><td colspan="4" class="loading">Ù…Ø§ ÙƒØ§ÙŠÙ† Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANNUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAnnual(){
  if(!goalsData.length) goalsData=await api('/api/goals')||[];
  const data=await api(`/api/annual/${curYear}`)||[];
  let totI=0,totE=0,cumS=0;
  data.forEach(d=>{totI+=d.income;totE+=d.expenses;});
  const totalGoalsSaved=goalsData.reduce((s,g)=>s+g.saved_amount,0);
  document.getElementById('annual-cards').innerHTML=`
    <div class="card green"><div class="card-label">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ</div><div class="card-value green">${fmt(totI)}</div></div>
    <div class="card red"><div class="card-label">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø³Ù†ÙˆÙŠØ©</div><div class="card-value red">${fmt(totE)}</div></div>
    <div class="card blue"><div class="card-label">Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ</div><div class="card-value blue">${fmt(Math.max(0,totI-totE))}</div></div>
    <div class="card gold"><div class="card-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ</div><div class="card-value gold">${fmt(monthlyAvgSaving)}</div><div class="card-sub">${realMonthsCount} Ø´Ù‡Ø±</div></div>`;

  if(barChart)barChart.destroy();
  barChart=new Chart(document.getElementById('chartBar').getContext('2d'),{
    type:'bar',data:{labels:MONTHS,datasets:[
      {label:'Ø§Ù„Ø¯Ø®Ù„',data:data.map(d=>d.income),backgroundColor:'rgba(0,184,148,.7)',borderRadius:5},
      {label:'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ',data:data.map(d=>d.expenses),backgroundColor:'rgba(225,112,85,.7)',borderRadius:5}
    ]},options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:'#e8eaf0',font:{family:'Cairo'}}}},
      scales:{x:{ticks:{color:'#8892a4',font:{family:'Cairo'}},grid:{color:'#2a3555'}},
              y:{ticks:{color:'#8892a4'},grid:{color:'#2a3555'}}}}});

  if(lineChart)lineChart.destroy();
  lineChart=new Chart(document.getElementById('chartLine').getContext('2d'),{
    type:'line',data:{labels:MONTHS,datasets:[{label:'Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ',
      data:data.map(d=>{cumS+=Math.max(0,d.remaining);return cumS;}),
      borderColor:'#00b894',backgroundColor:'rgba(0,184,148,.1)',fill:true,tension:.4,pointBackgroundColor:'#00b894'}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:'#e8eaf0',font:{family:'Cairo'}}}},
      scales:{x:{ticks:{color:'#8892a4',font:{family:'Cairo'}},grid:{color:'#2a3555'}},
              y:{ticks:{color:'#8892a4'},grid:{color:'#2a3555'}}}}});

  document.getElementById('annual-tbl').innerHTML=`
    <thead><tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ø¯Ø®Ù„</th><th>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</th><th>Ø§Ù„Ø¨Ø§Ù‚ÙŠ</th><th>Ù†Ø³Ø¨Ø©</th></tr></thead>
    <tbody>${data.map(d=>{const p=d.income>0?Math.round((d.remaining/d.income)*100):0;
      return`<tr><td style="font-weight:700">${MONTHS[d.month-1]}</td>
      <td style="color:var(--green)">${fmt(d.income)}</td>
      <td style="color:var(--red)">${fmt(d.expenses)}</td>
      <td style="color:${d.remaining>=0?'var(--blue)':'var(--red)'};font-weight:700">${fmt(d.remaining)}</td>
      <td><span class="badge ${p>=20?'badge-green':p>=10?'badge-gold':'badge-red'}">${p}%</span></td></tr>`;
    }).join('')}</tbody>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS=['dashboard','income','expenses','goals','annual','stats','settings'];
function showTab(name){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  document.querySelectorAll('.nav-tab')[TABS.indexOf(name)].classList.add('active');
  if(name==='annual')loadAnnual();
  if(name==='stats')loadStats();
  if(name==='goals'){refreshAnnualAvg().catch(()=>{}).then(()=>{updateGoalPreview();loadGoals();});}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFETTI + TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launchConfetti(){
  const colors=['#00b894','#fdcb6e','#4a90d9','#8b5cf6','#e17055','#fd79a8'];
  for(let i=0;i<60;i++){
    setTimeout(()=>{
      const el=document.createElement('div');
      el.className='confetti-piece';
      el.style.cssText=`left:${Math.random()*100}vw;background:${colors[Math.floor(Math.random()*colors.length)]};
        width:${6+Math.random()*6}px;height:${6+Math.random()*6}px;
        animation-duration:${1.5+Math.random()*2}s;animation-delay:${Math.random()*.5}s`;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),3000);
    },i*30);
  }
}

function showToast(msg){
  const t=document.createElement('div');
  t.textContent=msg;
  t.style.cssText=`position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
    background:var(--green);color:#fff;padding:12px 24px;border-radius:50px;
    font-family:Cairo,sans-serif;font-size:14px;font-weight:700;z-index:9999;
    box-shadow:0 4px 20px rgba(0,184,148,.5);animation:fadeUp .3s ease`;
  document.body.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .3s';setTimeout(()=>t.remove(),300);},2500);
}


function updatePinStatusLabel(){
  const lbl=document.getElementById('pin-status-lbl');
  if(!lbl) return;
  const saved=localStorage.getItem('mali_pin');
  lbl.textContent=saved ? 'ğŸ” PIN Ù…ÙØ¹Ù‘Ù„ â€” Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø­Ù…ÙŠ' : 'ğŸ”“ Ù„Ø§ ÙŠÙˆØ¬Ø¯ PIN â€” Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ÙØªÙˆØ­';
  lbl.style.color=saved ? 'var(--green)' : 'var(--text2)';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EMAIL SYSTEM (EmailJS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEmailModal(){
  const cfg=DB.get('emailjs_config')||{};
  document.getElementById('ej-service').value=cfg.service||'';
  document.getElementById('ej-template').value=cfg.template||'';
  document.getElementById('ej-pubkey').value=cfg.pubkey||'';
  document.getElementById('ej-email').value=cfg.email||'';
  document.getElementById('emailModal').classList.add('open');
}

function closeEmailModal(){
  document.getElementById('emailModal').classList.remove('open');
}

function saveEmailConfig(){
  const cfg={
    service:document.getElementById('ej-service').value.trim(),
    template:document.getElementById('ej-template').value.trim(),
    pubkey:document.getElementById('ej-pubkey').value.trim(),
    email:document.getElementById('ej-email').value.trim()
  };
  if(!cfg.service||!cfg.template||!cfg.pubkey||!cfg.email){
    alert('âš ï¸ ÙƒÙ…Ù‘Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!'); return;
  }
  DB.set('emailjs_config',cfg);
  closeEmailModal();
  alert('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„!');
}

function updateEmailStatusLabel(){
  const lbl=document.getElementById('email-status-lbl');
  if(!lbl) return;
  const cfg=DB.get('emailjs_config');
  lbl.textContent=cfg ? `ğŸ“§ Ù…ÙØ¹Ù‘Ù„ â€” ${cfg.email}` : 'ğŸ“­ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨Ø¹Ø¯';
  lbl.style.color=cfg ? 'var(--green)' : 'var(--text2)';
}

async function sendMonthlyEmail(auto=false){
  const cfg=DB.get('emailjs_config');
  if(!cfg){
    if(!auto) alert('âš ï¸ Ø®Ø§ØµÙƒ ØªØ¹Ø¯Ù‘ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª!');
    return;
  }
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const rem=inc-totalExp;
  const pct=inc>0?Math.round((rem/inc)*100):0;
  const catMap={};
  expensesData.forEach(e=>{catMap[e.category]=(catMap[e.category]||0)+e.amount;});
  const topCats=Object.entries(catMap).sort((a,b)=>b[1]-a[1]).slice(0,3)
    .map(([k,v])=>`${CAT_ICONS[k]||''} ${k}: ${fmt(v)}`).join(' | ');

  const params={
    to_email: cfg.email,
    month_name: MONTHS[curMonth-1]+' '+curYear,
    income: fmt(inc),
    expenses: fmt(totalExp),
    remaining: fmt(rem),
    saving_pct: pct+'%',
    top_cats: topCats||'â€”',
    health: document.getElementById('health-lbl')?.textContent||'â€”'
  };

  try{
    emailjs.init(cfg.pubkey);
    await emailjs.send(cfg.service, cfg.template, params);
    if(!auto) alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¹Ù„Ù‰ '+cfg.email);
    // Ø­ÙØ¸ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø¥Ø±Ø³Ø§Ù„
    DB.set('last_email_sent', curMonth+'-'+curYear);
  }catch(e){
    if(!auto) alert('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: '+e.text||e.message||'ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ');
  }
}

function testEmail(){
  saveEmailConfig();
  setTimeout(()=>sendMonthlyEmail(false),300);
}

// Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø±
function checkAutoEmail(){
  const cfg=DB.get('emailjs_config');
  if(!cfg) return;
  const today=new Date();
  if(today.getDate()===1){
    const key=(today.getMonth()+1)+'-'+today.getFullYear();
    if(DB.get('last_email_sent')!==key){
      sendMonthlyEmail(true);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let trendChart=null, savingChart=null, topCatsChart=null, compareChart=null;

async function loadStats(){
  // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±
  const months=[];
  for(let i=5;i>=0;i--){
    let m=curMonth-i, y=curYear;
    if(m<=0){m+=12;y--;}
    const inc=DB.get(`income_${y}_${m}`)||{};
    const exps=DB.get(`expenses_${y}_${m}`)||[];
    const income=inc.total||0;
    const expenses=exps.reduce((s,e)=>s+e.amount,0);
    months.push({label:MONTHS[m-1],income,expenses,saving:Math.max(0,income-expenses)});
  }

  // Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø© Ù„Ø£ÙƒØ«Ø± ÙØ¦Ø§Øª
  const allExps=[];
  for(let m=1;m<=12;m++){
    const exps=DB.get(`expenses_${curYear}_${m}`)||[];
    allExps.push(...exps);
  }
  const catMap={};
  allExps.forEach(e=>{catMap[e.category]=(catMap[e.category]||0)+e.amount;});
  const sortedCats=Object.entries(catMap).sort((a,b)=>b[1]-a[1]).slice(0,6);

  // Stats cards
  const totalInc=months.reduce((s,m)=>s+m.income,0);
  const totalExp=months.reduce((s,m)=>s+m.expenses,0);
  const avgSaving=months.length?Math.round(months.reduce((s,m)=>s+m.saving,0)/months.length):0;
  const bestMonth=months.reduce((best,m)=>m.saving>best.saving?m:best,months[0]||{saving:0,label:'â€”'});

  document.getElementById('stats-cards').innerHTML=`
    <div class="card green"><div class="card-label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯Ø®Ù„ (6 Ø£Ø´Ù‡Ø±)</div><div class="card-value green">${fmt(totalInc)}</div></div>
    <div class="card red"><div class="card-label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (6 Ø£Ø´Ù‡Ø±)</div><div class="card-value red">${fmt(totalExp)}</div></div>
    <div class="card blue"><div class="card-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ</div><div class="card-value blue">${fmt(avgSaving)}</div></div>
    <div class="card gold"><div class="card-label">Ø£ÙØ¶Ù„ Ø´Ù‡Ø± Ø§Ø¯Ø®Ø§Ø±Ø§Ù‹</div><div class="card-value gold">${bestMonth.label||'â€”'}</div><div class="card-sub">${fmt(bestMonth.saving||0)}</div></div>`;

  const chartOpts={responsive:true,maintainAspectRatio:false,
    plugins:{legend:{labels:{color:'#e8eaf0',font:{family:'Cairo',size:10}}}},
    scales:{x:{ticks:{color:'#8892a4',font:{family:'Cairo',size:10}},grid:{color:'#2a3555'}},
            y:{ticks:{color:'#8892a4'},grid:{color:'#2a3555'}}}};

  // Chart 1: ØªØ·ÙˆØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
  if(trendChart)trendChart.destroy();
  trendChart=new Chart(document.getElementById('chartTrend').getContext('2d'),{
    type:'line',
    data:{labels:months.map(m=>m.label),datasets:[
      {label:'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ',data:months.map(m=>m.expenses),borderColor:'#e17055',backgroundColor:'rgba(225,112,85,.1)',fill:true,tension:.4,pointBackgroundColor:'#e17055'},
      {label:'Ø§Ù„Ø¯Ø®Ù„',data:months.map(m=>m.income),borderColor:'#00b894',backgroundColor:'rgba(0,184,148,.05)',fill:false,tension:.4,borderDash:[5,5]}
    ]},options:{...chartOpts,plugins:{...chartOpts.plugins,tooltip:{callbacks:{label:c=>` ${c.dataset.label}: ${fmt(c.raw)}`}}}}});

  // Chart 2: Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø±
  if(savingChart)savingChart.destroy();
  savingChart=new Chart(document.getElementById('chartSaving').getContext('2d'),{
    type:'bar',
    data:{labels:months.map(m=>m.label),datasets:[{
      label:'Ø§Ù„Ø§Ø¯Ø®Ø§Ø±',data:months.map(m=>m.saving),
      backgroundColor:months.map(m=>m.saving>0?'rgba(0,184,148,.7)':'rgba(225,112,85,.7)'),borderRadius:6
    }]},options:chartOpts});

  // Chart 3: Ø£ÙƒØ«Ø± ÙØ¦Ø§Øª Ø¥Ù†ÙØ§Ù‚Ø§Ù‹
  if(topCatsChart)topCatsChart.destroy();
  if(sortedCats.length){
    topCatsChart=new Chart(document.getElementById('chartTopCats').getContext('2d'),{
      type:'bar',
      data:{labels:sortedCats.map(([k])=>`${CAT_ICONS[k]||''} ${k}`),
            datasets:[{label:'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ',data:sortedCats.map(([,v])=>v),
              backgroundColor:sortedCats.map(([k])=>CAT_COLORS[CATS.indexOf(k)]||'#aaa'),borderRadius:6}]},
      options:{...chartOpts,indexAxis:'y',plugins:{legend:{display:false}}}});
  }

  // Chart 4: Ù…Ù‚Ø§Ø±Ù†Ø©
  if(compareChart)compareChart.destroy();
  compareChart=new Chart(document.getElementById('chartCompare').getContext('2d'),{
    type:'bar',
    data:{labels:months.map(m=>m.label),datasets:[
      {label:'Ø§Ù„Ø¯Ø®Ù„',data:months.map(m=>m.income),backgroundColor:'rgba(0,184,148,.7)',borderRadius:4},
      {label:'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ',data:months.map(m=>m.expenses),backgroundColor:'rgba(225,112,85,.7)',borderRadius:4}
    ]},options:chartOpts});

  // ØªØ­Ù„ÙŠÙ„ Ù†ØµÙŠ
  const analysis=[];
  const lastM=months[months.length-1];
  const prevM=months[months.length-2];
  if(lastM&&prevM){
    const diff=lastM.expenses-prevM.expenses;
    if(diff>0) analysis.push(`ğŸ“ˆ Ù…ØµØ§Ø±ÙŠÙ ${lastM.label} Ø²Ø§Ø¯Øª Ø¨Ù€ ${fmt(diff)} Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù€ ${prevM.label}`);
    else if(diff<0) analysis.push(`ğŸ“‰ Ù…ØµØ§Ø±ÙŠÙ ${lastM.label} Ù†Ù‚ØµØª Ø¨Ù€ ${fmt(Math.abs(diff))} Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù€ ${prevM.label} â€” Ù…Ø²ÙŠØ§Ù†! ğŸ‰`);
    else analysis.push(`â¡ï¸ Ù…ØµØ§Ø±ÙŠÙ ${lastM.label} Ù†ÙØ³ ${prevM.label}`);
  }
  if(avgSaving>0) analysis.push(`ğŸ’° Ù…Ø¹Ø¯Ù„ Ø§Ø¯Ø®Ø§Ø±Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ ${fmt(avgSaving)} â€” ${avgSaving>2000?'Ù…Ù…ØªØ§Ø² ğŸ†':avgSaving>500?'Ø¬ÙŠØ¯ ğŸ‘':'ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡ ğŸ’ª'}`);
  if(sortedCats.length) analysis.push(`ğŸ† Ø£ÙƒØ«Ø± Ù…ØµØ±ÙˆÙ Ø¹Ù†Ø¯Ùƒ: ${CAT_ICONS[sortedCats[0][0]]||''} ${sortedCats[0][0]} Ø¨Ù€ ${fmt(sortedCats[0][1])}`);
  const savingMonths=months.filter(m=>m.saving>0).length;
  analysis.push(`âœ… Ø§Ø¯Ø®Ø±ØªÙŠ ÙÙŠ ${savingMonths} Ù…Ù† ${months.length} Ø£Ø´Ù‡Ø± Ø§Ù„Ø£Ø®ÙŠØ±Ø©`);

  document.getElementById('stats-analysis').innerHTML=analysis.map(a=>`<div style="padding:6px 0;border-bottom:1px solid var(--border)">${a}</div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUDGET OVERSPEND ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkBudgetAlerts(){
  const catMap={};
  expensesData.forEach(e=>{catMap[e.category]=(catMap[e.category]||0)+e.amount;});
  const alerts=[];
  Object.entries(limits).forEach(([cat,lim])=>{
    if(lim&&catMap[cat]>lim){
      alerts.push(`ğŸš¨ ${CAT_ICONS[cat]||''} <b>${cat}</b>: ØµØ±ÙØªÙŠ ${fmt(catMap[cat])} Ù…Ù† Ø­Ø¯ ${fmt(lim)}`);
    }
  });
  // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙÙŠ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
  let alertDiv=document.getElementById('budget-alerts');
  if(!alertDiv){
    alertDiv=document.createElement('div');
    alertDiv.id='budget-alerts';
    const banner=document.getElementById('alertBanner');
    banner.parentNode.insertBefore(alertDiv,banner.nextSibling);
  }
  if(alerts.length){
    alertDiv.innerHTML=alerts.map(a=>`<div class="budget-over" style="display:block">${a}</div>`).join('');
  }else{
    alertDiv.innerHTML='';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT + LOGOUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function expExcel(){
  const data=JSON.stringify(Object.fromEntries(Object.keys(localStorage).map(k=>[k,localStorage.getItem(k)])));
  const b=new Blob([data],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);
  a.download=`mali-plus-backup-${new Date().toISOString().split('T')[0]}.json`;a.click();
  // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
  const btn=document.getElementById('btn-export');
  if(btn){btn.textContent='âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸!';setTimeout(()=>{btn.textContent='ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';},2000);}
}
function expPDF(){window.print();}
function exportData(){expExcel();}

function importData(){
  const input=document.createElement('input');
  input.type='file';input.accept='.json';
  input.onchange=e=>{
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(typeof data!=='object')throw new Error();
        // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        Object.keys(localStorage).forEach(k=>localStorage.removeItem(k));
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        Object.entries(data).forEach(([k,v])=>localStorage.setItem(k,v));
        alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.');
        location.reload();
      }catch{alert('âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­! Ø®Ø§ØµÙˆ ÙŠÙƒÙˆÙ† Ù…Ù„Ù backup Ù…Ù† Ù…Ø§Ù„ÙŠ+');}
    };
    reader.readAsText(file);
  };
  input.click();
}

// Close modal on overlay click
document.getElementById('allocModal').addEventListener('click',function(e){
  if(e.target===this)closeAllocModal();
});

</script>

<div id="pwa-banner" style="display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:#00b894;color:#fff;padding:12px 24px;border-radius:50px;font-family:Cairo,sans-serif;
  font-size:14px;font-weight:700;z-index:9998;cursor:pointer;box-shadow:0 4px 20px rgba(0,184,148,0.5);
  white-space:nowrap;align-items:center;gap:10px">
  ğŸ“² Ø­Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ ØªÙ„ÙÙˆÙ†Ùƒ
</div>
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./service-worker.js')
      .then(r=>console.log('SW:',r.scope)).catch(e=>console.log('SW err:',e));
  });
}
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();deferredPrompt=e;
  const b=document.getElementById('pwa-banner');b.style.display='flex';
  b.onclick=async()=>{b.style.display='none';deferredPrompt.prompt();
    await deferredPrompt.userChoice;deferredPrompt=null;};
});
window.addEventListener('appinstalled',()=>document.getElementById('pwa-banner').style.display='none');
</script>
</body>
</html>
