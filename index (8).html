<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Ù…Ø§Ù„ÙŠ+ | ØªØ³ÙŠÙŠØ± Ù…Ø§Ù„ÙŠ Ø°ÙƒÙŠ</title>
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#00b894">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Ù…Ø§Ù„ÙŠ+">
<link rel="apple-touch-icon" href="/static/icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
:root{
  --green:#00b894;--green-d:#00896e;--red:#e17055;--red-d:#c0392b;
  --gold:#fdcb6e;--gold-d:#e0a800;--blue:#4a90d9;--purple:#8b5cf6;
  --bg:#0a0e1a;--bg2:#111827;--bg3:#1a2235;--bg4:#243050;
  --text:#e8eaf0;--text2:#8892a4;--border:#2a3555;
  --radius:14px;--shadow:0 4px 24px rgba(0,0,0,.4);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;direction:rtl;overflow-x:hidden}

/* â”€â”€ AUTH â”€â”€ */
.auth-page{min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at 30% 50%,rgba(0,184,148,.1) 0%,transparent 60%),
             radial-gradient(ellipse at 70% 20%,rgba(74,144,217,.08) 0%,transparent 50%),var(--bg)}
.auth-box{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:40px;width:100%;max-width:420px;box-shadow:var(--shadow)}
.auth-logo{text-align:center;font-size:32px;font-weight:900;color:var(--green);margin-bottom:6px}
.auth-logo span{color:var(--gold)}
.auth-sub{text-align:center;color:var(--text2);font-size:13px;margin-bottom:28px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:12px;font-weight:700;color:var(--text2);margin-bottom:6px}
.form-group input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:14px;padding:12px 14px;outline:none;transition:.2s}
.form-group input:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(0,184,148,.1)}
.btn{width:100%;padding:13px;border-radius:10px;border:none;font-family:inherit;font-size:15px;font-weight:700;cursor:pointer;transition:.2s}
.btn-green{background:var(--green);color:#fff}
.btn-green:hover{background:var(--green-d);transform:translateY(-1px)}
.btn-green:active{transform:translateY(0)}
.auth-switch{text-align:center;margin-top:16px;font-size:13px;color:var(--text2)}
.auth-switch a{color:var(--green);text-decoration:none;font-weight:700}
.err-msg{background:rgba(225,112,85,.15);border:1px solid var(--red);color:var(--red);padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:14px;display:none}

/* â”€â”€ HEADER â”€â”€ */
header{background:var(--bg2);border-bottom:2px solid var(--border);padding:0 16px;display:flex;align-items:center;justify-content:space-between;height:58px;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,.5)}
.logo{font-size:20px;font-weight:900;color:var(--green)}
.logo span{color:var(--gold)}
.header-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.month-sel{background:var(--bg4);border:1px solid var(--border);border-radius:8px;padding:5px 10px;display:flex;align-items:center;gap:4px}
.month-sel select{background:none;border:none;color:var(--text);font-family:inherit;font-size:13px;cursor:pointer;outline:none}
.user-badge{background:var(--bg4);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:12px;color:var(--green);font-weight:700}
.btn-sm{padding:6px 12px;border-radius:8px;border:none;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:4px;white-space:nowrap}
.btn-outline-sm{background:transparent;border:1px solid var(--border);color:var(--text2)}
.btn-outline-sm:hover{border-color:var(--green);color:var(--green)}
.btn-red-sm{background:var(--red);color:#fff}

/* â”€â”€ NAV â”€â”€ */
.nav-tabs{background:var(--bg2);border-bottom:1px solid var(--border);display:flex;padding:0 10px;gap:0;overflow-x:auto;scrollbar-width:none}
.nav-tabs::-webkit-scrollbar{display:none}
.nav-tab{padding:12px 14px;cursor:pointer;font-size:12px;font-weight:700;color:var(--text2);border-bottom:3px solid transparent;transition:.2s;white-space:nowrap;display:flex;align-items:center;gap:4px}
.nav-tab:hover{color:var(--text)}
.nav-tab.active{color:var(--green);border-bottom-color:var(--green)}

/* â”€â”€ LAYOUT â”€â”€ */
main{padding:16px;max-width:1200px;margin:0 auto}
.section{display:none;animation:fadeUp .3s ease}
.section.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.sec-title{font-size:17px;font-weight:900;margin-bottom:16px;display:flex;align-items:center;gap:8px}

/* â”€â”€ CARDS â”€â”€ */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:18px}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;position:relative;overflow:hidden;transition:.2s}
.card:hover{transform:translateY(-2px)}
.card::before{content:'';position:absolute;top:0;right:0;width:4px;height:100%}
.card.green::before{background:var(--green)}.card.red::before{background:var(--red)}
.card.gold::before{background:var(--gold)}.card.blue::before{background:var(--blue)}
.card.purple::before{background:var(--purple)}
.card-label{font-size:10px;color:var(--text2);margin-bottom:5px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.card-value{font-size:20px;font-weight:900;transition:.3s}
.card-value.green{color:var(--green)}.card-value.red{color:var(--red)}
.card-value.gold{color:var(--gold)}.card-value.blue{color:var(--blue)}.card-value.purple{color:var(--purple)}
.card-sub{font-size:10px;color:var(--text2);margin-top:3px}
.card-trend{font-size:11px;font-weight:700;margin-top:4px}
.card-trend.up{color:var(--green)}.card-trend.down{color:var(--red)}

/* â”€â”€ PANELS â”€â”€ */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px}
@media(max-width:700px){.grid-2{grid-template-columns:1fr}}
.panel{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:16px}
.panel-header{padding:13px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
.panel-body{padding:16px}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:12px}
.inp{background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:14px;padding:10px 12px;outline:none;transition:.2s;width:100%}
.inp:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(0,184,148,.1)}
.lbl{display:block;font-size:10px;font-weight:700;color:var(--text2);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
.action-btn{padding:9px 18px;border-radius:9px;border:none;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:6px}
.action-btn:active{transform:scale(.97)}
.action-btn.green{background:var(--green);color:#fff}.action-btn.green:hover{background:var(--green-d)}
.action-btn.red{background:var(--red);color:#fff}.action-btn.red:hover{background:var(--red-d)}
.action-btn.gold{background:var(--gold);color:#111}.action-btn.gold:hover{background:var(--gold-d)}
.action-btn.blue{background:var(--blue);color:#fff}
.action-btn.outline{background:transparent;border:1px solid var(--border);color:var(--text2)}.action-btn.outline:hover{border-color:var(--green);color:var(--green)}

/* â”€â”€ TABLE â”€â”€ */
.tbl{width:100%;border-collapse:collapse;font-size:13px}
.tbl th{padding:9px 10px;text-align:right;color:var(--text2);font-size:10px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);font-weight:700}
.tbl td{padding:10px;border-bottom:1px solid rgba(42,53,85,.4);vertical-align:middle}
.tbl tr:hover td{background:var(--bg3)}
.tag{display:inline-block;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(74,144,217,.15);color:var(--blue)}
.badge{display:inline-block;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:700}
.badge-green{background:rgba(0,184,148,.15);color:var(--green)}
.badge-red{background:rgba(225,112,85,.15);color:var(--red)}
.badge-gold{background:rgba(253,203,110,.15);color:var(--gold)}

/* â”€â”€ PROGRESS â”€â”€ */
.prog-row{margin-bottom:10px}
.prog-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;font-weight:700}
.prog-bar{height:8px;background:var(--bg4);border-radius:8px;overflow:hidden}
.prog-fill{height:100%;border-radius:8px;transition:width .8s cubic-bezier(.4,0,.2,1)}
.chart-wrap{position:relative;height:220px}

/* â”€â”€ ALERT â”€â”€ */
.alert-banner{border-radius:10px;padding:12px 16px;margin-bottom:14px;font-size:13px;font-weight:700;display:none;align-items:center;gap:8px}
.alert-banner.warning{background:rgba(253,203,110,.15);border:1px solid var(--gold);color:var(--gold);display:flex}
.alert-banner.danger{background:rgba(225,112,85,.15);border:1px solid var(--red);color:var(--red);display:flex}
.alert-banner.success{background:rgba(0,184,148,.15);border:1px solid var(--green);color:var(--green);display:flex}

/* â”€â”€ GOALS â”€â”€ */
.goal-card{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;transition:.2s;position:relative;overflow:hidden}
.goal-card:hover{border-color:var(--green);transform:translateY(-1px)}
.goal-emoji{font-size:36px;text-align:center;margin-bottom:8px;filter:drop-shadow(0 2px 8px rgba(0,0,0,.3))}
.goal-type-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
@media(max-width:500px){.goal-type-grid{grid-template-columns:repeat(4,1fr)}}
.goal-type-btn{background:var(--bg3);border:2px solid var(--border);border-radius:10px;padding:10px 6px;text-align:center;cursor:pointer;transition:.2s;font-size:11px;font-weight:700;color:var(--text2)}
.goal-type-btn:hover{border-color:var(--green);color:var(--green)}
.goal-type-btn.selected{border-color:var(--green);background:rgba(0,184,148,.1);color:var(--green)}
.goal-type-btn .type-icon{font-size:24px;display:block;margin-bottom:4px}

/* â”€â”€ ALLOCATION MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;display:none;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(4px)}
.modal-overlay.open{display:flex}
.modal-box{background:var(--bg2);border:1px solid var(--border);border-radius:20px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow);animation:fadeUp .3s ease}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:15px;position:sticky;top:0;background:var(--bg2);z-index:1}
.modal-body{padding:20px}
.modal-close{background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;padding:4px;border-radius:6px;transition:.2s}
.modal-close:hover{color:var(--red)}

.alloc-row{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px}
.alloc-slider{width:100%;height:6px;-webkit-appearance:none;appearance:none;background:var(--bg4);border-radius:6px;outline:none;cursor:pointer;margin:8px 0}
.alloc-slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--green);cursor:pointer;box-shadow:0 0 6px rgba(0,184,148,.5)}
.alloc-total-bar{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px;text-align:center}

/* â”€â”€ AI TIPS â”€â”€ */
.ai-card{background:linear-gradient(135deg,rgba(139,92,246,.15),rgba(74,144,217,.1));border:1px solid rgba(139,92,246,.3);border-radius:12px;padding:14px;margin-bottom:16px}
.ai-tip{display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid rgba(139,92,246,.1);font-size:13px}
.ai-tip:last-child{border-bottom:none}
.ai-tip-icon{font-size:18px;flex-shrink:0;margin-top:1px}

/* â”€â”€ HEALTH SCORE â”€â”€ */
.health-ring{width:100px;height:100px;position:relative;margin:0 auto 10px}
.health-ring svg{transform:rotate(-90deg)}
.health-ring-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column}
.health-score-num{font-size:24px;font-weight:900}
.health-score-lbl{font-size:10px;color:var(--text2)}

/* â”€â”€ CONFETTI â”€â”€ */
.confetti-piece{position:fixed;width:8px;height:8px;border-radius:2px;pointer-events:none;z-index:9999;animation:confettiFall 2.5s ease-in forwards}
@keyframes confettiFall{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}

/* â”€â”€ COUNTER ANIMATION â”€â”€ */
.counting{transition:all .05s}

/* â”€â”€ MOBILE â”€â”€ */
@media(max-width:600px){
  .header-right .btn-sm:not(.btn-red-sm){display:none}
  main{padding:10px}
  .cards-grid{grid-template-columns:repeat(2,1fr);gap:8px}
  .card{padding:12px}
  .card-value{font-size:16px}
  .panel-body{padding:12px}
  .goal-type-grid{gap:6px}
}
@media print{header,.nav-tabs,.action-btn,.btn-sm{display:none!important}body{background:#fff;color:#000}.card,.panel{border:1px solid #ccc;background:#fff}}
.loading{color:var(--text2);text-align:center;padding:24px;font-size:13px}
.flex-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• Ù…Ø§Ù„ÙŠ+ Standalone â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="logo">ğŸ‡²ğŸ‡¦ Ù…Ø§Ù„ÙŠ<span>+</span></div>
  <div class="header-right">
    <div class="month-sel">
      <select id="selMonth" onchange="changeMonth()">
        <option value="1">ÙŠÙ†Ø§ÙŠØ±</option><option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option><option value="3">Ù…Ø§Ø±Ø³</option>
        <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option><option value="5">Ù…Ø§ÙŠ</option><option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
        <option value="7">ÙŠÙˆÙ„ÙŠÙˆØ²</option><option value="8">ØºØ´Øª</option><option value="9">Ø´ØªÙ†Ø¨Ø±</option>
        <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option><option value="11">Ù†ÙˆÙ†Ø¨Ø±</option><option value="12">Ø¯Ø¬Ù†Ø¨Ø±</option>
      </select>
      <select id="selYear" onchange="changeMonth()">
        <option value="2026">2026</option><option value="2027">2027</option>
        <option value="2028">2028</option><option value="2029">2029</option>
        <option value="2030">2030</option>
      </select>
    </div>
    <span class="user-badge">ğŸ‘¤ Ù…Ø§Ù„ÙŠ+</span>
    <button class="btn-sm btn-outline-sm" onclick="expExcel()">ğŸ“Š Excel</button>
    <button class="btn-sm btn-outline-sm" onclick="expPDF()">ğŸ“„ PDF</button>
    <button class="btn-sm btn-outline-sm" onclick="window.print()">ğŸ–¨ï¸</button>
    <button class="btn-sm btn-red-sm" onclick="exportData()">ğŸ“¤ ØªØµØ¯ÙŠØ±</button>
  </div>
</header>

<div class="nav-tabs">
  <div class="nav-tab active" onclick="showTab('dashboard')">ğŸ“Š Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</div>
  <div class="nav-tab" onclick="showTab('income')">ğŸ’° Ø§Ù„Ø¯Ø®Ù„</div>
  <div class="nav-tab" onclick="showTab('expenses')">ğŸ’¸ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
  <div class="nav-tab" onclick="showTab('goals')">ğŸ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</div>
  <div class="nav-tab" onclick="showTab('annual')">ğŸ“… Ø³Ù†ÙˆÙŠ</div>
  <div class="nav-tab" onclick="showTab('settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
</div>

<main>

<!-- â•â• DASHBOARD â•â• -->
<div id="tab-dashboard" class="section active">
  <div class="sec-title">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</div>
  <div id="alertBanner" class="alert-banner"></div>

  <!-- AI Tips -->
  <div id="ai-section" class="ai-card" style="display:none">
    <div style="font-size:13px;font-weight:900;color:#8b5cf6;margin-bottom:8px">ğŸ¤– ØªÙˆØµÙŠØ§Øª Ø°ÙƒÙŠØ©</div>
    <div id="ai-tips"></div>
  </div>

  <div class="cards-grid">
    <div class="card green"><div class="card-label">Ø§Ù„ØµØ§Ù„ÙŠØ±</div><div class="card-value green" id="d-salary">-</div></div>
    <div class="card gold"><div class="card-label">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ„ÙŠ</div><div class="card-value gold" id="d-income">-</div><div class="card-sub" id="d-bonus-sub"></div></div>
    <div class="card red"><div class="card-label">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div><div class="card-value red" id="d-exp">-</div><div class="card-trend" id="d-exp-trend"></div></div>
    <div class="card blue"><div class="card-label">Ø§Ù„Ø¨Ø§Ù‚ÙŠ</div><div class="card-value blue" id="d-rem">-</div></div>
    <div class="card purple"><div class="card-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</div><div class="card-value purple" id="d-pct">-</div></div>
    <div class="card green" style="cursor:pointer" onclick="showTab('goals')">
      <div class="card-label">Ø§Ù„ØµØ­Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="health-ring" style="width:54px;height:54px">
          <svg width="54" height="54" viewBox="0 0 54 54">
            <circle cx="27" cy="27" r="22" fill="none" stroke="var(--bg4)" stroke-width="5"/>
            <circle id="health-arc" cx="27" cy="27" r="22" fill="none" stroke="var(--green)" stroke-width="5"
              stroke-dasharray="138.2" stroke-dashoffset="138.2" stroke-linecap="round" style="transition:stroke-dashoffset 1s ease"/>
          </svg>
          <div class="health-ring-text"><span class="health-score-num" id="health-num">-</span></div>
        </div>
        <div style="font-size:11px;color:var(--text2)" id="health-lbl">Ø¬Ø§Ø±ÙŠ...</div>
      </div>
    </div>
  </div>

  <div class="grid-2">
    <div class="panel">
      <div class="panel-header">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <div class="panel-body"><div class="chart-wrap"><canvas id="chartPie"></canvas></div></div>
    </div>
    <div class="panel">
      <div class="panel-header">ğŸ“‰ ØªÙØµÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª</div>
      <div class="panel-body" id="exp-breakdown"><div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    </div>
  </div>
  <div class="panel">
    <div class="panel-header">ğŸ’³ Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
    <div class="panel-body" style="overflow-x:auto">
      <table class="tbl"><thead><tr><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
      <tbody id="recent-ops"><tr><td colspan="4" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody></table>
    </div>
  </div>
</div>

<!-- â•â• INCOME â•â• -->
<div id="tab-income" class="section">
  <div class="sec-title">ğŸ’° Ø§Ù„Ø¯Ø®Ù„</div>
  <div class="panel">
    <div class="panel-header">Ø§Ù„ØµØ§Ù„ÙŠØ± ÙˆØ§Ù„Ø¨Ø±ÙŠÙ…</div>
    <div class="panel-body">
      <div class="form-grid">
        <div><label class="lbl">ğŸ¦ Ø§Ù„ØµØ§Ù„ÙŠØ± (Ø¯Ø±Ù‡Ù…)</label><input class="inp" type="number" id="in-salary" oninput="saveIncome()" placeholder="Ù…Ø«Ø§Ù„: 6000"/></div>
        <div><label class="lbl">ğŸ Ø¨Ø±ÙŠÙ… Ø´Ù‡Ø±ÙŠÙ†</label><input class="inp" type="number" id="in-b2" oninput="saveIncome()" placeholder="Ù…Ø«Ø§Ù„: 12000"/></div>
        <div><label class="lbl">ğŸŠ Ø¨Ø±ÙŠÙ… 6 Ø£Ø´Ù‡Ø±</label><input class="inp" type="number" id="in-b6" oninput="saveIncome()" placeholder="Ù…Ø«Ø§Ù„: 36000"/></div>
        <div><label class="lbl">ğŸŒ ÙŠÙˆÙ… Ø¹Ø§Ù„Ù…ÙŠ</label><input class="inp" type="number" id="in-intl" oninput="saveIncome()" placeholder="Ù…Ø«Ø§Ù„: 3000"/></div>
        <div><label class="lbl">â• Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ</label><input class="inp" type="number" id="in-extra" oninput="saveIncome()" placeholder="Ù…Ø«Ø§Ù„: 1500"/></div>
        <div><label class="lbl">Ø¨Ø±ÙŠÙ… Ø´Ù‡Ø±ÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ</label><select class="inp" id="in-b2a" onchange="saveIncome()"><option value="false">Ù„Ø§</option><option value="true">Ù†Ø¹Ù…</option></select></div>
        <div><label class="lbl">Ø¨Ø±ÙŠÙ… 6 Ø£Ø´Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ</label><select class="inp" id="in-b6a" onchange="saveIncome()"><option value="false">Ù„Ø§</option><option value="true">Ù†Ø¹Ù…</option></select></div>
        <div><label class="lbl">ÙŠÙˆÙ… Ø¹Ø§Ù„Ù…ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ</label><select class="inp" id="in-ia" onchange="saveIncome()"><option value="false">Ù„Ø§</option><option value="true">Ù†Ø¹Ù…</option></select></div>
      </div>
    </div>
  </div>
  <div class="cards-grid">
    <div class="card green"><div class="card-label">Ø§Ù„ØµØ§Ù„ÙŠØ±</div><div class="card-value green" id="is-sal">-</div></div>
    <div class="card gold"><div class="card-label">Ø§Ù„Ø¨Ø±ÙŠÙ…</div><div class="card-value gold" id="is-bon">-</div></div>
    <div class="card blue"><div class="card-label">Ø¥Ø¶Ø§ÙÙŠ</div><div class="card-value blue" id="is-ext">-</div></div>
    <div class="card purple"><div class="card-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div><div class="card-value purple" id="is-tot">-</div></div>
  </div>
</div>

<!-- â•â• EXPENSES â•â• -->
<div id="tab-expenses" class="section">
  <div class="sec-title">ğŸ’¸ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
  <div class="panel">
    <div class="panel-header">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</div>
    <div class="panel-body">
      <div class="form-grid">
        <div><label class="lbl">ğŸ“‚ Ø§Ù„ÙØ¦Ø©</label>
          <select class="inp" id="exp-cat">
            <option>ÙƒØ±Ø§Ø¡</option><option>Ù…Ø§Ø¡ ÙˆÙƒÙ‡Ø±Ø¨Ø§Ø¡</option><option>ÙˆØ§ÙŠ ÙØ§ÙŠ</option>
            <option>ØªØ±Ù†Ø³Ø¨ÙˆØ±</option><option>ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</option><option>Ù…Ø§ÙƒÙ„Ø©</option>
            <option>ØªØ±ÙÙŠÙ‡</option><option>ØµØ­Ø©</option><option>Ù…Ù„Ø§Ø¨Ø³</option>
            <option>Ø§Ø¯Ø®Ø§Ø±</option><option>Ø£Ø®Ø±Ù‰</option>
          </select></div>
        <div><label class="lbl">ğŸ“ Ø§Ù„ÙˆØµÙ</label><input class="inp" type="text" id="exp-desc" placeholder="ÙˆØµÙ Ù‚ØµÙŠØ±"/></div>
        <div><label class="lbl">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯Ø±Ù‡Ù…)</label><input class="inp" type="number" id="exp-amt" placeholder="Ù…Ø«Ø§Ù„: 500"/></div>
        <div><label class="lbl">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input class="inp" type="date" id="exp-date"/></div>
      </div>
      <button class="action-btn green" onclick="addExpense()">â• Ø¥Ø¶Ø§ÙØ©</button>
    </div>
  </div>
  <div class="panel">
    <div class="panel-header">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
      <button class="action-btn red" onclick="clearMonthExpenses()" style="font-size:11px;padding:5px 10px">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø´Ù‡Ø±</button>
    </div>
    <div class="panel-body" style="overflow-x:auto">
      <table class="tbl">
        <thead><tr><th>#</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø­Ø°Ù</th></tr></thead>
        <tbody id="exp-list"><tr><td colspan="6" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
        <tfoot><tr><td colspan="3" style="padding:10px;font-weight:700">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
        <td colspan="3" style="padding:10px;font-weight:900;color:var(--red)" id="exp-total-foot">-</td></tr></tfoot>
      </table>
    </div>
  </div>
</div>

<!-- â•â• GOALS â•â• -->
<div id="tab-goals" class="section">
  <div class="sec-title">ğŸ¯ Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</div>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­ -->
  <div id="saving-banner" style="background:linear-gradient(135deg,rgba(0,184,148,.12),rgba(74,144,217,.1));border:1px solid rgba(0,184,148,.3);border-radius:14px;padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
    <div>
      <div style="font-size:11px;color:var(--text2);font-weight:700;text-transform:uppercase;letter-spacing:.5px">ğŸ’° Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
      <div style="font-size:26px;font-weight:900;color:var(--green)" id="avail-saving">-</div>
      <div style="font-size:11px;color:var(--text2)" id="saving-allocated">-</div>
    </div>
    <button class="action-btn green" onclick="openAllocModal()" id="alloc-btn">âš¡ ÙˆØ²Ù‘Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</button>
  </div>

  <!-- Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù -->
  <div class="panel">
    <div class="panel-header">â• Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯</div>
    <div class="panel-body">
      <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹ -->
      <div style="margin-bottom:14px">
        <label class="lbl">ğŸ¨ Ù†ÙˆØ¹ Ø§Ù„Ù‡Ø¯Ù</label>
        <div class="goal-type-grid" id="goal-type-picker">
          <div class="goal-type-btn selected" data-type="ğŸš—" data-label="Ø³ÙŠØ§Ø±Ø©" onclick="selectGoalType(this)"><span class="type-icon">ğŸš—</span>Ø³ÙŠØ§Ø±Ø©</div>
          <div class="goal-type-btn" data-type="ğŸ " data-label="Ø´Ù‚Ø©" onclick="selectGoalType(this)"><span class="type-icon">ğŸ </span>Ø´Ù‚Ø©</div>
          <div class="goal-type-btn" data-type="âœˆï¸" data-label="Ø³ÙØ±" onclick="selectGoalType(this)"><span class="type-icon">âœˆï¸</span>Ø³ÙØ±</div>
          <div class="goal-type-btn" data-type="ğŸ“" data-label="ØªØ¹Ù„ÙŠÙ…" onclick="selectGoalType(this)"><span class="type-icon">ğŸ“</span>ØªØ¹Ù„ÙŠÙ…</div>
          <div class="goal-type-btn" data-type="ğŸ’" data-label="Ø²ÙˆØ§Ø¬" onclick="selectGoalType(this)"><span class="type-icon">ğŸ’</span>Ø²ÙˆØ§Ø¬</div>
          <div class="goal-type-btn" data-type="ğŸ“±" data-label="ØªÙ‚Ù†ÙŠØ©" onclick="selectGoalType(this)"><span class="type-icon">ğŸ“±</span>ØªÙ‚Ù†ÙŠØ©</div>
          <div class="goal-type-btn" data-type="ğŸ¥" data-label="ØµØ­Ø©" onclick="selectGoalType(this)"><span class="type-icon">ğŸ¥</span>ØµØ­Ø©</div>
          <div class="goal-type-btn" data-type="â­" data-label="Ø£Ø®Ø±Ù‰" onclick="selectGoalType(this)"><span class="type-icon">â­</span>Ø£Ø®Ø±Ù‰</div>
        </div>
      </div>
      <div class="form-grid">
        <div><label class="lbl">ğŸ·ï¸ Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù</label><input class="inp" type="text" id="g-name" placeholder="Ù…Ø«Ø§Ù„: Ø³ÙŠØ§Ø±Ø© Dream..."/></div>
        <div><label class="lbl">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø¯Ø±Ù‡Ù…)</label><input class="inp" type="number" id="g-amt" placeholder="Ù…Ø«Ø§Ù„: 80000" oninput="updateGoalPreview()"/></div>
<input type="hidden" id="g-saved" value="0"/>
      </div>

      <!-- Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© -->
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div>
            <div class="lbl" style="margin:0">ğŸ“Š ÙƒÙ… % Ù…Ù† Ø§Ø¯Ø®Ø§Ø±Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø¯ÙØŸ</div>
            <div style="font-size:11px;color:var(--text2);margin-top:2px">Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­: <b style="color:var(--green)" id="g-avail-lbl">-</b></div>
          </div>
          <span style="font-size:28px;font-weight:900;color:var(--green)" id="g-pct-display">50%</span>
        </div>
        <input type="range" class="alloc-slider" min="5" max="100" step="5" value="50" id="g-pct" oninput="updateGoalPreview()"/>
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text2);margin-top:2px">
          <span>5%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span>
        </div>

        <!-- Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ -->
        <div id="goal-preview" style="display:none;margin-top:14px;background:var(--bg4);border-radius:10px;padding:14px">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center">
            <div style="background:rgba(0,184,148,.1);border-radius:8px;padding:10px">
              <div style="font-size:10px;color:var(--text2);font-weight:700;margin-bottom:4px">ğŸ’° Ø´Ù‡Ø±ÙŠØ§Ù‹</div>
              <div style="font-size:15px;font-weight:900;color:var(--green)" id="prev-monthly">-</div>
            </div>
            <div style="background:rgba(253,203,110,.1);border-radius:8px;padding:10px">
              <div style="font-size:10px;color:var(--text2);font-weight:700;margin-bottom:4px">ğŸ“… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±</div>
              <div style="font-size:15px;font-weight:900;color:var(--gold)" id="prev-months">-</div>
            </div>
            <div style="background:rgba(74,144,217,.1);border-radius:8px;padding:10px">
              <div style="font-size:10px;color:var(--text2);font-weight:700;margin-bottom:4px">ğŸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
              <div style="font-size:12px;font-weight:900;color:var(--blue)" id="prev-date">-</div>
            </div>
          </div>
          <div style="text-align:center;margin-top:10px;font-size:12px;color:var(--text2)" id="prev-remaining-lbl"></div>
        </div>
      </div>

      <input type="hidden" id="g-months" value="0"/>
      <button class="action-btn green" onclick="addGoal()">ğŸ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø¯Ù</button>
    </div>
  </div>

  <div id="goals-list"><div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
</div>

<!-- â•â• ANNUAL â•â• -->
<div id="tab-annual" class="section">
  <div class="sec-title">ğŸ“… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ</div>
  <div class="cards-grid" id="annual-cards"></div>
  <div class="grid-2">
    <div class="panel"><div class="panel-header">ğŸ“ˆ Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
      <div class="panel-body"><div class="chart-wrap"><canvas id="chartBar"></canvas></div></div></div>
    <div class="panel"><div class="panel-header">ğŸ’° ØªØ·ÙˆØ± Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</div>
      <div class="panel-body"><div class="chart-wrap"><canvas id="chartLine"></canvas></div></div></div>
  </div>
  <div class="panel"><div class="panel-header">ğŸ“Š Ø´Ù‡Ø± Ø¨Ø´Ù‡Ø±</div>
    <div class="panel-body" style="overflow-x:auto"><table class="tbl" id="annual-tbl"></table></div></div>
</div>

<!-- â•â• SETTINGS â•â• -->
<div id="tab-settings" class="section">
  <div class="sec-title">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
  <div class="panel" style="margin-bottom:14px">
    <div class="panel-header">ğŸ”” Ø­Ø¯ÙˆØ¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</div>
    <div class="panel-body">
      <div class="form-grid">
        <div><label class="lbl">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø£Ù‚Ù„ Ù…Ù†</label><input class="inp" type="number" id="s-warn" oninput="saveSettings()" placeholder="1000"/></div>
        <div><label class="lbl">ğŸš¨ Ø®Ø·Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø£Ù‚Ù„ Ù…Ù†</label><input class="inp" type="number" id="s-danger" oninput="saveSettings()" placeholder="500"/></div>
      </div>
    </div>
  </div>
  <div class="panel">
    <div class="panel-header">ğŸ“‹ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù„ÙƒÙ„ ÙØ¦Ø©</div>
    <div class="panel-body" id="budget-limits"></div>
  </div>
</div>

</main>

<!-- â•â• ALLOCATION MODAL â•â• -->
<div class="modal-overlay" id="allocModal">
  <div class="modal-box">
    <div class="modal-header">
      <span>âš¡ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</span>
      <button class="modal-close" onclick="closeAllocModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="background:var(--bg3);border-radius:10px;padding:12px;margin-bottom:16px;text-align:center">
        <div style="font-size:11px;color:var(--text2);font-weight:700">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­</div>
        <div style="font-size:22px;font-weight:900;color:var(--green)" id="modal-total-saving">-</div>
      </div>
      <div id="alloc-rows"></div>
      <div class="alloc-total-bar">
        <div style="font-size:11px;color:var(--text2);font-weight:700;margin-bottom:6px">ğŸ“Š Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…ÙˆØ²Ø¹Ø©</div>
        <div style="font-size:28px;font-weight:900" id="alloc-pct-total">0%</div>
        <div class="prog-bar" style="margin-top:8px;height:10px">
          <div class="prog-fill" id="alloc-prog" style="width:0%;background:var(--green)"></div>
        </div>
        <div style="font-size:12px;color:var(--text2);margin-top:6px" id="alloc-remaining-lbl"></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:16px">
        <button class="action-btn green" style="flex:1;justify-content:center" onclick="applyAllocation()">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
        <button class="action-btn outline" onclick="closeAllocModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>
</div>


<script>
// â•â• Ù…Ø§Ù„ÙŠ+ Standalone â€” localStorage â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MONTHS=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆØ²','ØºØ´Øª','Ø´ØªÙ†Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙ†Ø¨Ø±','Ø¯Ø¬Ù†Ø¨Ø±'];
const CAT_COLORS=['#e17055','#fdcb6e','#00b894','#4a90d9','#8b5cf6','#fd79a8','#00cec9','#55efc4','#fab1a0','#6c5ce7','#b2bec3'];
const CATS=['ÙƒØ±Ø§Ø¡','Ù…Ø§Ø¡ ÙˆÙƒÙ‡Ø±Ø¨Ø§Ø¡','ÙˆØ§ÙŠ ÙØ§ÙŠ','ØªØ±Ù†Ø³Ø¨ÙˆØ±','ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©','Ù…Ø§ÙƒÙ„Ø©','ØªØ±ÙÙŠÙ‡','ØµØ­Ø©','Ù…Ù„Ø§Ø¨Ø³','Ø§Ø¯Ø®Ø§Ø±','Ø£Ø®Ø±Ù‰'];
const CAT_ICONS={ÙƒØ±Ø§Ø¡:'ğŸ ','Ù…Ø§Ø¡ ÙˆÙƒÙ‡Ø±Ø¨Ø§Ø¡':'ğŸ’¡','ÙˆØ§ÙŠ ÙØ§ÙŠ':'ğŸ“¶',ØªØ±Ù†Ø³Ø¨ÙˆØ±:'ğŸšŒ','ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©':'ğŸ“š',Ù…Ø§ÙƒÙ„Ø©:'ğŸ›’',ØªØ±ÙÙŠÙ‡:'ğŸ¬',ØµØ­Ø©:'ğŸ¥',Ù…Ù„Ø§Ø¨Ø³:'ğŸ‘”',Ø§Ø¯Ø®Ø§Ø±:'ğŸ’',Ø£Ø®Ø±Ù‰:'ğŸ“Œ'};
let curMonth=new Date().getMonth()+1, curYear=Math.max(2026,new Date().getFullYear());
let incomeData={}, expensesData=[], settingsData={warn_threshold:1000,danger_threshold:500,budget_limits:{}};
let goalsData=[];
let prevMonthExp=0;
let selectedGoalType='ğŸš—';
let pieChart=null,barChart=null,lineChart=null;
let saveIncomeTimer=null, saveSettingsTimer=null;
let monthlyAvgSaving=0;
let realMonthsCount=0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n){return(n||0).toLocaleString('ar-MA')+' Ø¯Ø±Ù‡Ù…';}

function animateCount(el, target, prefix='', suffix=' Ø¯Ø±Ù‡Ù…'){
  const start=0, duration=800, startTime=performance.now();
  function step(now){
    const p=Math.min((now-startTime)/duration,1);
    const ease=p<.5?2*p*p:(4-2*p)*p-1;
    const val=Math.round(start+(target-start)*ease);
    el.textContent=prefix+val.toLocaleString('ar-MA')+suffix;
    if(p<1)requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// â•â• localStorage API â€” ÙŠØ­Ø§ÙƒÙŠ Flask API â•â•
const DB={
  get(k){try{return JSON.parse(localStorage.getItem(k));}catch{return null;}},
  set(k,v){localStorage.setItem(k,JSON.stringify(v));},
  del(k){localStorage.removeItem(k);},
  keys(prefix=''){return Object.keys(localStorage).filter(k=>k.startsWith(prefix));}
};

async function api(url,method='GET',body=null){
  // income
  if(url.match(/\/api\/income\/(\d+)\/(\d+)/)){
    const[,m,y]=url.match(/\/api\/income\/(\d+)\/(\d+)/);
    const key=`income_${y}_${m}`;
    if(method==='POST'){
      const sal=body.salary||0, b2=body.bonus2_active?body.bonus2:0,
            b6=body.bonus6_active?body.bonus6:0, bi=body.intl_active?body.bonus_intl:0;
      const total=sal+b2+b6+bi+(body.extra||0);
      const rec={...body,total};
      DB.set(key,rec); return rec;
    }
    return DB.get(key)||{};
  }
  // expenses list
  if(url.match(/\/api\/expenses\/(\d+)\/(\d+)/) && method==='GET'){
    const[,m,y]=url.match(/\/api\/expenses\/(\d+)\/(\d+)/);
    return DB.get(`expenses_${y}_${m}`)||[];
  }
  // add expense
  if(url==='/api/expenses' && method==='POST'){
    const[,m,y]=[null,...body.date.split('-')];
    const key=`expenses_${y}_${parseInt(m)}`;
    const list=DB.get(key)||[];
    const rec={...body,id:Date.now()};
    list.push(rec); DB.set(key,list); return rec;
  }
  // delete expense
  if(url.match(/\/api\/expenses\/(\d+)/) && method==='DELETE'){
    const id=parseInt(url.split('/').pop());
    DB.keys('expenses_').forEach(k=>{
      const list=(DB.get(k)||[]).filter(e=>e.id!==id);
      DB.set(k,list);
    }); return {};
  }
  // goals
  if(url==='/api/goals' && method==='GET') return DB.get('goals')||[];
  if(url==='/api/goals' && method==='POST'){
    const list=DB.get('goals')||[];
    const rec={...body,id:Date.now(),progress_pct:Math.round((body.saved_amount/body.target_amount)*100),monthly_needed:body.target_amount>body.saved_amount?Math.ceil((body.target_amount-body.saved_amount)/body.months):0};
    list.push(rec); DB.set('goals',list); return rec;
  }
  if(url.match(/\/api\/goals\/(\d+)/) && method==='PUT'){
    const id=parseInt(url.split('/').pop());
    const list=DB.get('goals')||[];
    const idx=list.findIndex(g=>g.id===id);
    if(idx>-1){
      list[idx]={...list[idx],...body,
        progress_pct:Math.round((body.saved_amount/list[idx].target_amount)*100),
        monthly_needed:list[idx].target_amount>body.saved_amount?Math.ceil((list[idx].target_amount-body.saved_amount)/list[idx].months):0
      };
      DB.set('goals',list);
    } return list[idx]||{};
  }
  if(url.match(/\/api\/goals\/(\d+)/) && method==='DELETE'){
    const id=parseInt(url.split('/').pop());
    DB.set('goals',(DB.get('goals')||[]).filter(g=>g.id!==id)); return {};
  }
  // settings
  if(url==='/api/settings' && method==='GET') return DB.get('settings')||{warn_threshold:1000,danger_threshold:500,budget_limits:{}};
  if(url==='/api/settings' && method==='POST'){DB.set('settings',body);return body;}
  // annual
  if(url.match(/\/api\/annual\/(\d+)/)){
    const[,y]=url.match(/\/api\/annual\/(\d+)/);
    return Array.from({length:12},(_,i)=>{
      const m=i+1;
      const inc=DB.get(`income_${y}_${m}`)||{};
      const exps=DB.get(`expenses_${y}_${m}`)||[];
      const expenses=exps.reduce((s,e)=>s+e.amount,0);
      const income=inc.total||0;
      return{month:m,income,expenses,remaining:income-expenses};
    });
  }
  // logout
  if(url==='/api/logout') return {};
  // export
  if(url.match(/\/api\/export/)) return null;
  console.warn('API not handled:',url); return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('selMonth').value=curMonth;
  document.getElementById('selYear').value=curYear;
  document.getElementById('exp-date').value=new Date().toISOString().split('T')[0];
  loadAll();
  buildBudgetLimits();
});

function changeMonth(){
  curMonth=parseInt(document.getElementById('selMonth').value);
  curYear=parseInt(document.getElementById('selYear').value);
  loadAll();
}

async function loadAll(){
  const prevM=curMonth===1?12:curMonth-1;
  const prevY=curMonth===1?curYear-1:curYear;
  const [,,prevExps]=await Promise.all([
    loadIncome(), loadExpenses(), api(`/api/expenses/${prevM}/${prevY}`), loadSettings()
  ]);
  prevMonthExp=((prevExps)||[]).reduce((s,e)=>s+e.amount,0);
  try{await refreshAnnualAvg();}catch(e){}
  renderDashboard();
  updateGoalPreview();
}

async function refreshAnnualAvg(){
  let allMonths=[];
  for(let y=2026;y<=curYear;y++){
    const data=await api(`/api/annual/${y}`)||[];
    data.filter(d=>d.income>0).forEach(d=>allMonths.push(d));
  }
  realMonthsCount=allMonths.length||1;
  const totalNet=allMonths.reduce((s,d)=>s+(d.income-d.expenses),0);
  monthlyAvgSaving=Math.round(totalNet/realMonthsCount);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INCOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadIncome(){
  incomeData=await api(`/api/income/${curMonth}/${curYear}`)||{};
  document.getElementById('in-salary').value=incomeData.salary||'';
  document.getElementById('in-b2').value=incomeData.bonus2||'';
  document.getElementById('in-b6').value=incomeData.bonus6||'';
  document.getElementById('in-intl').value=incomeData.bonus_intl||'';
  document.getElementById('in-extra').value=incomeData.extra||'';
  document.getElementById('in-b2a').value=incomeData.bonus2_active?'true':'false';
  document.getElementById('in-b6a').value=incomeData.bonus6_active?'true':'false';
  document.getElementById('in-ia').value=incomeData.intl_active?'true':'false';
}

function saveIncome(){
  clearTimeout(saveIncomeTimer);
  saveIncomeTimer=setTimeout(async()=>{
    const body={
      salary:parseFloat(document.getElementById('in-salary').value)||0,
      bonus2:parseFloat(document.getElementById('in-b2').value)||0,
      bonus6:parseFloat(document.getElementById('in-b6').value)||0,
      bonus_intl:parseFloat(document.getElementById('in-intl').value)||0,
      extra:parseFloat(document.getElementById('in-extra').value)||0,
      bonus2_active:document.getElementById('in-b2a').value==='true',
      bonus6_active:document.getElementById('in-b6a').value==='true',
      intl_active:document.getElementById('in-ia').value==='true'
    };
    incomeData=await api(`/api/income/${curMonth}/${curYear}`,'POST',body)||incomeData;
    renderIncomeSummary(); renderDashboard();
  },600);
}

function renderIncomeSummary(){
  const inc=incomeData;
  const bonus=(inc.bonus2_active?inc.bonus2:0)+(inc.bonus6_active?inc.bonus6:0)+(inc.intl_active?inc.bonus_intl:0);
  document.getElementById('is-sal').textContent=fmt(inc.salary);
  document.getElementById('is-bon').textContent=fmt(bonus);
  document.getElementById('is-ext').textContent=fmt(inc.extra);
  document.getElementById('is-tot').textContent=fmt(inc.total);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPENSES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadExpenses(){
  expensesData=await api(`/api/expenses/${curMonth}/${curYear}`)||[];
  renderExpenses();
}

function renderExpenses(){
  const tbody=document.getElementById('exp-list');
  if(!expensesData.length){
    tbody.innerHTML='<tr><td colspan="6" class="loading">Ù…Ø§ ÙƒØ§ÙŠÙ† Ù…ØµØ§Ø±ÙŠÙ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</td></tr>';
    document.getElementById('exp-total-foot').textContent='0 Ø¯Ø±Ù‡Ù…';return;
  }
  const total=expensesData.reduce((s,e)=>s+e.amount,0);
  tbody.innerHTML=expensesData.map((e,i)=>`
    <tr><td style="color:var(--text2)">${i+1}</td>
    <td><span class="tag">${CAT_ICONS[e.category]||''} ${e.category}</span></td>
    <td>${e.description||'-'}</td>
    <td style="color:var(--red);font-weight:700">${fmt(e.amount)}</td>
    <td style="color:var(--text2)">${e.date}</td>
    <td><button class="action-btn red" style="padding:4px 8px;font-size:11px" onclick="delExpense(${e.id})">ğŸ—‘ï¸</button></td>
    </tr>`).join('');
  document.getElementById('exp-total-foot').textContent=fmt(total);
}

async function addExpense(){
  const amt=parseFloat(document.getElementById('exp-amt').value);
  if(!amt){alert('Ø®Ø§ØµÙƒ ØªØ¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº!');return;}
  await api('/api/expenses','POST',{
    category:document.getElementById('exp-cat').value,
    description:document.getElementById('exp-desc').value,
    amount:amt,date:document.getElementById('exp-date').value
  });
  document.getElementById('exp-amt').value='';
  document.getElementById('exp-desc').value='';
  await loadExpenses(); renderDashboard();
}

async function delExpense(id){
  await api(`/api/expenses/${id}`,'DELETE');
  await loadExpenses(); renderDashboard();
}

async function clearMonthExpenses(){
  if(!confirm('ØªÙ…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ù…ØµØ§Ø±ÙŠÙ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ'))return;
  for(const e of expensesData)await api(`/api/expenses/${e.id}`,'DELETE');
  await loadExpenses(); renderDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSettings(){
  settingsData=await api('/api/settings')||settingsData;
  document.getElementById('s-warn').value=settingsData.warn_threshold||1000;
  document.getElementById('s-danger').value=settingsData.danger_threshold||500;
}

function saveSettings(){
  clearTimeout(saveSettingsTimer);
  saveSettingsTimer=setTimeout(async()=>{
    settingsData=await api('/api/settings','POST',{
      warn_threshold:parseFloat(document.getElementById('s-warn').value)||1000,
      danger_threshold:parseFloat(document.getElementById('s-danger').value)||500,
      budget_limits:settingsData.budget_limits||{}
    })||settingsData;
    renderDashboard();
  },600);
}

function buildBudgetLimits(){
  document.getElementById('budget-limits').innerHTML=CATS.map(cat=>`
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
      <span>${CAT_ICONS[cat]||''} ${cat}</span>
      <div style="display:flex;align-items:center;gap:6px">
        <input type="number" placeholder="Ù„Ø§ Ø­Ø¯" class="inp" style="width:120px;text-align:center"
          id="bl-${cat.replace(/ /g,'_')}" onchange="updateBudgetLimit('${cat}',this.value)"/>
        <span style="font-size:11px;color:var(--text2)">Ø¯Ø±Ù‡Ù…</span>
      </div>
    </div>`).join('');
}

async function updateBudgetLimit(cat,val){
  if(!settingsData.budget_limits)settingsData.budget_limits={};
  settingsData.budget_limits[cat]=parseFloat(val)||0;
  settingsData=await api('/api/settings','POST',{budget_limits:settingsData.budget_limits,...settingsData})||settingsData;
  renderDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectGoalType(el){
  document.querySelectorAll('.goal-type-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
  selectedGoalType=el.dataset.type;
  const lbl=el.dataset.label;
  const nameInp=document.getElementById('g-name');
  if(!nameInp.value||Object.values({Ø³ÙŠØ§Ø±Ø©:'ğŸš—',Ø´Ù‚Ø©:'ğŸ ',Ø³ÙØ±:'âœˆï¸',ØªØ¹Ù„ÙŠÙ…:'ğŸ“',Ø²ÙˆØ§Ø¬:'ğŸ’',ØªÙ‚Ù†ÙŠØ©:'ğŸ“±',ØµØ­Ø©:'ğŸ¥',Ø£Ø®Ø±Ù‰:'â­'}).includes(nameInp.value)){
    nameInp.value=lbl;
  }
}

async function loadGoals(){
  goalsData=await api('/api/goals')||[];
  renderGoals();
  updateSavingBanner();
}

function renderGoals(){
  const container=document.getElementById('goals-list');
  if(!goalsData.length){container.innerHTML='<div class="panel"><div class="panel-body loading">Ù…Ø§ ÙƒØ§ÙŠÙ† Ø£Ù‡Ø¯Ø§Ù â€” Ø²ÙŠØ¯ Ù‡Ø¯Ù Ø£ÙˆÙ„ Ø´ÙŠ! ğŸ¯</div></div>';return;}
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const avail=Math.max(0,inc-totalExp);

  container.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px">${goalsData.map(g=>{
    const c=g.progress_pct>=100?'var(--green)':g.progress_pct>50?'var(--gold)':'var(--blue)';
    const remaining=g.target_amount-g.saved_amount;
    const etaMonths=g.monthly_needed>0?Math.ceil(remaining/g.monthly_needed):0;
    const etaDate=new Date();etaDate.setMonth(etaDate.getMonth()+etaMonths);
    const etaStr=etaMonths>0?`${MONTHS[etaDate.getMonth()]} ${etaDate.getFullYear()}`:'ÙˆØµÙ„Øª Ù„Ù„Ù‡Ø¯Ù!';
    const icon=g.name.includes('Ø³ÙŠØ§Ø±Ø©')||g.name.includes('car')?'ğŸš—':
                g.name.includes('Ø´Ù‚Ø©')||g.name.includes('Ù…Ù†Ø²Ù„')||g.name.includes('Ø¨ÙŠØª')?'ğŸ ':
                g.name.includes('Ø³ÙØ±')||g.name.includes('Ø±Ø­Ù„Ø©')?'âœˆï¸':
                g.name.includes('ØªØ¹Ù„ÙŠÙ…')||g.name.includes('Ø¯Ø±Ø§Ø³Ø©')?'ğŸ“':
                g.name.includes('Ø²ÙˆØ§Ø¬')||g.name.includes('Ø®Ø·ÙˆØ¨Ø©')?'ğŸ’':
                g.name.includes('Ù‡Ø§ØªÙ')||g.name.includes('Ù„Ø§Ø¨ØªÙˆØ¨')||g.name.includes('ØªÙ„ÙÙˆÙ†')?'ğŸ“±':'â­';
    return`<div class="goal-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div style="font-size:38px;line-height:1">${icon}</div>
        <button class="action-btn red" style="padding:4px 8px;font-size:11px" onclick="delGoal(${g.id})">ğŸ—‘ï¸</button>
      </div>
      <div style="font-size:15px;font-weight:900;margin:8px 0 4px">${g.name}</div>
      <div style="font-size:11px;color:var(--text2);margin-bottom:10px">ğŸ“… ${g.months} Ø´Ù‡Ø± Â· ğŸ ${etaStr}</div>
      <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:8px">
        <span>ØªÙ…: <b style="color:var(--green)">${fmt(g.saved_amount)}</b></span>
        <span>Ø§Ù„Ù‡Ø¯Ù: <b style="color:var(--gold)">${fmt(g.target_amount)}</b></span>
      </div>
      <div class="prog-bar" style="height:10px;margin-bottom:4px">
        <div class="prog-fill" style="width:${g.progress_pct}%;background:${c}"></div>
      </div>
      <div style="text-align:center;font-size:11px;color:var(--text2);margin-bottom:8px">${g.progress_pct}% Ù…ÙƒÙ…Ù„</div>
      ${g.monthly_needed>0
        ?`<div style="background:rgba(0,184,148,.1);color:var(--green);text-align:center;font-size:12px;font-weight:700;padding:7px;border-radius:8px">ğŸ’° ${fmt(g.monthly_needed)} / Ø´Ù‡Ø±</div>`
        :`<div style="background:rgba(0,184,148,.2);color:var(--green);text-align:center;font-size:12px;padding:7px;border-radius:8px">âœ… ÙˆØµÙ„Øª Ù„Ù„Ù‡Ø¯Ù!</div>`}
      <button class="action-btn outline" style="width:100%;margin-top:8px;justify-content:center;font-size:12px" onclick="quickDeposit(${g.id},'${g.name}',${g.saved_amount})">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø¯Ø®Ø§Ø±</button>
    </div>`;
  }).join('')}</div>`;

  // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù€ progress bars Ø¨Ø´ÙƒÙ„ Ù…ØªØ­Ø±Ùƒ
  setTimeout(()=>{
    document.querySelectorAll('.prog-fill').forEach(bar=>{
      const target=bar.style.width;
      bar.style.width='0%';
      setTimeout(()=>{bar.style.width=target;},100);
    });
  },50);
}

async function quickDeposit(id, name, currentSaved){
  const amount=prompt(`ğŸ’° ÙƒÙ… ØªØ¨ØºÙŠ ØªØ¶ÙŠÙ Ù„Ù„Ù‡Ø¯Ù "${name}"ØŸ (Ø¯Ø±Ù‡Ù…)\nØ§Ù„Ù…Ø¯Ø®Ø± Ø­Ø§Ù„ÙŠØ§Ù‹: ${currentSaved.toLocaleString()} Ø¯Ø±Ù‡Ù…`);
  if(!amount||isNaN(amount)||parseFloat(amount)<=0)return;
  const newSaved=currentSaved+parseFloat(amount);
  await api(`/api/goals/${id}`,'PUT',{saved_amount:newSaved});
  await loadGoals();

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ù„ÙˆØº Ø§Ù„Ù‡Ø¯Ù
  const goal=goalsData.find(g=>g.id===id);
  if(goal&&newSaved>=goal.target_amount){
    launchConfetti();
    setTimeout(()=>alert(`ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ÙˆØµÙ„Øª Ù„Ù„Ù‡Ø¯Ù "${name}"! ğŸŠ`),500);
  }
}

async function addGoal(){
  const n=document.getElementById('g-name').value;
  const a=parseFloat(document.getElementById('g-amt').value);
  const pct=parseInt(document.getElementById('g-pct').value)||50;
  if(!n||!a){alert('Ø®Ø§ØµÙƒ ØªØ¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨!');return;}
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const curSaving=inc-totalExp;
  const monthlyAvg=realMonthsCount>0?monthlyAvgSaving:curSaving;
  const monthlyForGoal=Math.round(monthlyAvg*pct/100);
  const autoSaved=Math.max(0,monthlyForGoal*realMonthsCount);
  const remaining=Math.max(0,a-autoSaved);
  const m=monthlyForGoal>0?Math.ceil(remaining/monthlyForGoal):1;
  await api('/api/goals','POST',{name:n,target_amount:a,months:m,saved_amount:autoSaved});
  ['g-name','g-amt'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('g-pct').value=50;
  document.getElementById('g-pct-display').textContent='50%';
  document.getElementById('goal-preview').style.display='none';
  await loadGoals();
}

async function delGoal(id){
  if(!confirm('ØªÙ…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø¯ÙØŸ'))return;
  await api(`/api/goals/${id}`,'DELETE');
  await loadGoals();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALLOCATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateGoalPreview(){
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const curSaving=inc-totalExp;
  const monthlyAvg=realMonthsCount>0?monthlyAvgSaving:curSaving;

  const pct=parseInt(document.getElementById('g-pct').value)||50;
  const target=parseFloat(document.getElementById('g-amt').value)||0;

  document.getElementById('g-pct-display').textContent=pct+'%';
  const availLbl=document.getElementById('g-avail-lbl');
  if(availLbl) availLbl.textContent=inc>0
    ?`Ù…Ø¹Ø¯Ù„ ${fmt(monthlyAvg)}/Ø´Ù‡Ø± (${realMonthsCount} Ø´Ù‡Ø±)`
    :'Ù…Ø§ ÙƒØ§ÙŠÙ† Ø¯Ø®Ù„ â€” Ø¯Ø®Ù„ Ø§Ù„ØµØ§Ù„ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹';

  const preview=document.getElementById('goal-preview');
  if(!inc||!target){preview.style.display='none';return;}

  const monthlyForGoal=Math.round(monthlyAvg*pct/100);
  const autoSaved=Math.max(0,monthlyForGoal*realMonthsCount);
  const remaining=Math.max(0,target-autoSaved);
  const months=monthlyForGoal>0?Math.ceil(remaining/monthlyForGoal):999;
  document.getElementById('g-months').value=months;

  const etaDate=new Date(curYear,curMonth-1+months);
  const etaStr=remaining<=0?'Ø§Ù„Ø¢Ù†! ğŸ‰':`${MONTHS[etaDate.getMonth()]} ${etaDate.getFullYear()}`;

  document.getElementById('prev-monthly').textContent=fmt(monthlyForGoal);
  document.getElementById('prev-months').textContent=remaining<=0?'âœ… ÙˆØµÙ„Øª!':months+' Ø´Ù‡Ø±';
  document.getElementById('prev-date').textContent=etaStr;

  const remLbl=document.getElementById('prev-remaining-lbl');
  if(remLbl){
    remLbl.innerHTML=remaining>0
      ?`${fmt(monthlyForGoal)}/Ø´Ù‡Ø± Â· ØªÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹: <b style="color:var(--green)">${fmt(autoSaved)}</b> Â· Ø¨Ø§Ù‚ÙŠ: <b style="color:var(--gold)">${fmt(remaining)}</b>`
      :'âœ… ÙˆØµÙ„Øª Ù„Ù„Ù‡Ø¯Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹!';
  }
  preview.style.display='block';
}

function updateSavingBanner(){
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const avail=Math.max(0,inc-totalExp);
  document.getElementById('avail-saving').textContent=fmt(avail);
  const totalNeeded=goalsData.reduce((s,g)=>s+g.monthly_needed,0);
  document.getElementById('saving-allocated').textContent=goalsData.length>0
    ?`Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ØªØ­ØªØ§Ø¬ ${fmt(totalNeeded)} Ø´Ù‡Ø±ÙŠØ§Ù‹`:'Ù…Ø§ ÙƒØ§ÙŠÙ† Ø£Ù‡Ø¯Ø§Ù Ø¨Ø¹Ø¯';
}

function openAllocModal(){
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const avail=Math.max(0,inc-totalExp);
  if(avail<=0){alert('Ù…Ø§ ÙƒØ§ÙŠÙ† Ø§Ø¯Ø®Ø§Ø± Ù…ØªØ§Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±!');return;}
  if(!goalsData.length){alert('Ø²ÙŠØ¯ Ù‡Ø¯Ù Ø£ÙˆÙ„!');return;}
  document.getElementById('modal-total-saving').textContent=fmt(avail);

  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  const totalNeeded=goalsData.reduce((s,g)=>s+g.monthly_needed,0);
  const rows=document.getElementById('alloc-rows');
  rows.innerHTML=goalsData.map((g,i)=>{
    const autoPct=totalNeeded>0?Math.round((g.monthly_needed/totalNeeded)*100):Math.round(100/goalsData.length);
    const amount=Math.round(avail*autoPct/100);
    const icon=g.name.includes('Ø³ÙŠØ§Ø±Ø©')?'ğŸš—':g.name.includes('Ø´Ù‚Ø©')||g.name.includes('Ù…Ù†Ø²Ù„')?'ğŸ ':
               g.name.includes('Ø³ÙØ±')?'âœˆï¸':g.name.includes('ØªØ¹Ù„ÙŠÙ…')?'ğŸ“':g.name.includes('Ø²ÙˆØ§Ø¬')?'ğŸ’':'â­';
    return`<div class="alloc-row">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div style="display:flex;align-items:center;gap:8px;font-weight:700">
          <span style="font-size:22px">${icon}</span>
          <span>${g.name}</span>
        </div>
        <div style="text-align:left">
          <span style="font-size:18px;font-weight:900;color:var(--green)" id="alloc-pct-${g.id}">${autoPct}%</span>
          <div style="font-size:11px;color:var(--text2)" id="alloc-amt-${g.id}">${fmt(amount)}</div>
        </div>
      </div>
      <input type="range" class="alloc-slider" min="0" max="100" value="${autoPct}"
        id="alloc-slider-${g.id}" data-id="${g.id}" oninput="updateAllocSlider(${g.id},${avail})"/>
      <div style="font-size:10px;color:var(--text2);margin-top:2px">
        Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø´Ù‡Ø±ÙŠØ§Ù‹: <b style="color:var(--gold)">${fmt(g.monthly_needed)}</b>
      </div>
    </div>`;
  }).join('');
  updateAllocTotal(avail);
  document.getElementById('allocModal').classList.add('open');
}

function updateAllocSlider(id, avail){
  const pct=parseInt(document.getElementById(`alloc-slider-${id}`).value);
  const amount=Math.round(avail*pct/100);
  document.getElementById(`alloc-pct-${id}`).textContent=pct+'%';
  document.getElementById(`alloc-amt-${id}`).textContent=fmt(amount);
  updateAllocTotal(avail);
}

function updateAllocTotal(avail){
  let total=0;
  goalsData.forEach(g=>{
    const s=document.getElementById(`alloc-slider-${g.id}`);
    if(s)total+=parseInt(s.value);
  });
  const color=total>100?'var(--red)':total===100?'var(--green)':'var(--gold)';
  document.getElementById('alloc-pct-total').textContent=total+'%';
  document.getElementById('alloc-pct-total').style.color=color;
  document.getElementById('alloc-prog').style.width=Math.min(total,100)+'%';
  document.getElementById('alloc-prog').style.background=color;
  const remaining=avail*(100-total)/100;
  document.getElementById('alloc-remaining-lbl').textContent=total>100
    ?'âš ï¸ ØªØ¬Ø§ÙˆØ²Øª 100% â€” Ù†Ù‚Øµ Ù…Ù† Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù'
    :total===100?'âœ… Ù…Ù…ØªØ§Ø²! ÙƒÙ„ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ù…ÙˆØ²Ø¹'
    :`Ø¨Ø§Ù‚ÙŠ ${fmt(remaining)} Ø¨Ø¯ÙˆÙ† ØªÙˆØ²ÙŠØ¹`;
}

function closeAllocModal(){
  document.getElementById('allocModal').classList.remove('open');
}

async function applyAllocation(){
  const inc=incomeData.total||0;
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const avail=Math.max(0,inc-totalExp);
  let total=0;
  goalsData.forEach(g=>{
    const s=document.getElementById(`alloc-slider-${g.id}`);
    if(s)total+=parseInt(s.value);
  });
  if(total>100){alert('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ØªØ¬Ø§ÙˆØ² 100%! Ù†Ù‚Øµ Ù…Ù† Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù.');return;}
  if(!confirm(`ØºØ§Ø¯ÙŠ ØªØ¶ÙŠÙ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù. Ù…ØªØ£ÙƒØ¯ØŸ`))return;

  let anyCompleted=false;
  for(const g of goalsData){
    const s=document.getElementById(`alloc-slider-${g.id}`);
    if(!s)continue;
    const pct=parseInt(s.value);
    if(pct===0)continue;
    const amount=Math.round(avail*pct/100);
    const newSaved=g.saved_amount+amount;
    await api(`/api/goals/${g.id}`,'PUT',{saved_amount:newSaved});
    if(newSaved>=g.target_amount)anyCompleted=true;
  }

  closeAllocModal();
  await loadGoals();
  if(anyCompleted){launchConfetti();setTimeout(()=>alert('ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ÙˆØµÙ„Øª Ù„Ù‡Ø¯Ù!'),500);}
  else{showToast('âœ… ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù!');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI TIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateAiTips(inc, totalExp, rem){
  const tips=[];
  const pct=inc>0?Math.round((rem/inc)*100):0;
  const catMap={};
  expensesData.forEach(e=>{catMap[e.category]=(catMap[e.category]||0)+e.amount;});

  if(pct>=20)tips.push({icon:'ğŸŒŸ',text:`Ù†Ø³Ø¨Ø© Ø§Ø¯Ø®Ø§Ø±Ùƒ ${pct}% Ù…Ù…ØªØ§Ø²Ø©! Ø§Ø³ØªÙ…Ø± ÙƒØ°Ø§.`});
  else if(pct>=10)tips.push({icon:'ğŸ‘',text:`Ø§Ø¯Ø®Ø±Øª ${pct}% Ù…Ù† Ø¯Ø®Ù„Ùƒ. Ø­Ø§ÙˆÙ„ ØªÙˆØµÙ„ Ù„20%.`});
  else if(pct>0)tips.push({icon:'âš ï¸',text:`Ù†Ø³Ø¨Ø© Ø§Ø¯Ø®Ø§Ø±Ùƒ Ø¶Ø¹ÙŠÙØ© (${pct}%). Ø±Ø§Ø¬Ø¹ Ù…ØµØ§Ø±ÙŠÙÙƒ.`});

  if(prevMonthExp>0){
    const diff=totalExp-prevMonthExp;
    const diffPct=Math.abs(Math.round((diff/prevMonthExp)*100));
    if(diff>500)tips.push({icon:'ğŸ“ˆ',text:`Ù…ØµØ§Ø±ÙŠÙÙƒ Ø²Ø§Ø¯Øª ${diffPct}% Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ (+${Math.round(diff).toLocaleString()} Ø¯Ø±Ù‡Ù…).`});
    else if(diff<-500)tips.push({icon:'ğŸ“‰',text:`Ù…ØµØ§Ø±ÙŠÙÙƒ Ù†Ù‚ØµØª ${diffPct}% Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ. Ù…Ù…ØªØ§Ø²!`});
  }

  const ent=catMap['ØªØ±ÙÙŠÙ‡']||0;
  if(ent>inc*0.15)tips.push({icon:'ğŸ¬',text:`Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªØ±ÙÙŠÙ‡ (${fmt(ent)}) ØªØªØ¬Ø§ÙˆØ² 15% Ù…Ù† Ø¯Ø®Ù„Ùƒ. ÙÙƒØ± ÙÙŠÙ‡Ø§.`});
  const food=catMap['Ù…Ø§ÙƒÙ„Ø©']||0;
  if(food>inc*0.3)tips.push({icon:'ğŸ›’',text:`Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…Ø§ÙƒÙ„Ø© Ù…Ø±ØªÙØ¹Ø© (${fmt(food)}). Ø¬Ø±Ø¨ Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹.`});
  if(goalsData.length>0){
    const totalNeeded=goalsData.reduce((s,g)=>s+g.monthly_needed,0);
    if(rem<totalNeeded)tips.push({icon:'ğŸ¯',text:`Ø§Ù„Ø¨Ø§Ù‚ÙŠ (${fmt(rem)}) Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø£Ù‡Ø¯Ø§Ù (${fmt(totalNeeded)}). Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©.`});
    else tips.push({icon:'âœ…',text:`Ø§Ù„Ø¨Ø§Ù‚ÙŠ ÙƒØ§ÙÙŠ Ù„ØªÙ…ÙˆÙŠÙ„ ÙƒÙ„ Ø£Ù‡Ø¯Ø§ÙÙƒ! (${fmt(totalNeeded)} Ù…Ø·Ù„ÙˆØ¨).`});
  }

  const aiSection=document.getElementById('ai-section');
  const aiTips=document.getElementById('ai-tips');
  if(tips.length){
    aiTips.innerHTML=tips.slice(0,3).map(t=>`<div class="ai-tip"><span class="ai-tip-icon">${t.icon}</span><span>${t.text}</span></div>`).join('');
    aiSection.style.display='block';
  } else aiSection.style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HEALTH SCORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHealthScore(inc, totalExp, rem){
  let score=0;
  const savePct=inc>0?(rem/inc)*100:0;
  if(savePct>=30)score+=40;else if(savePct>=20)score+=30;else if(savePct>=10)score+=20;else if(savePct>0)score+=10;
  if(inc>0&&totalExp>0){
    const catMap={};
    expensesData.forEach(e=>{catMap[e.category]=(catMap[e.category]||0)+e.amount;});
    let overBudget=0;
    const limits=settingsData.budget_limits||{};
    Object.keys(limits).forEach(cat=>{if(limits[cat]>0&&(catMap[cat]||0)>limits[cat])overBudget++;});
    if(overBudget===0)score+=20;else if(overBudget<=1)score+=10;
  }
  if(goalsData.length>0)score+=20;else score+=5;
  if(rem>settingsData.warn_threshold)score+=20;else if(rem>settingsData.danger_threshold)score+=10;

  const el=document.getElementById('health-num');
  const arc=document.getElementById('health-arc');
  const lbl=document.getElementById('health-lbl');
  const circumference=138.2;
  const offset=circumference-(circumference*score/100);
  el.textContent=score;
  arc.style.strokeDashoffset=offset;
  arc.style.stroke=score>=70?'var(--green)':score>=40?'var(--gold)':'var(--red)';
  el.style.color=score>=70?'var(--green)':score>=40?'var(--gold)':'var(--red)';
  lbl.textContent=score>=70?'Ù…Ù…ØªØ§Ø² ğŸŒŸ':score>=40?'Ø¬ÙŠØ¯ ğŸ‘':'Ø¶Ø¹ÙŠÙ âš ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const inc=incomeData.total||0;
  const salary=incomeData.salary||0;
  const bonus=(incomeData.bonus2_active?incomeData.bonus2:0)+(incomeData.bonus6_active?incomeData.bonus6:0)+(incomeData.intl_active?incomeData.bonus_intl:0);
  const totalExp=expensesData.reduce((s,e)=>s+e.amount,0);
  const rem=inc-totalExp;
  const pct=inc>0?Math.round((rem/inc)*100):0;

  // Animated counters
  const animEl=(id,val)=>{
    const el=document.getElementById(id);
    if(el)animateCount(el,val);
  };
  animEl('d-salary',salary); animEl('d-income',inc); animEl('d-exp',totalExp); animEl('d-rem',rem);
  document.getElementById('d-pct').textContent=pct+'%';
  document.getElementById('d-bonus-sub').textContent=bonus>0?`+ Ø¨Ø±ÙŠÙ… ${fmt(bonus)}`:'Ø¨Ø¯ÙˆÙ† Ø¨Ø±ÙŠÙ…';

  // Trend
  const trend=document.getElementById('d-exp-trend');
  if(prevMonthExp>0){
    const diff=totalExp-prevMonthExp;
    const p=Math.abs(Math.round((diff/prevMonthExp)*100));
    trend.textContent=diff>0?`â–² +${p}% Ø¹Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ`:`â–¼ -${p}% Ø¹Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ`;
    trend.className='card-trend '+(diff>0?'down':'up');
  }
  renderIncomeSummary();
  updateHealthScore(inc,totalExp,rem);
  generateAiTips(inc,totalExp,rem);

  // Alert
  const banner=document.getElementById('alertBanner');
  banner.className='alert-banner';
  if(rem<=settingsData.danger_threshold&&inc>0){
    banner.className='alert-banner danger';
    banner.innerHTML=`ğŸš¨ <b>Ø®Ø·Ø±!</b> Ø§Ù„Ø¨Ø§Ù‚ÙŠ (${fmt(rem)}) Ø£Ù‚Ù„ Ù…Ù† ${fmt(settingsData.danger_threshold)}`;
  } else if(rem<=settingsData.warn_threshold&&inc>0){
    banner.className='alert-banner warning';
    banner.innerHTML=`âš ï¸ <b>ØªÙ†Ø¨ÙŠÙ‡!</b> Ø§Ù„Ø¨Ø§Ù‚ÙŠ (${fmt(rem)}) Ø£Ù‚Ù„ Ù…Ù† ${fmt(settingsData.warn_threshold)}`;
  }

  // Pie Chart
  const catMap={};
  expensesData.forEach(e=>{catMap[e.category]=(catMap[e.category]||0)+e.amount;});
  const labels=Object.keys(catMap), vals=labels.map(l=>catMap[l]);
  const colors=labels.map(l=>CAT_COLORS[CATS.indexOf(l)]||'#aaa');
  if(pieChart)pieChart.destroy();
  if(labels.length){
    pieChart=new Chart(document.getElementById('chartPie').getContext('2d'),{
      type:'doughnut',data:{labels,datasets:[{data:vals,backgroundColor:colors,borderWidth:2,borderColor:'#1a2235'}]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'right',labels:{color:'#e8eaf0',font:{family:'Cairo',size:10},padding:8}},
          tooltip:{callbacks:{label:c=>` ${c.label}: ${fmt(c.raw)}`}}}}});
  }

  // Breakdown
  const bd=document.getElementById('exp-breakdown');
  bd.innerHTML=labels.length?labels.map((l,i)=>{
    const p=totalExp>0?Math.round((catMap[l]/totalExp)*100):0;
    const lim=settingsData.budget_limits&&settingsData.budget_limits[l];
    const over=lim&&catMap[l]>lim;
    return`<div class="prog-row">
      <div class="prog-label"><span>${CAT_ICONS[l]||''} ${l} ${over?'<span class="badge badge-red">ØªØ¬Ø§ÙˆØ²</span>':''}</span>
      <span style="color:var(--text2)">${fmt(catMap[l])}</span></div>
      <div class="prog-bar"><div class="prog-fill" style="width:${p}%;background:${colors[i]}"></div></div>
    </div>`}).join(''):'<p class="loading">Ù…Ø§ ÙƒØ§ÙŠÙ† Ù…ØµØ§Ø±ÙŠÙ</p>';

  // Recent ops
  document.getElementById('recent-ops').innerHTML=
    [...expensesData].sort((a,b)=>b.id-a.id).slice(0,8).map(e=>
    `<tr><td><span class="tag">${CAT_ICONS[e.category]||''} ${e.category}</span></td>
    <td>${e.description||'-'}</td><td style="color:var(--red);font-weight:700">${fmt(e.amount)}</td>
    <td style="color:var(--text2)">${e.date}</td></tr>`).join('')
    ||'<tr><td colspan="4" class="loading">Ù…Ø§ ÙƒØ§ÙŠÙ† Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANNUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAnnual(){
  if(!goalsData.length) goalsData=await api('/api/goals')||[];
  const data=await api(`/api/annual/${curYear}`)||[];
  let totI=0,totE=0,cumS=0;
  data.forEach(d=>{totI+=d.income;totE+=d.expenses;});
  const totalGoalsSaved=goalsData.reduce((s,g)=>s+g.saved_amount,0);
  document.getElementById('annual-cards').innerHTML=`
    <div class="card green"><div class="card-label">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ</div><div class="card-value green">${fmt(totI)}</div></div>
    <div class="card red"><div class="card-label">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø³Ù†ÙˆÙŠØ©</div><div class="card-value red">${fmt(totE)}</div></div>
    <div class="card blue"><div class="card-label">Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ</div><div class="card-value blue">${fmt(Math.max(0,totI-totE))}</div></div>
    <div class="card gold"><div class="card-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ</div><div class="card-value gold">${fmt(monthlyAvgSaving)}</div><div class="card-sub">${realMonthsCount} Ø´Ù‡Ø±</div></div>`;

  if(barChart)barChart.destroy();
  barChart=new Chart(document.getElementById('chartBar').getContext('2d'),{
    type:'bar',data:{labels:MONTHS,datasets:[
      {label:'Ø§Ù„Ø¯Ø®Ù„',data:data.map(d=>d.income),backgroundColor:'rgba(0,184,148,.7)',borderRadius:5},
      {label:'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ',data:data.map(d=>d.expenses),backgroundColor:'rgba(225,112,85,.7)',borderRadius:5}
    ]},options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:'#e8eaf0',font:{family:'Cairo'}}}},
      scales:{x:{ticks:{color:'#8892a4',font:{family:'Cairo'}},grid:{color:'#2a3555'}},
              y:{ticks:{color:'#8892a4'},grid:{color:'#2a3555'}}}}});

  if(lineChart)lineChart.destroy();
  lineChart=new Chart(document.getElementById('chartLine').getContext('2d'),{
    type:'line',data:{labels:MONTHS,datasets:[{label:'Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ',
      data:data.map(d=>{cumS+=Math.max(0,d.remaining);return cumS;}),
      borderColor:'#00b894',backgroundColor:'rgba(0,184,148,.1)',fill:true,tension:.4,pointBackgroundColor:'#00b894'}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:'#e8eaf0',font:{family:'Cairo'}}}},
      scales:{x:{ticks:{color:'#8892a4',font:{family:'Cairo'}},grid:{color:'#2a3555'}},
              y:{ticks:{color:'#8892a4'},grid:{color:'#2a3555'}}}}});

  document.getElementById('annual-tbl').innerHTML=`
    <thead><tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ø¯Ø®Ù„</th><th>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</th><th>Ø§Ù„Ø¨Ø§Ù‚ÙŠ</th><th>Ù†Ø³Ø¨Ø©</th></tr></thead>
    <tbody>${data.map(d=>{const p=d.income>0?Math.round((d.remaining/d.income)*100):0;
      return`<tr><td style="font-weight:700">${MONTHS[d.month-1]}</td>
      <td style="color:var(--green)">${fmt(d.income)}</td>
      <td style="color:var(--red)">${fmt(d.expenses)}</td>
      <td style="color:${d.remaining>=0?'var(--blue)':'var(--red)'};font-weight:700">${fmt(d.remaining)}</td>
      <td><span class="badge ${p>=20?'badge-green':p>=10?'badge-gold':'badge-red'}">${p}%</span></td></tr>`;
    }).join('')}</tbody>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS=['dashboard','income','expenses','goals','annual','settings'];
function showTab(name){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  document.querySelectorAll('.nav-tab')[TABS.indexOf(name)].classList.add('active');
  if(name==='annual')loadAnnual();
  if(name==='goals'){refreshAnnualAvg().catch(()=>{}).then(()=>{updateGoalPreview();loadGoals();});}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFETTI + TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launchConfetti(){
  const colors=['#00b894','#fdcb6e','#4a90d9','#8b5cf6','#e17055','#fd79a8'];
  for(let i=0;i<60;i++){
    setTimeout(()=>{
      const el=document.createElement('div');
      el.className='confetti-piece';
      el.style.cssText=`left:${Math.random()*100}vw;background:${colors[Math.floor(Math.random()*colors.length)]};
        width:${6+Math.random()*6}px;height:${6+Math.random()*6}px;
        animation-duration:${1.5+Math.random()*2}s;animation-delay:${Math.random()*.5}s`;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(),3000);
    },i*30);
  }
}

function showToast(msg){
  const t=document.createElement('div');
  t.textContent=msg;
  t.style.cssText=`position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
    background:var(--green);color:#fff;padding:12px 24px;border-radius:50px;
    font-family:Cairo,sans-serif;font-size:14px;font-weight:700;z-index:9999;
    box-shadow:0 4px 20px rgba(0,184,148,.5);animation:fadeUp .3s ease`;
  document.body.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .3s';setTimeout(()=>t.remove(),300);},2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT + LOGOUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function expExcel(){
  const data=JSON.stringify(Object.fromEntries(Object.keys(localStorage).map(k=>[k,localStorage.getItem(k)])));
  const b=new Blob([data],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);
  a.download=`mali-plus-backup-${curYear}-${curMonth}.json`;a.click();
}
function expPDF(){window.print();}
function exportData(){expExcel();}

// Close modal on overlay click
document.getElementById('allocModal').addEventListener('click',function(e){
  if(e.target===this)closeAllocModal();
});

</script>

<div id="pwa-banner" style="display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:#00b894;color:#fff;padding:12px 24px;border-radius:50px;font-family:Cairo,sans-serif;
  font-size:14px;font-weight:700;z-index:9998;cursor:pointer;box-shadow:0 4px 20px rgba(0,184,148,0.5);
  white-space:nowrap;align-items:center;gap:10px">
  ğŸ“² Ø­Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ ØªÙ„ÙÙˆÙ†Ùƒ
</div>
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('/static/service-worker.js')
      .then(r=>console.log('SW:',r.scope)).catch(e=>console.log('SW err:',e));
  });
}
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();deferredPrompt=e;
  const b=document.getElementById('pwa-banner');b.style.display='flex';
  b.onclick=async()=>{b.style.display='none';deferredPrompt.prompt();
    await deferredPrompt.userChoice;deferredPrompt=null;};
});
window.addEventListener('appinstalled',()=>document.getElementById('pwa-banner').style.display='none');
</script>
</body>
</html>
